

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ssh &mdash; Gate One 1.1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/ansi.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="top" title="Gate One 1.1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for ssh</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#       Copyright 2011 Liftoff Software Corporation</span>
<span class="c">#</span>

<span class="c"># TODO: Complete this docstring...</span>
<span class="n">__doc__</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">ssh.py - A plugin for Gate One that adds additional SSH-specific features.</span>

<span class="s">Hooks</span>
<span class="s">-----</span>
<span class="s">This Python plugin file implements the following hooks::</span>

<span class="s">    hooks = {</span>
<span class="s">        &#39;Web&#39;: [(r&quot;/ssh&quot;, KnownHostsHandler)],</span>
<span class="s">        &#39;WebSocket&#39;: {</span>
<span class="s">            &#39;ssh_get_connect_string&#39;: get_connect_string,</span>
<span class="s">            &#39;ssh_execute_command&#39;: ws_exec_command,</span>
<span class="s">            &#39;ssh_get_identities&#39;: get_identities,</span>
<span class="s">            &#39;ssh_get_public_key&#39;: get_public_key,</span>
<span class="s">            &#39;ssh_get_private_key&#39;: get_private_key,</span>
<span class="s">            &#39;ssh_get_host_fingerprint&#39;: get_host_fingerprint,</span>
<span class="s">            &#39;ssh_gen_new_keypair&#39;: generate_new_keypair,</span>
<span class="s">            &#39;ssh_store_id_file&#39;: store_id_file,</span>
<span class="s">            &#39;ssh_delete_identity&#39;: delete_identity,</span>
<span class="s">            &#39;ssh_set_default_identities&#39;: set_default_identities</span>
<span class="s">        },</span>
<span class="s">        &#39;Escape&#39;: opt_esc_handler,</span>
<span class="s">        &#39;Auth&#39;: create_user_ssh_dir</span>
<span class="s">    }</span>

<span class="s">Docstrings</span>
<span class="s">----------</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="c"># Meta</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;1.0&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;GNU AGPLv3 or Proprietary (see LICENSE.txt)&quot;</span>
<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>

<span class="c"># Python stdlib</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c"># Our stuff</span>
<span class="kn">from</span> <span class="nn">gateone</span> <span class="kn">import</span> <span class="n">BaseHandler</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_translation</span><span class="p">,</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">shell_command</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">json_encode</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">noop</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">get_translation</span><span class="p">()</span>

<span class="c"># Tornado stuff</span>
<span class="kn">import</span> <span class="nn">tornado.web</span>
<span class="kn">import</span> <span class="nn">tornado.ioloop</span>

<span class="c"># Globals</span>
<span class="n">OPENSSH_VERSION</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">DROPBEAR_VERSION</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">PLUGIN_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># Path to this plugin&#39;s directory</span>
<span class="n">OPEN_SUBCHANNELS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">SUBCHANNEL_TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c"># How long to wait before auto-closing</span>
<span class="n">READY_STRING</span> <span class="o">=</span> <span class="s">&quot;GATEONE_SSH_EXEC_CMD_CHANNEL_READY&quot;</span>
<span class="n">READY_MATCH</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^</span><span class="si">%s</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="n">READY_STRING</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="n">OUTPUT_MATCH</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="s">&quot;^{rs}.+^{rs}$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rs</span><span class="o">=</span><span class="n">READY_STRING</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">VALID_PRIVATE_KEY</span> <span class="o">=</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="s">r&#39;^-----BEGIN [A-Z]+ PRIVATE KEY-----.*-----END [A-Z]+ PRIVATE KEY-----$&#39;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
<span class="n">TIMER</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Used to store temporary, cancellable timeouts</span>
<span class="c"># TODO: make execute_command() a user-configurable option...  So it will automatically run whatever command(s) the user likes whenever they connect to a given server.  Differentiate between when they connect and when they start up a master or slave channel.</span>
<span class="c"># TODO: Make it so that equivalent KnownHostsHandler functionality works over the WebSocket.</span>

<span class="c"># Exceptions</span>
<div class="viewcode-block" id="SSHMultiplexingException"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.SSHMultiplexingException">[docs]</a><span class="k">class</span> <span class="nc">SSHMultiplexingException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when there&#39;s a failure trying to open a sub-shell via OpenSSH&#39;s</span>
<span class="sd">    `Master mode &lt;http://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing&gt;`_</span>
<span class="sd">    multiplexing capability.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="SSHExecutionException"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.SSHExecutionException">[docs]</a><span class="k">class</span> <span class="nc">SSHExecutionException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when there&#39;s an error trying to execute a command in the slave.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="SSHKeygenException"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.SSHKeygenException">[docs]</a><span class="k">class</span> <span class="nc">SSHKeygenException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when there&#39;s an error trying to generate a public/private keypair.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="SSHKeypairException"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.SSHKeypairException">[docs]</a><span class="k">class</span> <span class="nc">SSHKeypairException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when there&#39;s an error trying to save public/private keypair or</span>
<span class="sd">    certificate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="SSHPassphraseException"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.SSHPassphraseException">[docs]</a><span class="k">class</span> <span class="nc">SSHPassphraseException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when we try to generate/decode something that requires a passphrase</span>
<span class="sd">    but no passphrase was given.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="get_ssh_dir"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.get_ssh_dir">[docs]</a><span class="k">def</span> <span class="nf">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a :class:`gateone.TerminalWebSocket` (*self*) instance, return the</span>
<span class="sd">    current user&#39;s ssh directory</span>

<span class="sd">    .. note:: If the user&#39;s ssh directory doesn&#39;t start with a . (dot) it will be renamed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
    <span class="n">users_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">)</span> <span class="c"># &quot;User&#39;s dir&quot;</span>
    <span class="n">old_ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s">&#39;ssh&#39;</span><span class="p">)</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s">&#39;.ssh&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">old_ssh_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Renaming </span><span class="si">%s</span><span class="s">&#39;s &#39;ssh&#39; directory to &#39;.ssh&#39;.&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">old_ssh_dir</span><span class="p">,</span> <span class="n">users_ssh_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Both an &#39;ssh&#39; and &#39;.ssh&#39; directory exist for user </span><span class="si">%s</span><span class="s">.  &quot;</span>
                <span class="s">&quot;Using the .ssh directory.&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">users_ssh_dir</span>
</div>
<div class="viewcode-block" id="open_sub_channel"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.open_sub_channel">[docs]</a><span class="k">def</span> <span class="nf">open_sub_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Opens a sub-channel of communication by executing a new shell on the SSH</span>
<span class="sd">    server using OpenSSH&#39;s `Master mode &lt;http://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing&gt;`_</span>
<span class="sd">    capability (it spawns a new slave) and returns the resulting</span>
<span class="sd">    :class:`termio.Multiplex` instance.  If a slave has already been opened for</span>
<span class="sd">    this purpose it will re-use the existing channel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;open_sub_channel() term: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">OPEN_SUBCHANNELS</span>
    <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">OPEN_SUBCHANNELS</span> <span class="ow">and</span> <span class="n">OPEN_SUBCHANNELS</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
        <span class="c"># Use existing sub-channel (much faster this way)</span>
        <span class="k">return</span> <span class="n">OPEN_SUBCHANNELS</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
    <span class="c"># NOTE: When connecting a slave via ssh you can&#39;t tell it to execute a</span>
    <span class="c"># command like you normally can (e.g. &#39;ssh user@host &lt;some command&gt;&#39;).  This</span>
    <span class="c"># is why we&#39;re using the termio.Multiplex.expect() functionality below...</span>
    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span>
    <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]</span>
    <span class="n">session_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SSHMultiplexingException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;SSH Plugin: Unable to open slave sub-channel.&quot;</span><span class="p">))</span>
    <span class="n">socket_path</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># Find the SSH socket path...</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">session_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ssh:</span><span class="si">%s</span><span class="s">:&#39;</span> <span class="o">%</span> <span class="n">term</span><span class="p">):</span>
            <span class="c"># Grab the SSH socket path from the file</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;SSH_SOCKET&#39;</span><span class="p">):</span>
                    <span class="c"># NOTE: This will includes quotes (which is fine):</span>
                    <span class="n">socket_path</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c"># Interesting: When using an existing socket you don&#39;t need to give it all</span>
    <span class="c"># the same options as you used to open it but you still need to give it</span>
    <span class="c"># *something* in place of the hostname or it will report a syntax error and</span>
    <span class="c"># print out the help.  So that&#39;s why I&#39;ve put &#39;go_ssh_remote_cmd&#39; below.</span>
    <span class="c"># ...but I could have just used &#39;foo&#39; :)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">socket_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SSHMultiplexingException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;SSH Plugin: Unable to open slave sub-channel.&quot;</span><span class="p">))</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">ssh_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s">&#39;config&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ssh_config_path</span><span class="p">):</span>
        <span class="c"># Create it (an empty one so ssh doesn&#39;t error out)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ssh_config_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c"># Hopefully &#39;go_ssh_remote_cmd&#39; will be a clear enough indication of</span>
    <span class="c"># what is going on by anyone that has to review the logs...</span>
    <span class="n">ssh</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s">&#39;ssh&#39;</span><span class="p">)</span>
    <span class="n">ssh_command</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> -x -S</span><span class="si">%s</span><span class="s"> -F</span><span class="si">%s</span><span class="s"> go_ssh_remote_cmd&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">ssh</span><span class="p">,</span> <span class="n">socket_path</span><span class="p">,</span> <span class="n">ssh_config_path</span><span class="p">)</span>
    <span class="n">OPEN_SUBCHANNELS</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_multiplex</span><span class="p">(</span>
        <span class="n">ssh_command</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> (sub)&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
    <span class="c"># Using huge numbers here so we don&#39;t miss much (if anything) if the user</span>
    <span class="c"># executes something like &quot;ps -ef&quot;.</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="c"># Hopefully 100/200 lines/cols is enough</span>
    <span class="c"># ...if it isn&#39;t, well, that&#39;s not really what this is for :)</span>
    <span class="c"># Set the term title so it gets a proper name in the logs</span>
    <span class="n">m</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">u&#39;echo -e &quot;</span><span class="se">\\</span><span class="s">033]0;Term </span><span class="si">%s</span><span class="s"> sub-channel</span><span class="se">\\</span><span class="s">007&quot;&#39;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</div>
<div class="viewcode-block" id="wait_for_prompt"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.wait_for_prompt">[docs]</a><span class="k">def</span> <span class="nf">wait_for_prompt</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">errorback</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">,</span> <span class="n">matched</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`termio.Multiplex.expect` inside of :func:`execute_command`,</span>
<span class="sd">    clears the screen and executes *cmd*.  Also, sets an</span>
<span class="sd">    :func:`~termio.Multiplex.expect` to call :func:`get_cmd_output` when the</span>
<span class="sd">    end of the command output is detected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;wait_for_prompt()&#39;</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">clear_screen</span><span class="p">()</span> <span class="c"># Makes capturing just what we need easier</span>
    <span class="n">getoutput</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">get_cmd_output</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">errorback</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">OUTPUT_MATCH</span><span class="p">,</span> <span class="n">getoutput</span><span class="p">,</span> <span class="n">errorback</span><span class="o">=</span><span class="n">errorback</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="c"># Run our command immediately followed by our separation/ready string</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">writeline</span><span class="p">((</span>
        <span class="s">u&#39;echo -e &quot;{rs}&quot;; &#39;</span> <span class="c"># Echo the first READY_STRING</span>
        <span class="s">u&#39;{cmd}; &#39;</span> <span class="c"># Execute the command in question</span>
        <span class="s">u&#39;echo -e &quot;{rs}&quot;&#39;</span> <span class="c"># READY_STRING again so we can capture the between</span>
    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rs</span><span class="o">=</span><span class="n">READY_STRING</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="get_cmd_output"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.get_cmd_output">[docs]</a><span class="k">def</span> <span class="nf">get_cmd_output</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">errorback</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">,</span> <span class="n">matched</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Captures the output of the command executed inside of</span>
<span class="sd">    :func:`wait_for_prompt` and calls *callback* if it isn&#39;t `None`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;get_cmd_output()&#39;</span><span class="p">)</span>
    <span class="n">cmd_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()]</span>
    <span class="n">capture</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">cmd_out</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">capture</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">READY_STRING</span><span class="p">):</span>
            <span class="n">capture</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">capture</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">READY_STRING</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="c"># This is just a silly trick to get the shell timing out/terminating itself</span>
    <span class="c"># after a timout (so we don&#39;t keep the sub-channel open forever).  It is</span>
    <span class="c"># easier than starting a timeout thread, timer, IOLoop.add_timeout(), etc</span>
    <span class="c"># (I tried all those and it seemed to result in m_instance never getting</span>
    <span class="c"># cleaned up properly by the garbage collector--it would leak memory)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">unexpect</span><span class="p">()</span> <span class="c"># Clear out any existing patterns (i.e. keepalive ;)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span> <span class="c"># Add our inactivity timeout</span>
        <span class="s">&quot;^SUB-CHANNEL INACTIVITY TIMEOUT$&quot;</span><span class="p">,</span> <span class="c"># ^ and $ to prevent accidents ;)</span>
        <span class="n">noop</span><span class="p">,</span> <span class="c"># Don&#39;t need to do anything since this should never match</span>
        <span class="n">errorback</span><span class="o">=</span><span class="n">timeout_sub_channel</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="n">SUBCHANNEL_TIMEOUT</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="c"># To ensure the timeout occurs</span>
    <span class="n">cmd_out</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="n">callback</span><span class="p">(</span><span class="n">cmd_out</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="terminate_sub_channel"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.terminate_sub_channel">[docs]</a><span class="k">def</span> <span class="nf">terminate_sub_channel</span><span class="p">(</span><span class="n">m_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls `m_instance.terminate()` and deletes it from the OPEN_SUBCHANNELS dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;terminate_sub_channel()&quot;</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">OPEN_SUBCHANNELS</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="c"># Find the Multiplex object inside of OPEN_SUBCHANNELS and remove it</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">OPEN_SUBCHANNELS</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c"># This will be something like: {1: &lt;Multiplex instance&gt;}</span>
        <span class="k">if</span> <span class="nb">hash</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="n">m_instance</span><span class="p">):</span>
            <span class="c"># This is necessary so the interpreter can properly collect garbage:</span>
            <span class="k">del</span> <span class="n">OPEN_SUBCHANNELS</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="timeout_sub_channel"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.timeout_sub_channel">[docs]</a><span class="k">def</span> <span class="nf">timeout_sub_channel</span><span class="p">(</span><span class="n">m_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when the sub-channel times out by way of an</span>
<span class="sd">    :class:`termio.Multiplex.expect` pattern that should never match anything.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s">&quot;Sub-channel on term </span><span class="si">%s</span><span class="s"> closed due to inactivity.&quot;</span>
        <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">m_instance</span><span class="o">.</span><span class="n">term_id</span><span class="p">)))</span>
    <span class="n">terminate_sub_channel</span><span class="p">(</span><span class="n">m_instance</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="got_error"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.got_error">[docs]</a><span class="k">def</span> <span class="nf">got_error</span><span class="p">(</span><span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called if :func:`execute_command` encounters a problem/timeout.</span>

<span class="sd">    *match* is here in case we want to use it for a positive match of an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
        <span class="s">&quot;</span><span class="si">%s</span><span class="s">: Got an error trying to capture output inside of &quot;</span>
        <span class="s">&quot;execute_command() running: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m_instance</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">cmd</span><span class="p">)))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;output before error: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>
    <span class="n">terminate_sub_channel</span><span class="p">(</span><span class="n">m_instance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tws</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;sshjs_cmd_output&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="s">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                <span class="s">&#39;output&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s">&#39;Error: Timeout exceeded or command failed to execute.&#39;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">tws</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="execute_command"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.execute_command">[docs]</a><span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the given command (*cmd*) on the given *term* using the existing</span>
<span class="sd">    SSH tunnel (taking advantage of `Master mode &lt;http://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing&gt;`_)</span>
<span class="sd">    and call *callback* with the output of said command and the current</span>
<span class="sd">    :class:`termio.Multiplex` instance as arguments like so::</span>

<span class="sd">        callback(output, m_instance)</span>

<span class="sd">    If *callback* is not provided then the command will be executed and any</span>
<span class="sd">    output will be ignored.</span>

<span class="sd">    .. note:: This will not result in a new terminal being opened on the client--it simply executes a command and returns the result using the existing SSH tunnel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s">&quot;execute_command(): term: </span><span class="si">%s</span><span class="s">, cmd: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">open_sub_channel</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">tws</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SSHMultiplexingException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="s">: Got an error trying to open sub-channel on term </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">tws</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;upn&#39;</span><span class="p">],</span> <span class="n">term</span><span class="p">)))</span>
        <span class="c"># Try to send an error response to the client</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;sshjs_cmd_output&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="s">&#39;output&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tws</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="c"># This is really just a last-ditch thing</span>
            <span class="k">pass</span>
        <span class="k">return</span>
    <span class="c"># NOTE: We can assume the IOLoop is started and automatically calling read()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">unexpect</span><span class="p">()</span> <span class="c"># Clear out any existing patterns (if existing sub-channel)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">clear_screen</span><span class="p">()</span> <span class="c"># Clear the screen so nothing mucks up our regexes</span>
    <span class="c"># Check to make sure we&#39;ve got a proper prompt by executing an echo</span>
    <span class="c"># statement and waiting for it to complete.  This is more reliable than</span>
    <span class="c"># using a regular expression to match a shell prompt (which could be set</span>
    <span class="c"># to anything).  It also gives us a clear indication as to where the command</span>
    <span class="c"># output begins and ends.</span>
    <span class="n">errorback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">got_error</span><span class="p">,</span> <span class="n">term</span><span class="o">=</span><span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="n">tws</span><span class="p">)</span>
    <span class="n">wait</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">wait_for_prompt</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">errorback</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">READY_MATCH</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">wait</span><span class="p">,</span> <span class="n">errorback</span><span class="o">=</span><span class="n">errorback</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Waiting for READY_MATCH inside execute_command()&quot;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">u&#39;echo -e &quot;</span><span class="se">\\</span><span class="s">n</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">READY_STRING</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="send_result"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.send_result">[docs]</a><span class="k">def</span> <span class="nf">send_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by :func:`ws_exec_command` when the output of the executed command</span>
<span class="sd">    has been captured successfully.  Writes a message to the client with the</span>
<span class="sd">    command&#39;s output and some relevant metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;sshjs_cmd_output&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
            <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
            <span class="s">&#39;output&#39;</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span>
            <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ws_exec_command"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.ws_exec_command">[docs]</a><span class="k">def</span> <span class="nf">ws_exec_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes the necessary variables from *settings* and calls :func:`execute_command`.</span>

<span class="sd">    *settings* should be a dict that contains a &#39;term&#39; and a &#39;cmd&#39; to execute.</span>

<span class="sd">    .. tip:: This function can be used to quickly execute a command and return its result from the client over an existing SSH connection without requiring the user to enter their password!  See execRemoteCmd() in ssh.js.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;term&#39;</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;cmd&#39;</span><span class="p">]</span>
    <span class="n">send</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">send_result</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">execute_command</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">send</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SSHExecutionException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;sshjs_cmd_output&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                <span class="s">&#39;cmd&#39;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">,</span>
                <span class="s">&#39;output&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Error: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="c"># Handlers</span></div>
<div class="viewcode-block" id="KnownHostsHandler"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.KnownHostsHandler">[docs]</a><span class="k">class</span> <span class="nc">KnownHostsHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This handler allows the client to view, edit, and upload the known_hosts</span>
<span class="sd">    file associated with their user account.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@tornado.web.authenticated</span>
<div class="viewcode-block" id="KnownHostsHandler.get"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.KnownHostsHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine what the user is asking for and call the appropriate method.</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="c"># NOTE: Just dealing with known_hosts for now but keys are next</span>
        <span class="n">get_kh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;known_hosts&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">get_kh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_return_known_hosts</span><span class="p">()</span>
</div>
    <span class="nd">@tornado.web.authenticated</span>
<div class="viewcode-block" id="KnownHostsHandler.post"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.KnownHostsHandler.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine what the user is updating by checking the given arguments and</span>
<span class="sd">        proceed with the update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">known_hosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;known_hosts&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">known_hosts</span><span class="p">:</span>
            <span class="n">kh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">body</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_known_hosts</span><span class="p">(</span><span class="n">kh</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KnownHostsHandler._return_known_hosts"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.KnownHostsHandler._return_known_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">_return_known_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the user&#39;s known_hosts file in text/plain format.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;known_hosts requested by </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="p">)</span>
        <span class="n">users_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">)</span> <span class="c"># &quot;User&#39;s dir&quot;</span>
        <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s">&#39;.ssh&#39;</span><span class="p">)</span>
        <span class="n">kh_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s">&#39;known_hosts&#39;</span><span class="p">)</span>
        <span class="n">known_hosts</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">kh_path</span><span class="p">):</span>
            <span class="n">known_hosts</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">kh_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span> <span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">known_hosts</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KnownHostsHandler._save_known_hosts"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.KnownHostsHandler._save_known_hosts">[docs]</a>    <span class="k">def</span> <span class="nf">_save_known_hosts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">known_hosts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the given *known_hosts* file.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
        <span class="n">users_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">)</span> <span class="c"># &quot;User&#39;s dir&quot;</span>
        <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s">&#39;.ssh&#39;</span><span class="p">)</span>
        <span class="n">kh_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s">&#39;known_hosts&#39;</span><span class="p">)</span>
        <span class="c"># Letting Tornado&#39;s exception handler deal with errors here</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">kh_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">known_hosts</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;success&quot;</span><span class="p">)</span>
</div></div>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">WebSocket Commands</span>
<span class="sd">------------------</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c"># WebSocket commands (not the same as handlers)</span>
<span class="c">#def get_connect_string(term, tws):</span>
    <span class="c">#&quot;&quot;&quot;</span>
    <span class="c">#Writes the connection string associated with *term* to the `WebSocket &lt;https://developer.mozilla.org/en/WebSockets/WebSockets_reference/WebSocket&gt;`_</span>
    <span class="c">#like so::</span>

        <span class="c">#{&#39;sshjs_reconnect&#39;: {*term*: &lt;connection string&gt;}}</span>

    <span class="c">#In ssh.js we attach an action (aka handler) to :js:attr:`GateOne.Net.actions`</span>
    <span class="c">#for &#39;sshjs_reconnect&#39; messages that attaches the connection string to</span>
    <span class="c">#`GateOne.terminals[*term*][&#39;sshConnectString&#39;]`</span>
    <span class="c">#&quot;&quot;&quot;</span>
    <span class="c">#logging.debug(&quot;get_connect_string() term: %s&quot; % term)</span>
    <span class="c">#session = tws.session</span>
    <span class="c">#session_dir = tws.settings[&#39;session_dir&#39;]</span>
    <span class="c">#for f in os.listdir(os.path.join(session_dir, session)):</span>
        <span class="c">#if f.startswith(&#39;ssh:&#39;):</span>
            <span class="c">#terminal, a_colon, connect_string = f[4:].partition(&#39;:&#39;)</span>
            <span class="c">#terminal = int(terminal)</span>
            <span class="c">#if terminal == term:</span>
                <span class="c">## TODO: Make it so we don&#39;t have to use json_encode below...</span>
                <span class="c">#message = {</span>
                    <span class="c">#&#39;sshjs_reconnect&#39;: json_encode({term: connect_string})</span>
                <span class="c">#}</span>
                <span class="c">#tws.write_message(message)</span>
                <span class="c">#return # All done</span>

<span class="c"># New version</span>
<div class="viewcode-block" id="get_connect_string"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.get_connect_string">[docs]</a><span class="k">def</span> <span class="nf">get_connect_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the connection string associated with *term* to the `WebSocket &lt;https://developer.mozilla.org/en/WebSockets/WebSockets_reference/WebSocket&gt;`_</span>
<span class="sd">    like so::</span>

<span class="sd">        {&#39;sshjs_reconnect&#39;: {*term*: &lt;connection string&gt;}}</span>

<span class="sd">    In ssh.js we attach an action (aka handler) to :js:attr:`GateOne.Net.actions`</span>
<span class="sd">    for &#39;sshjs_reconnect&#39; messages that attaches the connection string to</span>
<span class="sd">    `GateOne.terminals[*term*][&#39;sshConnectString&#39;]`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_connect_string() term: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">session</span>
    <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">session</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ssh:&#39;</span><span class="p">):</span>
            <span class="n">terminal</span><span class="p">,</span> <span class="n">a_colon</span><span class="p">,</span> <span class="n">connect_string</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">terminal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">terminal</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">terminal</span> <span class="o">==</span> <span class="n">term</span><span class="p">:</span>
                <span class="c"># TODO: Make it so we don&#39;t have to use json_encode below...</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;sshjs_reconnect&#39;</span><span class="p">:</span> <span class="n">json_encode</span><span class="p">({</span><span class="n">term</span><span class="p">:</span> <span class="n">connect_string</span><span class="p">})</span>
                <span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">return</span> <span class="c"># All done</span>
</div>
<div class="viewcode-block" id="get_key"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.get_key">[docs]</a><span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">public</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the private SSH key associated with *name* to the client.  If</span>
<span class="sd">    *public* is `True`, returns the public key to the client.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s">&#39;SSH Plugin Error: Invalid name given, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;save_file&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_dict</span>
    <span class="k">if</span> <span class="n">public</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.pub&#39;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;.pub&#39;</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="c"># Yet</span>
        <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;mimetype&#39;</span><span class="p">:</span> <span class="s">&#39;text/plain&#39;</span>
    <span class="p">}</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">key_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Success&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s">&#39;SSH Plugin Error: Public key not found at </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key_path</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;save_file&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_dict</span>
</div>
<div class="viewcode-block" id="get_public_key"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.get_public_key">[docs]</a><span class="k">def</span> <span class="nf">get_public_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the user&#39;s public key file named *name*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_private_key"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.get_private_key">[docs]</a><span class="k">def</span> <span class="nf">get_private_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the user&#39;s private key file named *name*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_host_fingerprint"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.get_host_fingerprint">[docs]</a><span class="k">def</span> <span class="nf">get_host_fingerprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a the hash of the given host&#39;s public key by making a remote</span>
<span class="sd">    connection to the server (not just by looking at known_hosts).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s">&#39;port&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">22</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;host&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Error:  You must supply a &#39;host&#39;.&quot;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;sshjs_display_fingerprint&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;get_host_fingerprint(</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">,</span>
        <span class="s">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
        <span class="s">&#39;fingerprint&#39;</span><span class="p">:</span> <span class="bp">None</span>
    <span class="p">}</span>
    <span class="n">ssh</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s">&#39;ssh&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_multiplex</span><span class="p">(</span>
        <span class="s">&#39;</span><span class="si">%s</span><span class="s"> -p </span><span class="si">%s</span><span class="s"> -oUserKnownHostsFile=none -F. </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssh</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">host</span><span class="p">),</span>
        <span class="s">&#39;get_host_key&#39;</span><span class="p">,</span>
        <span class="n">logging</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c"># Logging is false so we don&#39;t make tons of silly logs</span>
    <span class="k">def</span> <span class="nf">grab_fingerprint</span><span class="p">(</span><span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;fingerprint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;sshjs_display_fingerprint&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">m_instance</span>
    <span class="k">def</span> <span class="nf">errorback</span><span class="p">(</span><span class="n">m_instance</span><span class="p">):</span>
        <span class="n">leftovers</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Error: Could not determine the fingerprint of </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">... &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">leftovers</span><span class="p">)))</span>
        <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span> <span class="c"># Don&#39;t leave stuff hanging around!</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;sshjs_display_fingerprint&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">m_instance</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#39;.+fingerprint .+$&#39;</span><span class="p">,</span> <span class="n">grab_fingerprint</span><span class="p">,</span> <span class="n">errorback</span><span class="o">=</span><span class="n">errorback</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">spawn</span><span class="p">()</span>
    <span class="c"># OpenSSH output example:</span>
    <span class="c"># ECDSA key fingerprint is 28:46:86:3a:c6:f9:63:b8:90:e1:09:69:f2:1d:c8:ce.</span>
    <span class="c"># Dropbear output example:</span>
    <span class="c"># (fingerprint md5 fa:a1:5b:4f:e5:ab:fe:e6:1f:1f:74:20:d7:35:67:c2)</span>
</div>
<div class="viewcode-block" id="generate_new_keypair"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.generate_new_keypair">[docs]</a><span class="k">def</span> <span class="nf">generate_new_keypair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls :func:`openssh_generate_new_keypair` or</span>
<span class="sd">    :func:`dropbear_generate_new_keypair` depending on what&#39;s available on the</span>
<span class="sd">    system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;generate_new_keypair()&#39;</span><span class="p">)</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;id_ecdsa&#39;</span>
    <span class="n">keytype</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">passphrase</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;keytype&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">keytype</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;keytype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;bits&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;bits&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;passphrase&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">passphrase</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;passphrase&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;comment&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;comment&#39;</span><span class="p">]</span>
    <span class="c">#if which(&#39;dropbearkey&#39;):</span>
        <span class="c">#DROPBEAR_VERSION = shell_command(&#39;dropbear -V&#39;)[1].splitlines()[1]</span>
    <span class="k">if</span> <span class="n">which</span><span class="p">(</span><span class="s">&#39;ssh-keygen&#39;</span><span class="p">):</span> <span class="c"># Prefer OpenSSH</span>
        <span class="n">openssh_generate_new_keypair</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="c"># Name to use when generating the keypair</span>
            <span class="n">users_ssh_dir</span><span class="p">,</span> <span class="c"># Path to save it</span>
            <span class="n">keytype</span><span class="o">=</span><span class="n">keytype</span><span class="p">,</span>
            <span class="n">passphrase</span><span class="o">=</span><span class="n">passphrase</span><span class="p">,</span>
            <span class="n">bits</span><span class="o">=</span><span class="n">bits</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">,</span>
            <span class="n">tws</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">which</span><span class="p">(</span><span class="s">&#39;dropbearkey&#39;</span><span class="p">):</span>
        <span class="n">dropbear_generate_new_keypair</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">errorback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;keygen errorback()&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;sshjs_keygen_complete&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;There was a problem generating SSH keys: </span><span class="si">%s</span><span class="s">&quot;</span>
                        <span class="o">%</span> <span class="n">m_instance</span><span class="o">.</span><span class="n">dump</span><span class="p">()),</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="overwrite"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.overwrite">[docs]</a><span class="k">def</span> <span class="nf">overwrite</span><span class="p">(</span><span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called if we get asked to overwrite an existing keypair.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;overwrite()&#39;</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">enter_passphrase</span><span class="p">(</span><span class="n">passphrase</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;entering passphrase...&quot;</span><span class="p">)</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">passphrase</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m_instance</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;keygen finished.  fingerprint: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fingerprint</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;sshjs_keygen_complete&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">,</span>
            <span class="s">&#39;fingerprint&#39;</span><span class="p">:</span> <span class="n">fingerprint</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">m_instance</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<div class="viewcode-block" id="openssh_generate_new_keypair"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.openssh_generate_new_keypair">[docs]</a><span class="k">def</span> <span class="nf">openssh_generate_new_keypair</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
        <span class="n">keytype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a new private and public key pair--stored in the user&#39;s directory</span>
<span class="sd">    using the given *name* and other optional parameters (using OpenSSH).</span>

<span class="sd">    If *keytype* is given, it must be one of &quot;ecdsa&quot;, &quot;rsa&quot; or &quot;dsa&quot; (case</span>
<span class="sd">    insensitive).  If *keytype* is &quot;rsa&quot; or &quot;ecdsa&quot;, *bits* may be specified to</span>
<span class="sd">    specify the size of the key.</span>

<span class="sd">    .. note:: Defaults to generating a 521-byte ecdsa key if OpenSSH is version 5.7+. Otherwise a 2048-bit rsa key will be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;openssh_generate_new_keypair()&#39;</span><span class="p">)</span>
    <span class="n">openssh_version</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="s">&#39;ssh -V&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ssh_major_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">openssh_version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">ssh_minor_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="n">openssh_version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ssh_version</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssh_major_version</span><span class="p">,</span> <span class="n">ssh_minor_version</span><span class="p">)</span>
    <span class="n">ssh_version</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ssh_version</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keytype</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ssh_version</span> <span class="o">&gt;=</span> <span class="mf">5.7</span><span class="p">:</span>
            <span class="n">keytype</span> <span class="o">=</span> <span class="s">&quot;ecdsa&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keytype</span> <span class="o">=</span> <span class="s">&quot;rsa&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">keytype</span> <span class="o">=</span> <span class="n">keytype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bits</span> <span class="ow">and</span> <span class="n">keytype</span> <span class="o">==</span> <span class="s">&quot;ecdsa&quot;</span><span class="p">:</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="mi">521</span> <span class="c"># Not a typo: five-hundred-twenty-one bits</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">bits</span> <span class="ow">and</span> <span class="n">keytype</span> <span class="o">==</span> <span class="s">&quot;rsa&quot;</span><span class="p">:</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="mi">2048</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">passphrase</span><span class="p">:</span> <span class="c"># This just makes sure False and None end up as &#39;&#39;</span>
        <span class="n">passphrase</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">comment</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="s">&quot;Generated by Gate One on </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
    <span class="n">ssh_keygen_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s">&#39;ssh-keygen&#39;</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span>       <span class="c"># Path to ssh-keygen</span>
        <span class="s">&quot;-b </span><span class="si">%s</span><span class="s"> &quot;</span>    <span class="c"># bits</span>
        <span class="s">&quot;-t </span><span class="si">%s</span><span class="s"> &quot;</span>    <span class="c"># keytype</span>
        <span class="s">&quot;-C &#39;</span><span class="si">%s</span><span class="s">&#39; &quot;</span>  <span class="c"># comment</span>
        <span class="s">&quot;-f </span><span class="si">%s</span><span class="s">&quot;</span>     <span class="c"># Key path</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">keytype</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">key_path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">tws</span><span class="o">.</span><span class="n">new_multiplex</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;gen_ssh_keypair&quot;</span><span class="p">)</span>
    <span class="n">call_errorback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">errorback</span><span class="p">,</span> <span class="n">tws</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#39;^Overwrite.*&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">passphrase_handler</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">enter_passphrase</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#39;^Enter passphrase&#39;</span><span class="p">,</span>
        <span class="n">passphrase_handler</span><span class="p">,</span> <span class="n">errorback</span><span class="o">=</span><span class="n">call_errorback</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#39;^Enter same passphrase again&#39;</span><span class="p">,</span>
        <span class="n">passphrase_handler</span><span class="p">,</span> <span class="n">errorback</span><span class="o">=</span><span class="n">call_errorback</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">finalize</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">finished</span><span class="p">,</span> <span class="n">tws</span><span class="p">)</span>
    <span class="c"># The regex below captures the md5 fingerprint which tells us the</span>
    <span class="c"># operation was successful.</span>
    <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span>
        <span class="s">&#39;(([0-9a-f][0-9a-f]\:){15}[0-9a-f][0-9a-f])&#39;</span><span class="p">,</span>
        <span class="n">finalize</span><span class="p">,</span>
        <span class="n">errorback</span><span class="o">=</span><span class="n">call_errorback</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span> <span class="c"># Key generation can take a little while</span>
    <span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">spawn</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="dropbear_generate_new_keypair"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.dropbear_generate_new_keypair">[docs]</a><span class="k">def</span> <span class="nf">dropbear_generate_new_keypair</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
        <span class="n">keytype</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    .. note:: Not implemented yet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="openssh_generate_public_key"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.openssh_generate_public_key">[docs]</a><span class="k">def</span> <span class="nf">openssh_generate_public_key</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">passphrase</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a public key from the given private key at *path*.  If a</span>
<span class="sd">    *passphrase* is provided, it will be used to generate the public key (if</span>
<span class="sd">    necessary).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;openssh_generate_public_key()&#39;</span><span class="p">)</span>
    <span class="n">ssh_keygen_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s">&#39;ssh-keygen&#39;</span><span class="p">)</span>
    <span class="n">pubkey_path</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.pub&quot;</span> <span class="o">%</span> <span class="n">path</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span>       <span class="c"># Path to ssh-keygen</span>
        <span class="s">&quot;-f </span><span class="si">%s</span><span class="s"> &quot;</span>    <span class="c"># Key path</span>
        <span class="s">&quot;-y &quot;</span>       <span class="c"># Output public key to stdout</span>
        <span class="s">&quot;2&gt;&amp;1 &quot;</span>     <span class="c"># Redirect stderr to stdout so we can catch failures</span>
        <span class="s">&quot;&gt; </span><span class="si">%s</span><span class="s">&quot;</span>      <span class="c"># Redirect stdout to the public key path</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pubkey_path</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="kn">import</span> <span class="nn">termio</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">termio</span><span class="o">.</span><span class="n">Multiplex</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">request_passphrase</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">&quot;Called if this key requires a passphrase.  Ask the client to provide&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;sshjs_ask_passphrase&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="p">}</span>
        <span class="n">tws</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">bad_passphrase</span><span class="p">(</span><span class="n">m_instance</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="s">&quot;Called if the user entered a bad passphrase&quot;</span>
        <span class="n">settings</span><span class="p">[</span><span class="s">&#39;bad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">request_passphrase</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">passphrase</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#39;^Enter passphrase&#39;</span><span class="p">,</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">passphrase</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#39;^load failed&#39;</span><span class="p">,</span>
            <span class="n">bad_passphrase</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">settings</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&#39;^Enter passphrase&#39;</span><span class="p">,</span>
            <span class="n">request_passphrase</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">atexit</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">exitstatus</span><span class="p">):</span>
        <span class="s">&quot;Raises an SSHKeygenException if the *exitstatus* isn&#39;t 0&quot;</span>
        <span class="k">if</span> <span class="n">exitstatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SSHKeygenException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Error generating public key from private key at </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">))</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">exitfunc</span><span class="o">=</span><span class="n">atexit</span><span class="p">)</span>
    <span class="c">#exitstatus, output = shell_command(command)</span>
    <span class="c">#if exitstatus != 0:</span>
        <span class="c">#raise SSHKeygenException(_(</span>
            <span class="c">#&quot;Error generating public key from private key at %s&quot; % path))</span>

<span class="c"># ssh-kegen example for reference:</span>
    <span class="c">#$ ssh-keygen -b 521 -t ecdsa &quot;Testing&quot; -f /tmp/testkey</span>
    <span class="c">#Generating public/private ecdsa key pair.</span>
    <span class="c">#Enter passphrase (empty for no passphrase):</span>
    <span class="c">#Enter same passphrase again:</span>
    <span class="c">#Your identification has been saved in /tmp/testkey.</span>
    <span class="c">#Your public key has been saved in /tmp/testkey.pub.</span>
    <span class="c">#The key fingerprint is:</span>
    <span class="c">#6b:13:4b:5d:80:bd:21:70:33:f5:b9:15:78:75:08:9a Testing</span>
    <span class="c">#The key&#39;s randomart image is:</span>
    <span class="c">#+--[ECDSA  521]---+</span>
    <span class="c">#|      ..++o .o.oo|</span>
    <span class="c">#|       .ooo=..o..|</span>
    <span class="c">#|         .Eo+..  |</span>
    <span class="c">#|         ... o   |</span>
    <span class="c">#|        S . .    |</span>
    <span class="c">#|       . +       |</span>
    <span class="c">#|        =        |</span>
    <span class="c">#|       . .       |</span>
    <span class="c">#|                 |</span>
    <span class="c">#+-----------------+</span>

<span class="c"># dropbearkey example for reference:</span>

    <span class="c">#root@router:~# dropbearkey -t dss -f /tmp/testing</span>
    <span class="c">#Will output 1024 bit dss secret key to &#39;/tmp/testing&#39;</span>
    <span class="c">#Generating key, this may take a while...</span>
    <span class="c">#Public key portion is:</span>
    <span class="c">#ssh-dss AAAAB3NzaC1kc3MAAACBAJ5jU4izsZtJKEojw7gIcc6e3U4X6OENN6081YxSAanfTbKjR0V3Ho6aui2z8o039BVH4S5cVD51vEEvDjirKStM2aMvdrVZkjGH1iOMWY4MQrCl4EqMr7rWikeiZJN6BJ+xmPBUyZuicVDFkBwqC+dKgxml0RTpa7TYBWvp403XAAAAFQDg6vb3afaKM9+DvBW7I4xPxF8a8QAAAIEAjcNHYFrqcWK9lSsw2Oy+w1PEWQuxvWydXXk3MQyiZ/PYaeU/138iCB2pW1fgCksx5CHF8dgtQ7AsFv32gBlxuDgX3EYtPYR0wGJqyU7w9+qaq1T02zmDfW4k2WDfMNz+QWFYHuKzC/aeuEC0BRTLyPVQMHLNAd/F5beCqlIPRPcAAACAfUy1+yNgK2svox6aJRqtpxbMSPDRNTRMAjeTkCeLopesZFYbPvms2c19WkIk2qD9aw3gIxsR4wO+kkvI4BtOs8dXQWS+bc+svJbIYOqmPFo89BJHfbP9wvMhfTlp1uH9LxAG6ZiHHz5fseUgTrwYkSw1beUprikxlca8lQm5v7g= root@RouterStationPro</span>
    <span class="c">#Fingerprint: md5 c6:f9:f2:95:b8:40:ac:f3:53:f1:39:e9:57:a0:58:18</span>

<span class="c"># TODO: Get this validating uploaded keys.</span></div>
<div class="viewcode-block" id="store_id_file"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.store_id_file">[docs]</a><span class="k">def</span> <span class="nf">store_id_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores the given *settings[&#39;private&#39;]* and/or *settings[&#39;public&#39;]* keypair</span>
<span class="sd">    in the user&#39;s ssh directory as *settings[&#39;name&#39;]* and/or</span>
<span class="sd">    *settings[&#39;name&#39;]*.pub, respectively.  Either file can be saved independent</span>
<span class="sd">    of each other (in case this function needs to be called multiple times to</span>
<span class="sd">    save each respective file).</span>

<span class="sd">    Also, a *settings[&#39;certificate&#39;]* may be provided to be saved along</span>
<span class="sd">    with the private and public keys.  It will be saved as</span>
<span class="sd">    *settings[&#39;name&#39;]*-cert.pub.</span>

<span class="sd">    .. note:: I&#39;ve found the following website helpful in understanding how to use OpenSSH with SSL certificates: http://blog.habets.pp.se/2011/07/OpenSSH-certificates</span>

<span class="sd">    .. tip:: Using signed-by-a-CA certificates is very handy because allows you to revoke the user&#39;s SSH key(s).  e.g. If they left the company.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;store_id_file()&#39;</span><span class="p">)</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">}</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">private</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">certificate</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="n">passphrase</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">global</span> <span class="n">TIMER</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SSHKeypairException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;You must specify a valid *name*.&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s">&#39;private&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">private</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;public&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">public</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;public&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;certificate&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">certificate</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;certificate&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;passphrase&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">passphrase</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;passphrase&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">private</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">public</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">certificate</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SSHKeypairException</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No files were given to save!&quot;</span><span class="p">))</span>
        <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">private_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">public_key_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.pub&#39;</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.pub&#39;</span><span class="p">):</span>
            <span class="n">public_key_name</span> <span class="o">=</span> <span class="n">name</span> <span class="c"># Get rid of the extra .pub</span>
        <span class="n">public_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">public_key_name</span><span class="p">)</span>
        <span class="n">certificate_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39;-cert.pub&#39;</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-cert.pub&#39;</span><span class="p">):</span>
            <span class="n">certificate_name</span> <span class="o">=</span> <span class="n">name</span> <span class="c"># Don&#39;t need an extra -cert.pub at the end</span>
        <span class="n">certificate_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">certificate_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">private</span><span class="p">:</span>
            <span class="c"># Fix Windows newlines</span>
            <span class="n">private</span> <span class="o">=</span> <span class="n">private</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">VALID_PRIVATE_KEY</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">private</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">private</span><span class="p">)</span>
                <span class="c"># Without this you get a warning:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">,</span> <span class="mo">0600</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">({</span><span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;ERROR: Private key is not valid.&quot;</span><span class="p">)})</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">public</span><span class="p">:</span>
            <span class="c"># Fix Windows newlines</span>
            <span class="n">public</span> <span class="o">=</span> <span class="n">public</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">public_key_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">public</span><span class="p">)</span>
            <span class="c"># Now remove the timer that will generate the public key from the</span>
            <span class="c"># private key if it is set.</span>
            <span class="k">if</span> <span class="n">TIMER</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;Got public key, cancelling public key generation timer.&quot;</span><span class="p">))</span>
                <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
                <span class="n">io_loop</span><span class="o">.</span><span class="n">remove_timeout</span><span class="p">(</span><span class="n">TIMER</span><span class="p">)</span>
                <span class="n">TIMER</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">private</span><span class="p">:</span> <span class="c"># No biggie, generate one</span>
            <span class="c"># Only generate a new public key if one isn&#39;t uploaded within 2</span>
            <span class="c"># seconds (should be plenty of time since they&#39;re typically sent</span>
            <span class="c"># simultaneously but inside different WebSocket messages).</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Only received a private key.  Setting timeout to generate the &quot;</span>
                <span class="s">&quot;public key if not received within 3 seconds.&quot;</span><span class="p">))</span>
            <span class="n">io_loop</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
            <span class="n">deadline</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">generate_public_key</span><span class="p">():</span> <span class="c"># I love closures</span>
                <span class="n">openssh_generate_public_key</span><span class="p">(</span>
                    <span class="n">private_key_path</span><span class="p">,</span> <span class="n">passphrase</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">get_ids</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">get_identities</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">get_ids</span><span class="p">)</span>
            <span class="c"># This gets removed if the public key is uploaded</span>
            <span class="n">TIMER</span> <span class="o">=</span> <span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="n">deadline</span><span class="p">,</span> <span class="n">generate_public_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">certificate</span><span class="p">:</span>
            <span class="c"># Fix Windows newlines</span>
            <span class="n">certificate</span> <span class="o">=</span> <span class="n">certificate</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">certificate_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">certificate</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Error saving keys: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;sshjs_save_id_complete&#39;</span><span class="p">:</span> <span class="n">out_dict</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="delete_identity"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.delete_identity">[docs]</a><span class="k">def</span> <span class="nf">delete_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the identity associated with *name*.  For example if *name* is</span>
<span class="sd">    &#39;testkey&#39;, &#39;testkey&#39; and &#39;testkey.pub&#39; would be removed from the user&#39;s</span>
<span class="sd">    ssh directory (and &#39;testkey-cert.pub&#39; if present).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;delete_identity()&#39;</span><span class="p">)</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">}</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">private_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">public_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s">&#39;.pub&#39;</span><span class="p">)</span>
    <span class="n">certificate_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s">&#39;-cert.pub&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">private_key_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">public_key_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">public_key_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">certificate_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">certificate_path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Error deleting keypair: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;sshjs_delete_identity_complete&#39;</span><span class="p">:</span> <span class="n">out_dict</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_identities"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.get_identities">[docs]</a><span class="k">def</span> <span class="nf">get_identities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anything</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sends a message to the client with a list of the identities stored on the</span>
<span class="sd">    server for the current user.</span>

<span class="sd">    *anything* is just there because the client needs to send *something* along</span>
<span class="sd">    with the &#39;action&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;get_identities()&#39;</span><span class="p">)</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">}</span>
    <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;identities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ssh_keygen_path</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s">&#39;ssh-keygen&#39;</span><span class="p">)</span>
    <span class="n">keytype_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;.*\(([A-Z]+)\)$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="c"># TODO:  Switch this from using ssh-keygen to determine the keytype to using the string inside the public key.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">):</span>
            <span class="n">ssh_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ssh_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.pub&#39;</span><span class="p">):</span>
                    <span class="c"># Double-check there&#39;s also a private key...</span>
                    <span class="n">identity</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="c"># Will be the same name minus &#39;.pub&#39;</span>
                    <span class="k">if</span> <span class="n">identity</span> <span class="ow">in</span> <span class="n">ssh_files</span><span class="p">:</span>
                        <span class="n">id_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">identity</span><span class="p">)</span>
                        <span class="n">pub_key_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                        <span class="n">public_key_contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pub_key_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">comment</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">public_key_contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
                        <span class="k">if</span> <span class="n">public_key_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ecdsa&#39;</span><span class="p">):</span>
                            <span class="n">keytype</span> <span class="o">=</span> <span class="s">&#39;ECDSA&#39;</span>
                        <span class="k">elif</span> <span class="n">public_key_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ssh-dss&#39;</span><span class="p">):</span>
                            <span class="n">keytype</span> <span class="o">=</span> <span class="s">&#39;DSA&#39;</span>
                        <span class="k">elif</span> <span class="n">public_key_contents</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;ssh-rsa&#39;</span><span class="p">):</span>
                            <span class="n">keytype</span> <span class="o">=</span> <span class="s">&#39;RSA&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">keytype</span> <span class="o">=</span> <span class="s">&#39;Unknown&#39;</span>
                        <span class="n">keygen_cmd</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> -vlf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">id_path</span><span class="p">)</span>
                        <span class="n">retcode</span><span class="p">,</span> <span class="n">key_info</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span><span class="n">keygen_cmd</span><span class="p">)</span>
                        <span class="c"># This will just wind up as an empty string if the</span>
                        <span class="c"># version of ssh doesn&#39;t support randomart:</span>
                        <span class="n">randomart</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_info</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">bits</span> <span class="o">=</span> <span class="n">key_info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">fingerprint</span> <span class="o">=</span> <span class="n">key_info</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">retcode</span><span class="p">,</span> <span class="n">bubblebabble</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span>
                            <span class="s">&quot;</span><span class="si">%s</span><span class="s"> -Bf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">id_path</span><span class="p">))</span>
                        <span class="n">bubblebabble</span> <span class="o">=</span> <span class="n">bubblebabble</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">certinfo</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="n">cert_path</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">-cert.pub&quot;</span> <span class="o">%</span> <span class="n">id_path</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cert_path</span><span class="p">):</span>
                            <span class="n">retcode</span><span class="p">,</span> <span class="n">certinfo</span> <span class="o">=</span> <span class="n">shell_command</span><span class="p">(</span>
                            <span class="s">&quot;</span><span class="si">%s</span><span class="s"> -Lf </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ssh_keygen_path</span><span class="p">,</span> <span class="n">cert_path</span><span class="p">))</span>
                        <span class="n">certinfo</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">certinfo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">fixed_certinfo</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">certinfo</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                            <span class="n">fixed_certinfo</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;    &#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span>
                            <span class="n">fixed_certinfo</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                        <span class="n">id_obj</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">identity</span><span class="p">,</span>
                            <span class="s">&#39;public&#39;</span><span class="p">:</span> <span class="n">public_key_contents</span><span class="p">,</span>
                            <span class="s">&#39;keytype&#39;</span><span class="p">:</span> <span class="n">keytype</span><span class="p">,</span>
                            <span class="s">&#39;bubblebabble&#39;</span><span class="p">:</span> <span class="n">bubblebabble</span><span class="p">,</span>
                            <span class="s">&#39;fingerprint&#39;</span><span class="p">:</span> <span class="n">fingerprint</span><span class="p">,</span>
                            <span class="s">&#39;randomart&#39;</span><span class="p">:</span> <span class="n">randomart</span><span class="p">,</span>
                            <span class="s">&#39;certinfo&#39;</span><span class="p">:</span> <span class="n">fixed_certinfo</span><span class="p">,</span>
                            <span class="s">&#39;bits&#39;</span><span class="p">:</span> <span class="n">bits</span><span class="p">,</span>
                            <span class="s">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span>
                        <span class="p">}</span>
                        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;identities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_obj</span><span class="p">)</span>
        <span class="c"># Figure out which identities are defaults</span>
        <span class="n">default_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">default_ids_exists</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">default_ids_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s">&#39;.default_ids&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">default_ids_path</span><span class="p">):</span>
            <span class="n">default_ids_exists</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">default_ids_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">default_ids</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="c"># Why not readlines()? \n</span>
        <span class="c"># Convert any absolute paths inside default_ids to just the short names</span>
        <span class="n">default_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">default_ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">default_ids_exists</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">id_obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;identities&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">id_obj</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">default_ids</span><span class="p">:</span>
                    <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;identities&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;identities&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Error getting identities: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;sshjs_identities_list&#39;</span><span class="p">:</span> <span class="n">out_dict</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="set_default_identities"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.set_default_identities">[docs]</a><span class="k">def</span> <span class="nf">set_default_identities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identities</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of *identities*, mark them as defaults to use in all outbound</span>
<span class="sd">    SSH connections by writing them to `&lt;user&#39;s ssh dir&gt;/.default_ids`.  If</span>
<span class="sd">    *identities* is empty, no identities will be used in outbound connections.</span>

<span class="sd">    .. note:: Whenever this function is called it will overwrite whatever is in `.default_ids`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">identities</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c"># Ignore anything else</span>
        <span class="n">users_ssh_dir</span> <span class="o">=</span> <span class="n">get_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">default_ids_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_ssh_dir</span><span class="p">,</span> <span class="s">&#39;.default_ids&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">default_ids_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">identities</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="c"># Need that trailing newline</span>

<span class="c"># Special optional escape sequence handler (see docs on how it works)</span></div>
<div class="viewcode-block" id="opt_esc_handler"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.opt_esc_handler">[docs]</a><span class="k">def</span> <span class="nf">opt_esc_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles text passed from the special optional escape sequance handler.  We</span>
<span class="sd">    use it to tell ssh.js what the SSH connection string is so it can use that</span>
<span class="sd">    information to duplicate sessions (if the user so desires).  For reference,</span>
<span class="sd">    the specific string which will call this function from a terminal app is::</span>

<span class="sd">        \\x1b]_;ssh|&lt;whatever&gt;\x07</span>

<span class="sd">    .. seealso:: :class:`gateone.TerminalWebSocket.esc_opt_handler` and :func:`terminal.Terminal._opt_handler`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;sshjs_connect&#39;</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="create_user_ssh_dir"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.create_user_ssh_dir">[docs]</a><span class="k">def</span> <span class="nf">create_user_ssh_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    To be called by the &#39;Auth&#39; hook that gets called after the user is done</span>
<span class="sd">    authenticating, ensures that the `&lt;user&#39;s dir&gt;/ssh` directory exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
    <span class="n">users_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">)</span> <span class="c"># &quot;User&#39;s dir&quot;</span>
    <span class="n">ssh_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">users_dir</span><span class="p">,</span> <span class="s">&#39;.ssh&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">ssh_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Error creating user&#39;s ssh directory: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="send_css_template"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.send_css_template">[docs]</a><span class="k">def</span> <span class="nf">send_css_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sends our ssh.css template to the client using the &#39;load_style&#39; WebSocket</span>
<span class="sd">    action.  Uses :attr:`ApplicationWebSocket.persist` to store a reference to</span>
<span class="sd">    the rendered CSS template to ensure we only ever have to render it once.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Here we use the &#39;persist&#39; dict to keep track of our rendered CSS template</span>
    <span class="k">if</span> <span class="s">&#39;ssh_css&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;go_ssh_css&#39;</span><span class="p">)</span>
        <span class="n">css_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PLUGIN_PATH</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;ssh.css&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">css_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">css_template</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">rendered</span> <span class="o">=</span> <span class="n">css_template</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
            <span class="n">container</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">container</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">prefix</span>
        <span class="p">)</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c"># Save the rendered template to our persistent store so we don&#39;t have to</span>
        <span class="c"># process it with every page load.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s">&#39;ssh_css&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">persist</span><span class="p">[</span><span class="s">&#39;ssh_css&#39;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="initialize"><a class="viewcode-back" href="../Developer/plugin_ssh.html#ssh.initialize">[docs]</a><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called inside of :meth:`TerminalApplication.initialize` shortly after the</span>
<span class="sd">    WebSocket is instantiated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<span class="n">hooks</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;Web&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s">r&quot;/ssh&quot;</span><span class="p">,</span> <span class="n">KnownHostsHandler</span><span class="p">)],</span>
    <span class="s">&#39;WebSocket&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;ssh_get_connect_string&#39;</span><span class="p">:</span> <span class="n">get_connect_string</span><span class="p">,</span>
        <span class="s">&#39;ssh_execute_command&#39;</span><span class="p">:</span> <span class="n">ws_exec_command</span><span class="p">,</span>
        <span class="s">&#39;ssh_get_identities&#39;</span><span class="p">:</span> <span class="n">get_identities</span><span class="p">,</span>
        <span class="s">&#39;ssh_get_public_key&#39;</span><span class="p">:</span> <span class="n">get_public_key</span><span class="p">,</span>
        <span class="s">&#39;ssh_get_private_key&#39;</span><span class="p">:</span> <span class="n">get_private_key</span><span class="p">,</span>
        <span class="s">&#39;ssh_get_host_fingerprint&#39;</span><span class="p">:</span> <span class="n">get_host_fingerprint</span><span class="p">,</span>
        <span class="s">&#39;ssh_gen_new_keypair&#39;</span><span class="p">:</span> <span class="n">generate_new_keypair</span><span class="p">,</span>
        <span class="s">&#39;ssh_store_id_file&#39;</span><span class="p">:</span> <span class="n">store_id_file</span><span class="p">,</span>
        <span class="s">&#39;ssh_delete_identity&#39;</span><span class="p">:</span> <span class="n">delete_identity</span><span class="p">,</span>
        <span class="s">&#39;ssh_set_default_identities&#39;</span><span class="p">:</span> <span class="n">set_default_identities</span>
    <span class="p">},</span>
    <span class="s">&#39;Escape&#39;</span><span class="p">:</span> <span class="n">opt_esc_handler</span><span class="p">,</span>
    <span class="s">&#39;Auth&#39;</span><span class="p">:</span> <span class="n">create_user_ssh_dir</span><span class="p">,</span>
    <span class="s">&#39;Events&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;terminal:authenticate&#39;</span><span class="p">:</span> <span class="n">send_css_template</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c"># Certificate information (as output by ssh-keygen) for reference:</span>
<span class="c">#</span>
<span class="c">#$ ssh-keygen -Lf id_rsa-cert.pub</span>
<span class="c">#id_rsa-cert.pub:</span>
        <span class="c">#Type: ssh-rsa-cert-v01@openssh.com user certificate</span>
        <span class="c">#Public key: RSA-CERT 80:57:2c:18:f9:86:ab:8b:64:27:db:6f:5e:03:3f:d9</span>
        <span class="c">#Signing CA: RSA 86:25:b0:73:67:0f:51:2e:a7:96:63:08:fb:d6:69:94</span>
        <span class="c">#Key ID: &quot;user_riskable&quot;</span>
        <span class="c">#Serial: 0</span>
        <span class="c">#Valid: from 2012-01-08T13:38:00 to 2013-01-06T13:39:27</span>
        <span class="c">#Principals:</span>
                <span class="c">#riskable</span>
        <span class="c">#Critical Options: (none)</span>
        <span class="c">#Extensions:</span>
                <span class="c">#permit-agent-forwarding</span>
                <span class="c">#permit-port-forwarding</span>
                <span class="c">#permit-pty</span>
                <span class="c">#permit-user-rc</span>
                <span class="c">#permit-X11-forwarding</span>


<span class="c"># NOTE: *message[&#39;identities&#39;][0]* - An associative array conaining the key&#39;s metadata.  For example:</span>
<span class="c">#</span>
<span class="c">#{</span>
    <span class="c">#&#39;name&#39;: &quot;testid&quot;,</span>
    <span class="c">#&#39;public&#39;: &quot;ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAChqFprVjC0MKe3qpjjc+WdANOHMgcUl46dJxZ+s5soBTkO6thcJDAbFb36lg3YyzZi/PtDJV5CPp8Mv1SUXUYBqgFZJFBqWwkB0O1ohjtEVzC8+ybrY+hP0zLqykglhOi+6W66HgFwjJGn56uGE7s8UpnSRKtqGq2USyme5gopYlytTw== Generated by Gate One on somehost&quot;,</span>
    <span class="c">#&#39;keytype&#39;: &quot;ecdsa&quot;,</span>
    <span class="c">#&#39;bubblebabble&#39;: &quot;xevol-budez-difod-zumif-zofos-vezis-rilep-febel-tufok-lugud-dyxex&quot;,</span>
    <span class="c">#&#39;fingerprint&#39;: &quot;0e:69:0a:9e:2e:26:2b:91:23:3d:95:4b:65:31:a9:6f&quot;,</span>
    <span class="c">#&#39;randomart&#39;: &quot;+--[ECDSA  521]---+\n|      oo         |\n|      +.         |\n|     =           |\n|    =  .         |\n| o.o o+ S        |\n|=.oo.oEo         |\n|.oo...  .        |\n|+o               |\n|=o.              |\n+-----------------+&quot;,</span>
    <span class="c">#&#39;certinfo&#39;: &quot;&quot;,</span>
    <span class="c">#&#39;bits&#39;: 521,</span>
    <span class="c">#&#39;comment&#39;: &quot;Generated by Gate One on somehost&quot;,</span>
<span class="c">#}</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/ls_logo_1inch_300dpi.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Liftoff Software Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
<script type="text/javascript">
window.onload = function(e) {
    // Make our collapseindex elements actually collapsible
    $('<span class="collapsindextitle">Index</span> <a class="showhide">[show]</a>').insertBefore('.collapseindex');
    $('.showhide').each(function(index, value){
        var showHide = $(this);
        showHide.click(function() {
            if (this.innerHTML == "[hide]") {
                this.innerHTML = "[show]";
            } else {
                this.innerHTML = "[hide]";
            }
            $(this).next('.collapseindex').toggle(1); // This should always be the next .collapseindex element
        });
    });
    $('.collapseindex').each(function(index, value){
        // Start them out hidden
        $(this).hide();
    });
}
</script>

  </body>
</html>