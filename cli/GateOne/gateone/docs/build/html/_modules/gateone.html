

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gateone &mdash; Gate One 1.1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/ansi.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="top" title="Gate One 1.1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for gateone</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#       Copyright 2011 Liftoff Software Corporation</span>
<span class="c">#</span>
<span class="c"># For license information see LICENSE.txt</span>

<span class="c"># TODO:</span>

<span class="c"># Meta</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;1.1.0&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;AGPLv3 or Proprietary (see LICENSE.txt)&quot;</span>
<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>

<span class="c"># NOTE: Docstring includes reStructuredText markup for use with Sphinx.</span>
<span class="n">__doc__</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">.. _gateone.py:</span>

<span class="s">Gate One</span>
<span class="s">========</span>
<span class="s">Gate One is a web-based terminal emulator written in Python using the Tornado</span>
<span class="s">web framework.  This module runs the primary daemon process and acts as a</span>
<span class="s">central controller for all running terminals and terminal programs.  It supports</span>
<span class="s">numerous configuration options and can also be called with the --kill switch</span>
<span class="s">to kill all running terminal programs (if using dtach--otherwise they die on</span>
<span class="s">their own when gateone.py is stopped).</span>

<span class="s">Dependencies</span>
<span class="s">------------</span>
<span class="s">Gate One requires Python 2.6+ but runs best with Python 2.7+.  It also depends</span>
<span class="s">on the following 3rd party Python modules:</span>

<span class="s"> * `Tornado &lt;http://www.tornadoweb.org/&gt;`_ 2.2+ - A non-blocking web server framework that powers FriendFeed.</span>

<span class="s">The following modules are optional and can provide Gate One with additional</span>
<span class="s">functionality:</span>

<span class="s"> * `pyOpenSSL &lt;https://launchpad.net/pyopenssl&gt;`_ 0.10+ - An OpenSSL module/wrapper for Python.  Only used to generate self-signed SSL keys and certificates.  If pyOpenSSL isn&#39;t available Gate One will fall back to using the &#39;openssl&#39; command to generate self-signed certificates.</span>
<span class="s"> * `kerberos &lt;http://pypi.python.org/pypi/kerberos&gt;`_ 1.0+ - A high-level Kerberos interface for Python.  Only necessary if you plan to use the Kerberos authentication module.</span>
<span class="s"> * `python-pam &lt;http://packages.debian.org/lenny/python-pam&gt;`_ 0.4.2+ - A Python module for interacting with PAM (the Pluggable Authentication Module present on nearly every Unix).  Only necessary if you plan to use PAM authentication.</span>

<span class="s">With the exception of python-pam, both the required and optional modules can usually be installed via one of these commands:</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@modern-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo pip install tornado pyopenssl kerberos</span>

<span class="s">...or:</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@legacy-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo easy_install tornado pyopenssl kerberos</span>

<span class="s">.. note:: The use of pip is recommended.  See http://www.pip-installer.org/en/latest/installing.html if you don&#39;t have it.</span>

<span class="s">The python-pam module is available in most Linux distribution repositories.  Simply executing one of the following should take care of it:</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@debian-or-ubuntu-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo apt-get install python-pam</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@redhat-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo yum install python-pam</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@gentoo-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo emerge python-pam</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@suse-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo yast -i python-pam</span>

<span class="s">Settings</span>
<span class="s">--------</span>
<span class="s">All of Gate One&#39;s configurable options can be controlled either via command line</span>
<span class="s">switches or by settings in the server.conf file (they match up 1-to-1).  If no</span>
<span class="s">server.conf exists one will be created using defaults (i.e. when Gate One is run</span>
<span class="s">for the first time).  Settings in the server.conf file use the following format::</span>

<span class="s">    &lt;setting&gt; = &lt;value&gt;</span>

<span class="s">Here&#39;s an example::</span>

<span class="s">    address = &quot;127.0.0.1;::1;10.1.1.4&quot; # Strings are surrounded by quotes</span>
<span class="s">    port = 443 # Numbers don&#39;t need quotes</span>

<span class="s">There are a few important differences between the configuration file and</span>
<span class="s">command line switches in regards to boolean values (True/False).  A switch such</span>
<span class="s">as --debug evaluates to &quot;debug = True&quot; and this is exactly how it would be</span>
<span class="s">configured in server.conf::</span>

<span class="s">    debug = True # Booleans don&#39;t need quotes either</span>

<span class="s">.. note:: The following values in server.conf are case sensitive: True, False and None (and should not be placed in quotes).</span>

<span class="s">Running gateone.py with the --help switch will print the usage information as</span>
<span class="s">well as descriptions of what each configurable option does:</span>

<span class="s">.. ansi-block::</span>

<span class="s">    </span><span class="se">\x1b</span><span class="s">[1;31mroot</span><span class="se">\x1b</span><span class="s">[0m@host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m ./gateone.py --help</span>
<span class="s">    Usage: ./gateone.py [OPTIONS]</span>

<span class="s">    Options:</span>
<span class="s">      --help                           show this help information</span>
<span class="s">      --log_file_max_size              max size of log files before rollover</span>
<span class="s">      --log_file_num_backups           number of log files to keep</span>
<span class="s">      --log_file_prefix=PATH           Path prefix for log files. Note that if you are running multiple tornado processes, log_file_prefix must be different for each of them (e.g. include the port number)</span>
<span class="s">      --log_to_stderr                  Send log output to stderr (colorized if possible). By default use stderr if --log_file_prefix is not set and no other logging is configured.</span>
<span class="s">      --logging=debug|info|warning|error|none Set the Python log level. If &#39;none&#39;, tornado won&#39;t touch the logging configuration.</span>
<span class="s">      --address                        Run on the given address.  Default is all addresses (IPv6 included).  Multiple address can be specified using a semicolon as a separator (e.g. &#39;127.0.0.1;::1;10.1.1.100&#39;).</span>
<span class="s">      --auth                           Authentication method to use.  Valid options are: none, api, google, kerberos, pam</span>
<span class="s">      --certificate                    Path to the SSL certificate.  Will be auto-generated if none is provided.</span>
<span class="s">      --command                        Run the given command when a user connects (e.g. &#39;/bin/login&#39;).</span>
<span class="s">      --config                         Path to the config file.  Default: /opt/gateone/server.conf</span>
<span class="s">      --cookie_secret                  Use the given 45-character string for cookie encryption.</span>
<span class="s">      --debug                          Enable debugging features such as auto-restarting when files are modified.</span>
<span class="s">      --disable_ssl                    If enabled, Gate One will run without SSL (generally not a good idea).</span>
<span class="s">      --dtach                          Wrap terminals with dtach. Allows sessions to be resumed even if Gate One is stopped and started (which is a sweet feature).</span>
<span class="s">      --embedded                       Doesn&#39;t do anything (yet).</span>
<span class="s">      --enable_unix_socket             Enable Unix socket support use_unix_sockets (if --enable_unix_socket=True).</span>
<span class="s">      --https_redirect                 If enabled, a separate listener will be started on port 80 that redirects users to the configured port using HTTPS.</span>
<span class="s">      --js_init                        A JavaScript object (string) that will be used when running GateOne.init() inside index.html.  Example: --js_init=&quot;{scheme: &#39;white&#39;}&quot; would result in GateOne.init({scheme: &#39;white&#39;})</span>
<span class="s">      --keyfile                        Path to the SSL keyfile.  Will be auto-generated if none is provided.</span>
<span class="s">      --kill                           Kill any running Gate One terminal processes including dtach&#39;d processes.</span>
<span class="s">      --locale                         The locale (e.g. pt_PT) Gate One should use for translations.  If not provided, will default to $LANG (which is &#39;en_US&#39; in your current shell), or en_US if not set.</span>
<span class="s">      --new_api_key                    Generate a new API key that an external application can use to embed Gate One.</span>
<span class="s">      --origins                        A semicolon-separated list of origins you wish to allow access to your Gate One server over the WebSocket.  This value must contain the hostnames and FQDNs (e.g. https://foo;https://foo.bar;) users will use to connect to your Gate One server as well as the hostnames/FQDNs of any sites that will be embedding Gate One. Here&#39;s the default on your system: &#39;https://localhost;https://yourhostname&#39;. Alternatively, &#39;*&#39; may be  specified to allow access from anywhere.</span>
<span class="s">      --pam_realm                      Basic auth REALM to display when authenticating clients.  Default: hostname.  Only relevant if PAM authentication is enabled.</span>
<span class="s">      --pam_service                    PAM service to use.  Defaults to &#39;login&#39;. Only relevant if PAM authentication is enabled.</span>
<span class="s">      --pid_file                       Path of the pid file.   Default: /tmp/gateone.pid</span>
<span class="s">      --port                           Run on the given port.</span>
<span class="s">      --session_dir                    Path to the location where session information will be stored.</span>
<span class="s">      --session_logging                If enabled, logs of user sessions will be saved in &lt;user_dir&gt;/&lt;user&gt;/logs.  Default: Enabled</span>
<span class="s">      --session_timeout                Amount of time that a session should be kept alive after the client has logged out.  Accepts &lt;num&gt;X where X could be one of s, m, h, or d for seconds, minutes, hours, and days.  Default is &#39;5d&#39; (5 days).</span>
<span class="s">      --sso_realm                      Kerberos REALM (aka DOMAIN) to use when authenticating clients. Only relevant if Kerberos authentication is enabled.</span>
<span class="s">      --sso_service                    Kerberos service (aka application) to use. Defaults to HTTP. Only relevant if Kerberos authentication is enabled.</span>
<span class="s">      --syslog_facility                Syslog facility to use when logging to syslog (if syslog_session_logging is enabled).  Must be one of: auth, cron, daemon, kern, local0, local1, local2, local3, local4, local5, local6, local7, lpr, mail, news, syslog, user, uucp.  Default: daemon</span>
<span class="s">      --syslog_host                    Remote host to send syslog messages to if syslog_logging is enabled.  Default: None (log to the local syslog daemon directly).  NOTE:  This setting is required on platforms that don&#39;t include Python&#39;s syslog module.</span>
<span class="s">      --syslog_session_logging         If enabled, logs of user sessions will be written to syslog.</span>
<span class="s">      --unix_socket_path               Run on the given socket file.  Default: /tmp/gateone.sock</span>
<span class="s">      --url_prefix                     An optional prefix to place before all Gate One URLs. e.g. &#39;/gateone/&#39;.  Use this if Gate One will be running behind a reverse proxy where you want it to be located at some sub-URL path.</span>
<span class="s">      --user_dir                       Path to the location where user files will be stored.</span>

<span class="s">.. note:: Some of these options (e.g. log_file_prefix) are inherent to the Tornado framework.  You won&#39;t find them anywhere in gateone.py.</span>

<span class="s">File Paths</span>
<span class="s">----------</span>
<span class="s">Gate One stores its files, temporary session information, and persistent user</span>
<span class="s">data in the following locations (Note: Many of these are configurable):</span>

<span class="s">================= ==================================================================================</span>
<span class="s">File/Directory      Description</span>
<span class="s">================= ==================================================================================</span>
<span class="s">authpam.py        Contains the PAM authentication Mixin used by auth.py.</span>
<span class="s">auth.py           Authentication classes.</span>
<span class="s">certificate.pem   The default certificate Gate One will use in SSL communications.</span>
<span class="s">docs/             Gate One&#39;s documentation.</span>
<span class="s">gateone.py        Gate One&#39;s primary executable/script. Also, the file containing this documentation</span>
<span class="s">i18n/             Gate One&#39;s internationalization (i18n) support and locale/translation files.</span>
<span class="s">keyfile.pem       The default private key used with SSL communications.</span>
<span class="s">logviewer.py      A utility to view Gate One session logs.</span>
<span class="s">plugins/          Plugins go here in the form of ./plugins/&lt;plugin name&gt;/&lt;plugin files|directories&gt;</span>
<span class="s">remote_syslog.py  A module that supports sending syslog messages over UDP to a remote syslog host.</span>
<span class="s">server.conf       Gate One&#39;s configuration file.</span>
<span class="s">sso.py            A Kerberos Single Sign-on module for Tornado (used by auth.py)</span>
<span class="s">static/           Non-dynamic files that get served to clients (e.g. gateone.js, gateone.css, etc).</span>
<span class="s">templates/        Tornado template files such as index.html.</span>
<span class="s">terminal.py       A Pure Python terminal emulator module.</span>
<span class="s">termio.py         Terminal input/output control module.</span>
<span class="s">tests/            Various scripts and tools to test Gate One&#39;s functionality.</span>
<span class="s">utils.py          Various supporting functions.</span>
<span class="s">users/            Persistent user data in the form of ./users/&lt;username&gt;/&lt;user-specific files&gt;</span>
<span class="s">users/&lt;user&gt;/logs This is where session logs get stored if session_logging is set.</span>
<span class="s">/tmp/gateone      Temporary session data in the form of /tmp/gateone/&lt;session ID&gt;/&lt;files&gt;</span>
<span class="s">================= ==================================================================================</span>

<span class="s">Running</span>
<span class="s">-------</span>
<span class="s">Executing Gate One is as simple as:</span>

<span class="s">.. ansi-block::</span>

<span class="s">    </span><span class="se">\x1b</span><span class="s">[1;31mroot</span><span class="se">\x1b</span><span class="s">[0m@host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m ./gateone.py</span>

<span class="s">.. note:: By default Gate One will run on port 443 which requires root on most systems.  Use `--port=(something higher than 1024)` for non-root users.</span>

<span class="s">Plugins</span>
<span class="s">-------</span>
<span class="s">Gate One includes support for any combination of the following types of plugins:</span>

<span class="s"> * Python</span>
<span class="s"> * JavaScript</span>
<span class="s"> * CSS</span>

<span class="s">Python plugins can integrate with Gate One in three ways:</span>

<span class="s"> * Adding or overriding tornado.web.RequestHandlers (with a given regex).</span>
<span class="s"> * Adding or overriding methods (aka &quot;commands&quot;) in ApplicationWebSocket.</span>
<span class="s"> * Adding special plugin-specific escape sequence handlers (see the plugin development documentation for details on what/how these are/work).</span>

<span class="s">JavaScript plugins will be added to the &lt;body&gt; tag of Gate One&#39;s base index.html</span>
<span class="s">template by way of a single file (`{{gateone_js}}` below) that is the</span>
<span class="s">concatenation of all plugins&#39; JS templates:</span>

<span class="s">.. code-block:: html</span>

<span class="s">    &lt;script type=&quot;text/javascript&quot; src=&quot;{{gateone_js}}&quot;&gt;&lt;/script&gt;</span>

<span class="s">CSS plugins are similar to JavaScript but instead of being appended to the</span>
<span class="s">&lt;body&gt; they are added to the &lt;head&gt; by way of a WebSocket download and some</span>
<span class="s">fancy JavaScript inside of gateone.js:</span>

<span class="s">.. code-block:: javascript</span>

<span class="s">    CSSPluginAction: function(url) {</span>
<span class="s">        // Loads the CSS for a given plugin by adding a &lt;link&gt; tag to the &lt;head&gt;</span>
<span class="s">        var queries = url.split(&#39;?&#39;)[1].split(&#39;&amp;&#39;), // So we can parse out the plugin name and the template</span>
<span class="s">            plugin = queries[0].split(&#39;=&#39;)[1],</span>
<span class="s">            file = queries[1].split(&#39;=&#39;)[1].split(&#39;.&#39;)[0];</span>
<span class="s">        // The /cssrender method needs the prefix and the container</span>
<span class="s">        url = url + &#39;&amp;container=&#39; + GateOne.prefs.goDiv.substring(1);</span>
<span class="s">        url = url + &#39;&amp;prefix=&#39; + GateOne.prefs.prefix;</span>
<span class="s">        url = GateOne.prefs.url + url.substring(1);</span>
<span class="s">        GateOne.Utils.loadCSS(url, plugin+&#39;_&#39;+file);</span>
<span class="s">    }</span>

<span class="s">There are also hooks throughout Gate One&#39;s code for plugins to add or override</span>
<span class="s">Gate One&#39;s functionality.  Documentation on how to write plugins can be found in</span>
<span class="s">the Plugin Development docs.  From the perspective of gateone.py, it performs</span>
<span class="s">the following tasks in relation to plugins:</span>

<span class="s"> * Imports Python plugins and connects their hooks.</span>
<span class="s"> * Creates symbolic links inside ./static/ that point to each plugin&#39;s respective /static/ directory and serves them to clients.</span>
<span class="s"> * Serves the index.html that includes plugins&#39; respective .js and .css files.</span>

<span class="s">Class Docstrings</span>
<span class="s">================</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="c"># Standard library modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">pty</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="c"># Tornado modules (yeah, we use all this stuff)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tornado.httpserver</span>
    <span class="kn">import</span> <span class="nn">tornado.ioloop</span>
    <span class="kn">import</span> <span class="nn">tornado.options</span>
    <span class="kn">import</span> <span class="nn">tornado.web</span>
    <span class="kn">import</span> <span class="nn">tornado.auth</span>
    <span class="kn">import</span> <span class="nn">tornado.template</span>
    <span class="kn">import</span> <span class="nn">tornado.netutil</span>
    <span class="kn">from</span> <span class="nn">tornado.websocket</span> <span class="kn">import</span> <span class="n">WebSocketHandler</span>
    <span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="kn">import</span> <span class="n">json_decode</span>
    <span class="kn">from</span> <span class="nn">tornado.options</span> <span class="kn">import</span> <span class="n">define</span><span class="p">,</span> <span class="n">options</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">locale</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">tornado_version</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">version_info</span> <span class="k">as</span> <span class="n">tornado_version_info</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[31;1mERROR:</span><span class="se">\x1b</span><span class="s">[0m Gate One requires the Tornado framework.  &quot;</span>
          <span class="s">&quot;You probably want to run something like, </span><span class="se">\x1b</span><span class="s">[1m&#39;pip install &quot;</span>
          <span class="s">&quot;--upgrade tornado&#39;</span><span class="se">\x1b</span><span class="s">[0m.&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">tornado_version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">tornado_version_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[31;1mERROR:</span><span class="se">\x1b</span><span class="s">[0m Gate One requires version 2.2+ of the &quot;</span>
            <span class="s">&quot;Tornado framework.  The installed version of Tornado is version &quot;</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">tornado_version</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># We want this turned on right away</span>
<span class="n">tornado</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">enable_pretty_logging</span><span class="p">()</span>

<span class="c"># Our own modules</span>
<span class="kn">from</span> <span class="nn">auth</span> <span class="kn">import</span> <span class="n">NullAuthHandler</span><span class="p">,</span> <span class="n">KerberosAuthHandler</span><span class="p">,</span> <span class="n">GoogleAuthHandler</span>
<span class="kn">from</span> <span class="nn">auth</span> <span class="kn">import</span> <span class="n">APIAuthHandler</span><span class="p">,</span> <span class="n">SSLAuthHandler</span><span class="p">,</span> <span class="n">PAMAuthHandler</span>
<span class="kn">from</span> <span class="nn">auth</span> <span class="kn">import</span> <span class="n">require</span><span class="p">,</span> <span class="n">authenticated</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">generate_session_id</span><span class="p">,</span> <span class="n">mkdir_p</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">gen_self_signed_ssl</span><span class="p">,</span> <span class="n">killall</span><span class="p">,</span> <span class="n">get_plugins</span><span class="p">,</span> <span class="n">load_modules</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">merge_handlers</span><span class="p">,</span> <span class="n">none_fix</span><span class="p">,</span> <span class="n">convert_to_timedelta</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">FACILITIES</span><span class="p">,</span> <span class="n">json_encode</span><span class="p">,</span> <span class="n">recursive_chown</span><span class="p">,</span> <span class="n">ChownError</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">write_pid</span><span class="p">,</span> <span class="n">read_pid</span><span class="p">,</span> <span class="n">remove_pid</span><span class="p">,</span> <span class="n">drop_privileges</span><span class="p">,</span> <span class="n">minify</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">check_write_permissions</span><span class="p">,</span> <span class="n">get_applications</span><span class="p">,</span> <span class="n">get_settings</span>

<span class="c"># Setup the locale functions before anything else</span>
<span class="n">locale</span><span class="o">.</span><span class="n">set_default_locale</span><span class="p">(</span><span class="s">&#39;en_US&#39;</span><span class="p">)</span>
<span class="n">user_locale</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Replaced with the actual user locale object in __main__</span>
<div class="viewcode-block" id="_"><a class="viewcode-back" href="../Developer/gateone.html#gateone._">[docs]</a><span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps user_locale.translate so we can .encode(&#39;UTF-8&#39;) when writing to</span>
<span class="sd">    stdout.  This function will get overridden by the regular translate()</span>
<span class="sd">    function in __main__</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">user_locale</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user_locale</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>

<span class="c"># Globals</span></div>
<span class="n">SESSIONS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># We store the crux of most session info here</span>
<span class="n">CMD</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Will be overwritten by options.command</span>
<span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c"># Gets overridden by options.session_timeout</span>
<span class="c"># WATCHER be replaced with a tornado.ioloop.PeriodicCallback that watches for</span>
<span class="c"># sessions that have timed out and takes care of cleaning them up.</span>
<span class="n">WATCHER</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">GATEONE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">FILE_CACHE</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c"># PERSIST is a generic place for applications and plugins to store stuff in a</span>
<span class="c"># way that lasts between page loads.  USE RESPONSIBLY.</span>
<span class="n">PERSIST</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">APPLICATIONS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">PLUGINS</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">))</span>
<span class="n">PLUGIN_WS_CMDS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Gives plugins the ability to extend/enhance ApplicationWebSocket</span>
<span class="n">PLUGIN_HOOKS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Gives plugins the ability to hook into various things.</span>
<span class="n">PLUGIN_AUTH_HOOKS</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># For plugins to register functions to be called after a</span>
                       <span class="c"># user successfully authenticates</span>
<span class="n">PLUGIN_ENV_HOOKS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Allows plugins to add environment variables that will be</span>
                      <span class="c"># available to all executed commands.</span>
<span class="c"># Gate One registers a handler for for terminal.py&#39;s CALLBACK_OPT special escape</span>
<span class="c"># sequence callback.  Whenever this escape sequence is encountered, Gate One</span>
<span class="c"># will parse the sequence&#39;s contained characters looking for the following</span>
<span class="c"># format:</span>
<span class="c">#   &lt;plugin name&gt;|&lt;whatever&gt;</span>
<span class="c"># The &lt;whatever&gt; part will be passed to any plugin matching &lt;plugin name&gt; if the</span>
<span class="c"># plugin has &#39;Escape&#39;: &lt;function&gt; registered in its hooks.</span>
<span class="n">PLUGIN_ESC_HANDLERS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c"># This is used to store plugin terminal hooks that are called when a new</span>
<span class="c"># terminal is created (so a plugin could override/attach callbacks to the</span>
<span class="c"># multiplex or terminal emulator instances).  NOTE: This is specifically for</span>
<span class="c"># adding to the terminal emulator&#39;s CALLBACK_* capability.  For modifying the</span>
<span class="c"># terminal emulator instance directly see PLUGIN_NEW_TERM_HOOKS.</span>
<span class="n">PLUGIN_TERM_HOOKS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c"># The NEW_TERM hooks are called at the end of ApplicationWebSocket.new_terminal()</span>
<span class="c"># with &#39;self&#39; and the new instance of the terminal emulator as the only</span>
<span class="c"># arguments.  It&#39;s a more DIY/generic version of PLUGIN_TERM_HOOKS.</span>
<span class="n">PLUGIN_NEW_TERM_HOOKS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c"># &#39;Command&#39; hooks get called before a new Multiplex instance is created inside</span>
<span class="c"># of ApplicationWebSocket.new_multiplex().  They are passed the &#39;command&#39; and must</span>
<span class="c"># return a string that will be used as the replacement &#39;command&#39;.  This allows</span>
<span class="c"># plugin authors to modify the configured &#39;command&#39; before it is executed</span>
<span class="n">PLUGIN_COMMAND_HOOKS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c"># &#39;Multiplex&#39; hooks get called at the end of ApplicationWebSocket.new_multiplex()</span>
<span class="c"># with the instance of ApplicationWebSocket and the new instance of Multiplex as</span>
<span class="c"># the only arguments, respectively.</span>
<span class="n">PLUGIN_NEW_MULTIPLEX_HOOKS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c"># Secondary locale setup</span>
<span class="n">locale_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;i18n&#39;</span><span class="p">)</span>
<span class="n">locale</span><span class="o">.</span><span class="n">load_gettext_translations</span><span class="p">(</span><span class="n">locale_dir</span><span class="p">,</span> <span class="s">&#39;gateone&#39;</span><span class="p">)</span>
<span class="c"># NOTE: The locale gets set in __main__</span>

<span class="c"># A HUGE thank you to Micah Elliott (http://MicahElliott.com) for posting these</span>
<span class="c"># values here: https://gist.github.com/719710</span>
<span class="c"># This gets used by StyleHandler to generate the CSS that supports 256-colors:</span>
<span class="n">COLORS_256</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># 8-color equivalents:</span>
     <span class="mi">0</span><span class="p">:</span> <span class="s">&quot;000000&quot;</span><span class="p">,</span>
     <span class="mi">1</span><span class="p">:</span> <span class="s">&quot;800000&quot;</span><span class="p">,</span>
     <span class="mi">2</span><span class="p">:</span> <span class="s">&quot;008000&quot;</span><span class="p">,</span>
     <span class="mi">3</span><span class="p">:</span> <span class="s">&quot;808000&quot;</span><span class="p">,</span>
     <span class="mi">4</span><span class="p">:</span> <span class="s">&quot;000080&quot;</span><span class="p">,</span>
     <span class="mi">5</span><span class="p">:</span> <span class="s">&quot;800080&quot;</span><span class="p">,</span>
     <span class="mi">6</span><span class="p">:</span> <span class="s">&quot;008080&quot;</span><span class="p">,</span>
     <span class="mi">7</span><span class="p">:</span> <span class="s">&quot;c0c0c0&quot;</span><span class="p">,</span>
    <span class="c"># &quot;Bright&quot; (16-color) equivalents:</span>
     <span class="mi">8</span><span class="p">:</span> <span class="s">&quot;808080&quot;</span><span class="p">,</span>
     <span class="mi">9</span><span class="p">:</span> <span class="s">&quot;ff0000&quot;</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">:</span> <span class="s">&quot;00ff00&quot;</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s">&quot;ffff00&quot;</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s">&quot;0000ff&quot;</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">:</span> <span class="s">&quot;ff00ff&quot;</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">:</span> <span class="s">&quot;00ffff&quot;</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s">&quot;ffffff&quot;</span><span class="p">,</span>
    <span class="c"># The rest of the 256-colors:</span>
    <span class="mi">16</span><span class="p">:</span> <span class="s">&quot;000000&quot;</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">:</span> <span class="s">&quot;00005f&quot;</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s">&quot;000087&quot;</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">:</span> <span class="s">&quot;0000af&quot;</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">:</span> <span class="s">&quot;0000d7&quot;</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">:</span> <span class="s">&quot;0000ff&quot;</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">:</span> <span class="s">&quot;005f00&quot;</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">:</span> <span class="s">&quot;005f5f&quot;</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">:</span> <span class="s">&quot;005f87&quot;</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">:</span> <span class="s">&quot;005faf&quot;</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">:</span> <span class="s">&quot;005fd7&quot;</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">:</span> <span class="s">&quot;005fff&quot;</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">:</span> <span class="s">&quot;008700&quot;</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">:</span> <span class="s">&quot;00875f&quot;</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">:</span> <span class="s">&quot;008787&quot;</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">:</span> <span class="s">&quot;0087af&quot;</span><span class="p">,</span>
    <span class="mi">32</span><span class="p">:</span> <span class="s">&quot;0087d7&quot;</span><span class="p">,</span>
    <span class="mi">33</span><span class="p">:</span> <span class="s">&quot;0087ff&quot;</span><span class="p">,</span>
    <span class="mi">34</span><span class="p">:</span> <span class="s">&quot;00af00&quot;</span><span class="p">,</span>
    <span class="mi">35</span><span class="p">:</span> <span class="s">&quot;00af5f&quot;</span><span class="p">,</span>
    <span class="mi">36</span><span class="p">:</span> <span class="s">&quot;00af87&quot;</span><span class="p">,</span>
    <span class="mi">37</span><span class="p">:</span> <span class="s">&quot;00afaf&quot;</span><span class="p">,</span>
    <span class="mi">38</span><span class="p">:</span> <span class="s">&quot;00afd7&quot;</span><span class="p">,</span>
    <span class="mi">39</span><span class="p">:</span> <span class="s">&quot;00afff&quot;</span><span class="p">,</span>
    <span class="mi">40</span><span class="p">:</span> <span class="s">&quot;00d700&quot;</span><span class="p">,</span>
    <span class="mi">41</span><span class="p">:</span> <span class="s">&quot;00d75f&quot;</span><span class="p">,</span>
    <span class="mi">42</span><span class="p">:</span> <span class="s">&quot;00d787&quot;</span><span class="p">,</span>
    <span class="mi">43</span><span class="p">:</span> <span class="s">&quot;00d7af&quot;</span><span class="p">,</span>
    <span class="mi">44</span><span class="p">:</span> <span class="s">&quot;00d7d7&quot;</span><span class="p">,</span>
    <span class="mi">45</span><span class="p">:</span> <span class="s">&quot;00d7ff&quot;</span><span class="p">,</span>
    <span class="mi">46</span><span class="p">:</span> <span class="s">&quot;00ff00&quot;</span><span class="p">,</span>
    <span class="mi">47</span><span class="p">:</span> <span class="s">&quot;00ff5f&quot;</span><span class="p">,</span>
    <span class="mi">48</span><span class="p">:</span> <span class="s">&quot;00ff87&quot;</span><span class="p">,</span>
    <span class="mi">49</span><span class="p">:</span> <span class="s">&quot;00ffaf&quot;</span><span class="p">,</span>
    <span class="mi">50</span><span class="p">:</span> <span class="s">&quot;00ffd7&quot;</span><span class="p">,</span>
    <span class="mi">51</span><span class="p">:</span> <span class="s">&quot;00ffff&quot;</span><span class="p">,</span>
    <span class="mi">52</span><span class="p">:</span> <span class="s">&quot;5f0000&quot;</span><span class="p">,</span>
    <span class="mi">53</span><span class="p">:</span> <span class="s">&quot;5f005f&quot;</span><span class="p">,</span>
    <span class="mi">54</span><span class="p">:</span> <span class="s">&quot;5f0087&quot;</span><span class="p">,</span>
    <span class="mi">55</span><span class="p">:</span> <span class="s">&quot;5f00af&quot;</span><span class="p">,</span>
    <span class="mi">56</span><span class="p">:</span> <span class="s">&quot;5f00d7&quot;</span><span class="p">,</span>
    <span class="mi">57</span><span class="p">:</span> <span class="s">&quot;5f00ff&quot;</span><span class="p">,</span>
    <span class="mi">58</span><span class="p">:</span> <span class="s">&quot;5f5f00&quot;</span><span class="p">,</span>
    <span class="mi">59</span><span class="p">:</span> <span class="s">&quot;5f5f5f&quot;</span><span class="p">,</span>
    <span class="mi">60</span><span class="p">:</span> <span class="s">&quot;5f5f87&quot;</span><span class="p">,</span>
    <span class="mi">61</span><span class="p">:</span> <span class="s">&quot;5f5faf&quot;</span><span class="p">,</span>
    <span class="mi">62</span><span class="p">:</span> <span class="s">&quot;5f5fd7&quot;</span><span class="p">,</span>
    <span class="mi">63</span><span class="p">:</span> <span class="s">&quot;5f5fff&quot;</span><span class="p">,</span>
    <span class="mi">64</span><span class="p">:</span> <span class="s">&quot;5f8700&quot;</span><span class="p">,</span>
    <span class="mi">65</span><span class="p">:</span> <span class="s">&quot;5f875f&quot;</span><span class="p">,</span>
    <span class="mi">66</span><span class="p">:</span> <span class="s">&quot;5f8787&quot;</span><span class="p">,</span>
    <span class="mi">67</span><span class="p">:</span> <span class="s">&quot;5f87af&quot;</span><span class="p">,</span>
    <span class="mi">68</span><span class="p">:</span> <span class="s">&quot;5f87d7&quot;</span><span class="p">,</span>
    <span class="mi">69</span><span class="p">:</span> <span class="s">&quot;5f87ff&quot;</span><span class="p">,</span>
    <span class="mi">70</span><span class="p">:</span> <span class="s">&quot;5faf00&quot;</span><span class="p">,</span>
    <span class="mi">71</span><span class="p">:</span> <span class="s">&quot;5faf5f&quot;</span><span class="p">,</span>
    <span class="mi">72</span><span class="p">:</span> <span class="s">&quot;5faf87&quot;</span><span class="p">,</span>
    <span class="mi">73</span><span class="p">:</span> <span class="s">&quot;5fafaf&quot;</span><span class="p">,</span>
    <span class="mi">74</span><span class="p">:</span> <span class="s">&quot;5fafd7&quot;</span><span class="p">,</span>
    <span class="mi">75</span><span class="p">:</span> <span class="s">&quot;5fafff&quot;</span><span class="p">,</span>
    <span class="mi">76</span><span class="p">:</span> <span class="s">&quot;5fd700&quot;</span><span class="p">,</span>
    <span class="mi">77</span><span class="p">:</span> <span class="s">&quot;5fd75f&quot;</span><span class="p">,</span>
    <span class="mi">78</span><span class="p">:</span> <span class="s">&quot;5fd787&quot;</span><span class="p">,</span>
    <span class="mi">79</span><span class="p">:</span> <span class="s">&quot;5fd7af&quot;</span><span class="p">,</span>
    <span class="mi">80</span><span class="p">:</span> <span class="s">&quot;5fd7d7&quot;</span><span class="p">,</span>
    <span class="mi">81</span><span class="p">:</span> <span class="s">&quot;5fd7ff&quot;</span><span class="p">,</span>
    <span class="mi">82</span><span class="p">:</span> <span class="s">&quot;5fff00&quot;</span><span class="p">,</span>
    <span class="mi">83</span><span class="p">:</span> <span class="s">&quot;5fff5f&quot;</span><span class="p">,</span>
    <span class="mi">84</span><span class="p">:</span> <span class="s">&quot;5fff87&quot;</span><span class="p">,</span>
    <span class="mi">85</span><span class="p">:</span> <span class="s">&quot;5fffaf&quot;</span><span class="p">,</span>
    <span class="mi">86</span><span class="p">:</span> <span class="s">&quot;5fffd7&quot;</span><span class="p">,</span>
    <span class="mi">87</span><span class="p">:</span> <span class="s">&quot;5fffff&quot;</span><span class="p">,</span>
    <span class="mi">88</span><span class="p">:</span> <span class="s">&quot;870000&quot;</span><span class="p">,</span>
    <span class="mi">89</span><span class="p">:</span> <span class="s">&quot;87005f&quot;</span><span class="p">,</span>
    <span class="mi">90</span><span class="p">:</span> <span class="s">&quot;870087&quot;</span><span class="p">,</span>
    <span class="mi">91</span><span class="p">:</span> <span class="s">&quot;8700af&quot;</span><span class="p">,</span>
    <span class="mi">92</span><span class="p">:</span> <span class="s">&quot;8700d7&quot;</span><span class="p">,</span>
    <span class="mi">93</span><span class="p">:</span> <span class="s">&quot;8700ff&quot;</span><span class="p">,</span>
    <span class="mi">94</span><span class="p">:</span> <span class="s">&quot;875f00&quot;</span><span class="p">,</span>
    <span class="mi">95</span><span class="p">:</span> <span class="s">&quot;875f5f&quot;</span><span class="p">,</span>
    <span class="mi">96</span><span class="p">:</span> <span class="s">&quot;875f87&quot;</span><span class="p">,</span>
    <span class="mi">97</span><span class="p">:</span> <span class="s">&quot;875faf&quot;</span><span class="p">,</span>
    <span class="mi">98</span><span class="p">:</span> <span class="s">&quot;875fd7&quot;</span><span class="p">,</span>
    <span class="mi">99</span><span class="p">:</span> <span class="s">&quot;875fff&quot;</span><span class="p">,</span>
    <span class="mi">100</span><span class="p">:</span> <span class="s">&quot;878700&quot;</span><span class="p">,</span>
    <span class="mi">101</span><span class="p">:</span> <span class="s">&quot;87875f&quot;</span><span class="p">,</span>
    <span class="mi">102</span><span class="p">:</span> <span class="s">&quot;878787&quot;</span><span class="p">,</span>
    <span class="mi">103</span><span class="p">:</span> <span class="s">&quot;8787af&quot;</span><span class="p">,</span>
    <span class="mi">104</span><span class="p">:</span> <span class="s">&quot;8787d7&quot;</span><span class="p">,</span>
    <span class="mi">105</span><span class="p">:</span> <span class="s">&quot;8787ff&quot;</span><span class="p">,</span>
    <span class="mi">106</span><span class="p">:</span> <span class="s">&quot;87af00&quot;</span><span class="p">,</span>
    <span class="mi">107</span><span class="p">:</span> <span class="s">&quot;87af5f&quot;</span><span class="p">,</span>
    <span class="mi">108</span><span class="p">:</span> <span class="s">&quot;87af87&quot;</span><span class="p">,</span>
    <span class="mi">109</span><span class="p">:</span> <span class="s">&quot;87afaf&quot;</span><span class="p">,</span>
    <span class="mi">110</span><span class="p">:</span> <span class="s">&quot;87afd7&quot;</span><span class="p">,</span>
    <span class="mi">111</span><span class="p">:</span> <span class="s">&quot;87afff&quot;</span><span class="p">,</span>
    <span class="mi">112</span><span class="p">:</span> <span class="s">&quot;87d700&quot;</span><span class="p">,</span>
    <span class="mi">113</span><span class="p">:</span> <span class="s">&quot;87d75f&quot;</span><span class="p">,</span>
    <span class="mi">114</span><span class="p">:</span> <span class="s">&quot;87d787&quot;</span><span class="p">,</span>
    <span class="mi">115</span><span class="p">:</span> <span class="s">&quot;87d7af&quot;</span><span class="p">,</span>
    <span class="mi">116</span><span class="p">:</span> <span class="s">&quot;87d7d7&quot;</span><span class="p">,</span>
    <span class="mi">117</span><span class="p">:</span> <span class="s">&quot;87d7ff&quot;</span><span class="p">,</span>
    <span class="mi">118</span><span class="p">:</span> <span class="s">&quot;87ff00&quot;</span><span class="p">,</span>
    <span class="mi">119</span><span class="p">:</span> <span class="s">&quot;87ff5f&quot;</span><span class="p">,</span>
    <span class="mi">120</span><span class="p">:</span> <span class="s">&quot;87ff87&quot;</span><span class="p">,</span>
    <span class="mi">121</span><span class="p">:</span> <span class="s">&quot;87ffaf&quot;</span><span class="p">,</span>
    <span class="mi">122</span><span class="p">:</span> <span class="s">&quot;87ffd7&quot;</span><span class="p">,</span>
    <span class="mi">123</span><span class="p">:</span> <span class="s">&quot;87ffff&quot;</span><span class="p">,</span>
    <span class="mi">124</span><span class="p">:</span> <span class="s">&quot;af0000&quot;</span><span class="p">,</span>
    <span class="mi">125</span><span class="p">:</span> <span class="s">&quot;af005f&quot;</span><span class="p">,</span>
    <span class="mi">126</span><span class="p">:</span> <span class="s">&quot;af0087&quot;</span><span class="p">,</span>
    <span class="mi">127</span><span class="p">:</span> <span class="s">&quot;af00af&quot;</span><span class="p">,</span>
    <span class="mi">128</span><span class="p">:</span> <span class="s">&quot;af00d7&quot;</span><span class="p">,</span>
    <span class="mi">129</span><span class="p">:</span> <span class="s">&quot;af00ff&quot;</span><span class="p">,</span>
    <span class="mi">130</span><span class="p">:</span> <span class="s">&quot;af5f00&quot;</span><span class="p">,</span>
    <span class="mi">131</span><span class="p">:</span> <span class="s">&quot;af5f5f&quot;</span><span class="p">,</span>
    <span class="mi">132</span><span class="p">:</span> <span class="s">&quot;af5f87&quot;</span><span class="p">,</span>
    <span class="mi">133</span><span class="p">:</span> <span class="s">&quot;af5faf&quot;</span><span class="p">,</span>
    <span class="mi">134</span><span class="p">:</span> <span class="s">&quot;af5fd7&quot;</span><span class="p">,</span>
    <span class="mi">135</span><span class="p">:</span> <span class="s">&quot;af5fff&quot;</span><span class="p">,</span>
    <span class="mi">136</span><span class="p">:</span> <span class="s">&quot;af8700&quot;</span><span class="p">,</span>
    <span class="mi">137</span><span class="p">:</span> <span class="s">&quot;af875f&quot;</span><span class="p">,</span>
    <span class="mi">138</span><span class="p">:</span> <span class="s">&quot;af8787&quot;</span><span class="p">,</span>
    <span class="mi">139</span><span class="p">:</span> <span class="s">&quot;af87af&quot;</span><span class="p">,</span>
    <span class="mi">140</span><span class="p">:</span> <span class="s">&quot;af87d7&quot;</span><span class="p">,</span>
    <span class="mi">141</span><span class="p">:</span> <span class="s">&quot;af87ff&quot;</span><span class="p">,</span>
    <span class="mi">142</span><span class="p">:</span> <span class="s">&quot;afaf00&quot;</span><span class="p">,</span>
    <span class="mi">143</span><span class="p">:</span> <span class="s">&quot;afaf5f&quot;</span><span class="p">,</span>
    <span class="mi">144</span><span class="p">:</span> <span class="s">&quot;afaf87&quot;</span><span class="p">,</span>
    <span class="mi">145</span><span class="p">:</span> <span class="s">&quot;afafaf&quot;</span><span class="p">,</span>
    <span class="mi">146</span><span class="p">:</span> <span class="s">&quot;afafd7&quot;</span><span class="p">,</span>
    <span class="mi">147</span><span class="p">:</span> <span class="s">&quot;afafff&quot;</span><span class="p">,</span>
    <span class="mi">148</span><span class="p">:</span> <span class="s">&quot;afd700&quot;</span><span class="p">,</span>
    <span class="mi">149</span><span class="p">:</span> <span class="s">&quot;afd75f&quot;</span><span class="p">,</span>
    <span class="mi">150</span><span class="p">:</span> <span class="s">&quot;afd787&quot;</span><span class="p">,</span>
    <span class="mi">151</span><span class="p">:</span> <span class="s">&quot;afd7af&quot;</span><span class="p">,</span>
    <span class="mi">152</span><span class="p">:</span> <span class="s">&quot;afd7d7&quot;</span><span class="p">,</span>
    <span class="mi">153</span><span class="p">:</span> <span class="s">&quot;afd7ff&quot;</span><span class="p">,</span>
    <span class="mi">154</span><span class="p">:</span> <span class="s">&quot;afff00&quot;</span><span class="p">,</span>
    <span class="mi">155</span><span class="p">:</span> <span class="s">&quot;afff5f&quot;</span><span class="p">,</span>
    <span class="mi">156</span><span class="p">:</span> <span class="s">&quot;afff87&quot;</span><span class="p">,</span>
    <span class="mi">157</span><span class="p">:</span> <span class="s">&quot;afffaf&quot;</span><span class="p">,</span>
    <span class="mi">158</span><span class="p">:</span> <span class="s">&quot;afffd7&quot;</span><span class="p">,</span>
    <span class="mi">159</span><span class="p">:</span> <span class="s">&quot;afffff&quot;</span><span class="p">,</span>
    <span class="mi">160</span><span class="p">:</span> <span class="s">&quot;d70000&quot;</span><span class="p">,</span>
    <span class="mi">161</span><span class="p">:</span> <span class="s">&quot;d7005f&quot;</span><span class="p">,</span>
    <span class="mi">162</span><span class="p">:</span> <span class="s">&quot;d70087&quot;</span><span class="p">,</span>
    <span class="mi">163</span><span class="p">:</span> <span class="s">&quot;d700af&quot;</span><span class="p">,</span>
    <span class="mi">164</span><span class="p">:</span> <span class="s">&quot;d700d7&quot;</span><span class="p">,</span>
    <span class="mi">165</span><span class="p">:</span> <span class="s">&quot;d700ff&quot;</span><span class="p">,</span>
    <span class="mi">166</span><span class="p">:</span> <span class="s">&quot;d75f00&quot;</span><span class="p">,</span>
    <span class="mi">167</span><span class="p">:</span> <span class="s">&quot;d75f5f&quot;</span><span class="p">,</span>
    <span class="mi">168</span><span class="p">:</span> <span class="s">&quot;d75f87&quot;</span><span class="p">,</span>
    <span class="mi">169</span><span class="p">:</span> <span class="s">&quot;d75faf&quot;</span><span class="p">,</span>
    <span class="mi">170</span><span class="p">:</span> <span class="s">&quot;d75fd7&quot;</span><span class="p">,</span>
    <span class="mi">171</span><span class="p">:</span> <span class="s">&quot;d75fff&quot;</span><span class="p">,</span>
    <span class="mi">172</span><span class="p">:</span> <span class="s">&quot;d78700&quot;</span><span class="p">,</span>
    <span class="mi">173</span><span class="p">:</span> <span class="s">&quot;d7875f&quot;</span><span class="p">,</span>
    <span class="mi">174</span><span class="p">:</span> <span class="s">&quot;d78787&quot;</span><span class="p">,</span>
    <span class="mi">175</span><span class="p">:</span> <span class="s">&quot;d787af&quot;</span><span class="p">,</span>
    <span class="mi">176</span><span class="p">:</span> <span class="s">&quot;d787d7&quot;</span><span class="p">,</span>
    <span class="mi">177</span><span class="p">:</span> <span class="s">&quot;d787ff&quot;</span><span class="p">,</span>
    <span class="mi">178</span><span class="p">:</span> <span class="s">&quot;d7af00&quot;</span><span class="p">,</span>
    <span class="mi">179</span><span class="p">:</span> <span class="s">&quot;d7af5f&quot;</span><span class="p">,</span>
    <span class="mi">180</span><span class="p">:</span> <span class="s">&quot;d7af87&quot;</span><span class="p">,</span>
    <span class="mi">181</span><span class="p">:</span> <span class="s">&quot;d7afaf&quot;</span><span class="p">,</span>
    <span class="mi">182</span><span class="p">:</span> <span class="s">&quot;d7afd7&quot;</span><span class="p">,</span>
    <span class="mi">183</span><span class="p">:</span> <span class="s">&quot;d7afff&quot;</span><span class="p">,</span>
    <span class="mi">184</span><span class="p">:</span> <span class="s">&quot;d7d700&quot;</span><span class="p">,</span>
    <span class="mi">185</span><span class="p">:</span> <span class="s">&quot;d7d75f&quot;</span><span class="p">,</span>
    <span class="mi">186</span><span class="p">:</span> <span class="s">&quot;d7d787&quot;</span><span class="p">,</span>
    <span class="mi">187</span><span class="p">:</span> <span class="s">&quot;d7d7af&quot;</span><span class="p">,</span>
    <span class="mi">188</span><span class="p">:</span> <span class="s">&quot;d7d7d7&quot;</span><span class="p">,</span>
    <span class="mi">189</span><span class="p">:</span> <span class="s">&quot;d7d7ff&quot;</span><span class="p">,</span>
    <span class="mi">190</span><span class="p">:</span> <span class="s">&quot;d7ff00&quot;</span><span class="p">,</span>
    <span class="mi">191</span><span class="p">:</span> <span class="s">&quot;d7ff5f&quot;</span><span class="p">,</span>
    <span class="mi">192</span><span class="p">:</span> <span class="s">&quot;d7ff87&quot;</span><span class="p">,</span>
    <span class="mi">193</span><span class="p">:</span> <span class="s">&quot;d7ffaf&quot;</span><span class="p">,</span>
    <span class="mi">194</span><span class="p">:</span> <span class="s">&quot;d7ffd7&quot;</span><span class="p">,</span>
    <span class="mi">195</span><span class="p">:</span> <span class="s">&quot;d7ffff&quot;</span><span class="p">,</span>
    <span class="mi">196</span><span class="p">:</span> <span class="s">&quot;ff0000&quot;</span><span class="p">,</span>
    <span class="mi">197</span><span class="p">:</span> <span class="s">&quot;ff005f&quot;</span><span class="p">,</span>
    <span class="mi">198</span><span class="p">:</span> <span class="s">&quot;ff0087&quot;</span><span class="p">,</span>
    <span class="mi">199</span><span class="p">:</span> <span class="s">&quot;ff00af&quot;</span><span class="p">,</span>
    <span class="mi">200</span><span class="p">:</span> <span class="s">&quot;ff00d7&quot;</span><span class="p">,</span>
    <span class="mi">201</span><span class="p">:</span> <span class="s">&quot;ff00ff&quot;</span><span class="p">,</span>
    <span class="mi">202</span><span class="p">:</span> <span class="s">&quot;ff5f00&quot;</span><span class="p">,</span>
    <span class="mi">203</span><span class="p">:</span> <span class="s">&quot;ff5f5f&quot;</span><span class="p">,</span>
    <span class="mi">204</span><span class="p">:</span> <span class="s">&quot;ff5f87&quot;</span><span class="p">,</span>
    <span class="mi">205</span><span class="p">:</span> <span class="s">&quot;ff5faf&quot;</span><span class="p">,</span>
    <span class="mi">206</span><span class="p">:</span> <span class="s">&quot;ff5fd7&quot;</span><span class="p">,</span>
    <span class="mi">207</span><span class="p">:</span> <span class="s">&quot;ff5fff&quot;</span><span class="p">,</span>
    <span class="mi">208</span><span class="p">:</span> <span class="s">&quot;ff8700&quot;</span><span class="p">,</span>
    <span class="mi">209</span><span class="p">:</span> <span class="s">&quot;ff875f&quot;</span><span class="p">,</span>
    <span class="mi">210</span><span class="p">:</span> <span class="s">&quot;ff8787&quot;</span><span class="p">,</span>
    <span class="mi">211</span><span class="p">:</span> <span class="s">&quot;ff87af&quot;</span><span class="p">,</span>
    <span class="mi">212</span><span class="p">:</span> <span class="s">&quot;ff87d7&quot;</span><span class="p">,</span>
    <span class="mi">213</span><span class="p">:</span> <span class="s">&quot;ff87ff&quot;</span><span class="p">,</span>
    <span class="mi">214</span><span class="p">:</span> <span class="s">&quot;ffaf00&quot;</span><span class="p">,</span>
    <span class="mi">215</span><span class="p">:</span> <span class="s">&quot;ffaf5f&quot;</span><span class="p">,</span>
    <span class="mi">216</span><span class="p">:</span> <span class="s">&quot;ffaf87&quot;</span><span class="p">,</span>
    <span class="mi">217</span><span class="p">:</span> <span class="s">&quot;ffafaf&quot;</span><span class="p">,</span>
    <span class="mi">218</span><span class="p">:</span> <span class="s">&quot;ffafd7&quot;</span><span class="p">,</span>
    <span class="mi">219</span><span class="p">:</span> <span class="s">&quot;ffafff&quot;</span><span class="p">,</span>
    <span class="mi">220</span><span class="p">:</span> <span class="s">&quot;ffd700&quot;</span><span class="p">,</span>
    <span class="mi">221</span><span class="p">:</span> <span class="s">&quot;ffd75f&quot;</span><span class="p">,</span>
    <span class="mi">222</span><span class="p">:</span> <span class="s">&quot;ffd787&quot;</span><span class="p">,</span>
    <span class="mi">223</span><span class="p">:</span> <span class="s">&quot;ffd7af&quot;</span><span class="p">,</span>
    <span class="mi">224</span><span class="p">:</span> <span class="s">&quot;ffd7d7&quot;</span><span class="p">,</span>
    <span class="mi">225</span><span class="p">:</span> <span class="s">&quot;ffd7ff&quot;</span><span class="p">,</span>
    <span class="mi">226</span><span class="p">:</span> <span class="s">&quot;ffff00&quot;</span><span class="p">,</span>
    <span class="mi">227</span><span class="p">:</span> <span class="s">&quot;ffff5f&quot;</span><span class="p">,</span>
    <span class="mi">228</span><span class="p">:</span> <span class="s">&quot;ffff87&quot;</span><span class="p">,</span>
    <span class="mi">229</span><span class="p">:</span> <span class="s">&quot;ffffaf&quot;</span><span class="p">,</span>
    <span class="mi">230</span><span class="p">:</span> <span class="s">&quot;ffffd7&quot;</span><span class="p">,</span>
    <span class="mi">231</span><span class="p">:</span> <span class="s">&quot;ffffff&quot;</span><span class="p">,</span>
    <span class="c"># Grayscale:</span>
    <span class="mi">232</span><span class="p">:</span> <span class="s">&quot;080808&quot;</span><span class="p">,</span>
    <span class="mi">233</span><span class="p">:</span> <span class="s">&quot;121212&quot;</span><span class="p">,</span>
    <span class="mi">234</span><span class="p">:</span> <span class="s">&quot;1c1c1c&quot;</span><span class="p">,</span>
    <span class="mi">235</span><span class="p">:</span> <span class="s">&quot;262626&quot;</span><span class="p">,</span>
    <span class="mi">236</span><span class="p">:</span> <span class="s">&quot;303030&quot;</span><span class="p">,</span>
    <span class="mi">237</span><span class="p">:</span> <span class="s">&quot;3a3a3a&quot;</span><span class="p">,</span>
    <span class="mi">238</span><span class="p">:</span> <span class="s">&quot;444444&quot;</span><span class="p">,</span>
    <span class="mi">239</span><span class="p">:</span> <span class="s">&quot;4e4e4e&quot;</span><span class="p">,</span>
    <span class="mi">240</span><span class="p">:</span> <span class="s">&quot;585858&quot;</span><span class="p">,</span>
    <span class="mi">241</span><span class="p">:</span> <span class="s">&quot;626262&quot;</span><span class="p">,</span>
    <span class="mi">242</span><span class="p">:</span> <span class="s">&quot;6c6c6c&quot;</span><span class="p">,</span>
    <span class="mi">243</span><span class="p">:</span> <span class="s">&quot;767676&quot;</span><span class="p">,</span>
    <span class="mi">244</span><span class="p">:</span> <span class="s">&quot;808080&quot;</span><span class="p">,</span>
    <span class="mi">245</span><span class="p">:</span> <span class="s">&quot;8a8a8a&quot;</span><span class="p">,</span>
    <span class="mi">246</span><span class="p">:</span> <span class="s">&quot;949494&quot;</span><span class="p">,</span>
    <span class="mi">247</span><span class="p">:</span> <span class="s">&quot;9e9e9e&quot;</span><span class="p">,</span>
    <span class="mi">248</span><span class="p">:</span> <span class="s">&quot;a8a8a8&quot;</span><span class="p">,</span>
    <span class="mi">249</span><span class="p">:</span> <span class="s">&quot;b2b2b2&quot;</span><span class="p">,</span>
    <span class="mi">250</span><span class="p">:</span> <span class="s">&quot;bcbcbc&quot;</span><span class="p">,</span>
    <span class="mi">251</span><span class="p">:</span> <span class="s">&quot;c6c6c6&quot;</span><span class="p">,</span>
    <span class="mi">252</span><span class="p">:</span> <span class="s">&quot;d0d0d0&quot;</span><span class="p">,</span>
    <span class="mi">253</span><span class="p">:</span> <span class="s">&quot;dadada&quot;</span><span class="p">,</span>
    <span class="mi">254</span><span class="p">:</span> <span class="s">&quot;e4e4e4&quot;</span><span class="p">,</span>
    <span class="mi">255</span><span class="p">:</span> <span class="s">&quot;eeeeee&quot;</span>
<span class="p">}</span>

<span class="c"># Helper functions</span>
<div class="viewcode-block" id="require_auth"><a class="viewcode-back" href="../Developer/gateone.html#gateone.require_auth">[docs]</a><span class="k">def</span> <span class="nf">require_auth</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An equivalent to tornado.web.authenticated for WebSockets</span>
<span class="sd">    (ApplicationWebSocket, specifically).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Only valid users please.  Thanks!&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</div>
<span class="nd">@atexit.register</span> <span class="c"># I love this feature!</span>
<div class="viewcode-block" id="kill_all_sessions"><a class="viewcode-back" href="../Developer/gateone.html#gateone.kill_all_sessions">[docs]</a><span class="k">def</span> <span class="nf">kill_all_sessions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls all &#39;timeout_callbacks&#39; attached to all `SESSIONS`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s">&quot;timeout_callbacks&quot;</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                    <span class="n">callback</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="timeout_sessions"><a class="viewcode-back" href="../Developer/gateone.html#gateone.timeout_sessions">[docs]</a><span class="k">def</span> <span class="nf">timeout_sessions</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loops over the SESSIONS dict killing any sessions that haven&#39;t been used</span>
<span class="sd">    for the length of time specified in *TIMEOUT* (global).  The value of</span>
<span class="sd">    *TIMEOUT* can be set in server.conf or specified on the command line via the</span>
<span class="sd">    *session_timeout* value.  Arguments:</span>

<span class="sd">    .. note:: This function is meant to be called via Tornado&#39;s :meth:`~tornado.ioloop.PeriodicCallback`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;timeout_sessions() TIMEOUT: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">TIMEOUT</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SESSIONS</span><span class="p">:</span> <span class="c"># Last client has timed out</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;All user sessions have terminated.&quot;</span><span class="p">))</span>
            <span class="k">global</span> <span class="n">WATCHER</span>
            <span class="k">if</span> <span class="n">WATCHER</span><span class="p">:</span>
                <span class="n">WATCHER</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span> <span class="c"># Stop ourselves</span>
                <span class="n">WATCHER</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Reset so authenticate() will know to start it</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">SESSIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="s">&quot;last_seen&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
                <span class="c"># Session is in the process of being created.  We&#39;ll check it</span>
                <span class="c"># the next time timeout_sessions() is called.</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;connected&#39;</span><span class="p">:</span>
                <span class="c"># Connected sessions do not need to be checked for timeouts</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;last_seen&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">TIMEOUT</span><span class="p">:</span>
                <span class="c"># Kill the session</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;{session} timeout.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)))</span>
                <span class="k">if</span> <span class="s">&quot;timeout_callbacks&quot;</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="s">&quot;timeout_callbacks&quot;</span><span class="p">]:</span>
                            <span class="n">callback</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Exception encountered in timeout_sessions(): {exception}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
        <span class="p">))</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

<span class="c"># Classes</span></div>
<div class="viewcode-block" id="HTTPSRedirectHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.HTTPSRedirectHandler">[docs]</a><span class="k">class</span> <span class="nc">HTTPSRedirectHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler to redirect clients from HTTP to HTTPS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="HTTPSRedirectHandler.get"><a class="viewcode-back" href="../Developer/gateone.html#gateone.HTTPSRedirectHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Just redirects the client from HTTP to HTTPS&quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Host&#39;</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span>
            <span class="s">&#39;https://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">url_prefix</span><span class="p">))</span>
</div></div>
<div class="viewcode-block" id="StaticHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.StaticHandler">[docs]</a><span class="k">class</span> <span class="nc">StaticHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An override of :class:`tornado.web.StaticFileHandler` to ensure that the</span>
<span class="sd">    Access-Control-Allow-Origin header gets set correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># This is the only function we need to override thanks to the thoughtfulness</span>
    <span class="c"># of the Tornado devs.</span>
<div class="viewcode-block" id="StaticHandler.set_extra_headers"><a class="viewcode-back" href="../Developer/gateone.html#gateone.StaticHandler.set_extra_headers">[docs]</a>    <span class="k">def</span> <span class="nf">set_extra_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the Access-Control-Allow-Origin header to allow cross-origin</span>
<span class="sd">        access to static content for applications embedding Gate One.</span>
<span class="sd">        Specifically, this is necessary in order to support loading fonts</span>
<span class="sd">        from different origins.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="BaseHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.BaseHandler">[docs]</a><span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base handler that all Gate One RequestHandlers will inherit methods from.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Right now it&#39;s just the one function...</span>
<div class="viewcode-block" id="BaseHandler.get_current_user"><a class="viewcode-back" href="../Developer/gateone.html#gateone.BaseHandler.get_current_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tornado standard method--implemented our way.&quot;&quot;&quot;</span>
        <span class="c"># NOTE: self.current_user is actually an @property that calls</span>
        <span class="c">#       self.get_current_user() and caches the result.</span>
        <span class="n">user_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="s">&quot;gateone_user&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_json</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">user_json</span><span class="p">)</span>
            <span class="n">user</span><span class="p">[</span><span class="s">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">user</span>
    <span class="c"># More may be added in the future</span>
</div></div>
<div class="viewcode-block" id="DownloadHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.DownloadHandler">[docs]</a><span class="k">class</span> <span class="nc">DownloadHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A :class:`tornado.web.RequestHandler` to serve up files that wind up in a</span>
<span class="sd">    given user&#39;s `session_dir` in the &#39;downloads&#39; directory.  Generally speaking</span>
<span class="sd">    these files are generated by the terminal emulator (e.g. cat somefile.pdf)</span>
<span class="sd">    but it could be used by plugins as a way to serve up temporary files as</span>
<span class="sd">    well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># NOTE:  This is a modified version of torando.web.StaticFileHandler</span>
    <span class="nd">@tornado.web.authenticated</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">include_body</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;session&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;DownloadHandler: Could not determine use session&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="c"># Something is wrong</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="s">&#39;downloads&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_error_html</span><span class="p">(</span><span class="mi">404</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">403</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a file&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">stat</span><span class="o">,</span> <span class="nn">mimetypes</span>
        <span class="n">stat_result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">stat_result</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Last-Modified&quot;</span><span class="p">,</span> <span class="n">modified</span><span class="p">)</span>
        <span class="n">mime_type</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mime_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="n">mime_type</span><span class="p">)</span>
        <span class="c"># Set the Cache-Control header to private since this file is not meant</span>
        <span class="c"># to be public.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Cache-Control&quot;</span><span class="p">,</span> <span class="s">&quot;private&quot;</span><span class="p">)</span>
        <span class="c"># Check the If-Modified-Since, and don&#39;t send the result if the</span>
        <span class="c"># content has not been modified</span>
        <span class="n">ims_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;If-Modified-Since&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ims_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">email.utils</span>
            <span class="n">date_tuple</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">parsedate</span><span class="p">(</span><span class="n">ims_value</span><span class="p">)</span>
            <span class="n">if_since</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date_tuple</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">if_since</span> <span class="o">&gt;=</span> <span class="n">modified</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="c"># Finally, deliver the file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
            <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Etag&quot;</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">include_body</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;HEAD&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_error_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s">&quot;static_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">403</span><span class="p">]:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;static_url&#39;</span><span class="p">],</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">.html&#39;</span> <span class="o">%</span> <span class="n">status_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="kn">import</span> <span class="nn">httplib</span>
        <span class="k">return</span> <span class="s">&quot;&lt;html&gt;&lt;title&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/title&gt;&quot;</span> \
                <span class="s">&quot;&lt;body class=&#39;bodyErrorPage&#39;&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/body&gt;&lt;/html&gt;&quot;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s">&quot;code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
            <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">status_code</span><span class="p">],</span>
        <span class="p">}</span>
</div>
<div class="viewcode-block" id="MainHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.MainHandler">[docs]</a><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renders index.html which loads Gate One.</span>

<span class="sd">    Will include the minified version of gateone.js if available as</span>
<span class="sd">    gateone.min.js.</span>

<span class="sd">    Will encode GATEONE_DIR/static/bell.ogg as a data:URI and put it as the</span>
<span class="sd">    &lt;source&gt; of the &lt;audio&gt; tag inside the index.html template.  Gate One</span>
<span class="sd">    administrators can replace bell.ogg with whatever they like but the file</span>
<span class="sd">    size should be less than 32k when encoded to Base64.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@tornado.web.authenticated</span>
    <span class="nd">@tornado.web.addslash</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;location&quot;</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">)</span>
        <span class="n">prefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;prefs&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">gateone_js</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">static/gateone.js&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">minified_js_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
        <span class="n">minified_js_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">minified_js_abspath</span><span class="p">,</span> <span class="s">&#39;gateone.min.js&#39;</span><span class="p">)</span>
        <span class="n">js_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;js_init&#39;</span><span class="p">]</span>
        <span class="c"># Use the minified version if it exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">minified_js_abspath</span><span class="p">):</span>
            <span class="n">gateone_js</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">static/gateone.min.js&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">index_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s">&#39;index.html&#39;</span><span class="p">)</span>
        <span class="n">head_html</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">body_html</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;HTML&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;head&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">][</span><span class="s">&#39;head&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">][</span><span class="s">&#39;head&#39;</span><span class="p">]:</span>
                            <span class="n">head_html</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">item</span>
                <span class="k">if</span> <span class="s">&#39;body&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">][</span><span class="s">&#39;body&#39;</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;HTML&#39;</span><span class="p">][</span><span class="s">&#39;body&#39;</span><span class="p">]:</span>
                            <span class="n">body_html</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">index_path</span><span class="p">,</span>
            <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>
            <span class="n">gateone_js</span><span class="o">=</span><span class="n">gateone_js</span><span class="p">,</span>
            <span class="n">jsplugins</span><span class="o">=</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;js&#39;</span><span class="p">],</span>
            <span class="n">cssplugins</span><span class="o">=</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;css&#39;</span><span class="p">],</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">js_init</span><span class="o">=</span><span class="n">js_init</span><span class="p">,</span>
            <span class="n">url_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">],</span>
            <span class="n">head</span><span class="o">=</span><span class="n">head_html</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">body_html</span><span class="p">,</span>
            <span class="n">prefs</span><span class="o">=</span><span class="n">prefs</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="PluginCSSTemplateHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.PluginCSSTemplateHandler">[docs]</a><span class="k">class</span> <span class="nc">PluginCSSTemplateHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renders plugin CSS template files, passing them the same *prefix* and</span>
<span class="sd">    *container* variables used by the StyleHandler.  This is so we don&#39;t need a</span>
<span class="sd">    CSS template rendering function in every plugin that needs to use {{prefix}}</span>
<span class="sd">    or {{container}}.</span>

<span class="sd">    gateone.js will automatically load all \*.css files in plugin template</span>
<span class="sd">    directories using this method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Had to disable authentication for this for the embedded stuff to work.</span>
    <span class="c"># Not a big deal...  Just some stylesheets.  To an attacker it&#39;s like</span>
    <span class="c"># peering into a window and seeing the wallpaper.</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;container&quot;</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">)</span>
        <span class="n">plugin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;plugin&quot;</span><span class="p">)</span>
        <span class="n">templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">plugin_templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>
        <span class="n">plugin_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_templates_path</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.css&quot;</span> <span class="o">%</span> <span class="n">plugin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/css&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="n">plugin_template</span><span class="p">,</span>
                <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                <span class="n">url_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="c"># The provided plugin/template combination was not found</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.css was not found&quot;</span> <span class="o">%</span> <span class="n">plugin_template</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="GOApplication"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication">[docs]</a><span class="k">class</span> <span class="nc">GOApplication</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The base from which all Gate One Applications will inherit.  Applications</span>
<span class="sd">    are expected to be written like so::</span>

<span class="sd">        class SomeApplication(GOApplication):</span>
<span class="sd">            def initialize(self):</span>
<span class="sd">                &quot;Called when the Application is instantiated.&quot;</span>
<span class="sd">                initialize_stuff()</span>
<span class="sd">                # Here&#39;s some good things to do in an initialize() function...</span>
<span class="sd">                # Register a policy-checking function:</span>
<span class="sd">                self.ws.security.update({&#39;some_app&#39;: policy_checking_func})</span>
<span class="sd">                # Register some WebSocket actions (note the app:action naming convention)</span>
<span class="sd">                self.ws.commands.update({</span>
<span class="sd">                    &#39;some_app:do_stuff&#39;: self.do_stuff,</span>
<span class="sd">                    &#39;some_app:do_other_stuff&#39;: self.do_other_stuff</span>
<span class="sd">                })</span>
<span class="sd">            def open(self):</span>
<span class="sd">                &quot;Called when the connection is established.&quot;</span>
<span class="sd">                # Setup whatever is necessary for session tracking and whatnot.</span>
<span class="sd">            def authenticate(self):</span>
<span class="sd">                &quot;Called when the user *successfully* authenticates.&quot;</span>
<span class="sd">                # Here&#39;s the best place to instantiate things, send the user</span>
<span class="sd">                # JavaScript/CSS files, and similar post-authentication details.</span>
<span class="sd">            def on_close(self):</span>
<span class="sd">                &quot;Called when the connection is closed.&quot;</span>
<span class="sd">                # This is a good place to halt any background/periodic operations.</span>

<span class="sd">    GOApplications will be automatically imported into Gate One and registered</span>
<span class="sd">    appropriately as long as they follow the following conventions:</span>

<span class="sd">        * The application and its module(s) should live inside its own directory inside the &#39;applications&#39; directory.  For example, `/opt/gateone/applications/some_app/some_app.py`</span>
<span class="sd">        * Subclasses of `GOApplication` must be added to an `apps` global (list) inside of the application&#39;s module(s) like so: `apps = [SomeApplication]` (usually a good idea to put that at the very bottom of the module).</span>

<span class="sd">    .. note:: All .py modules inside of the application&#39;s main directory will be imported even if they do not contain or register a `GOApplication`.</span>

<span class="sd">    .. tip:: You can add command line arguments to Gate One by calling :func:`tornado.options.define` anywhere in your application&#39;s global namespace.  This works because the :func:`~tornado.options.define` function registers options in Gate One&#39;s global namespace (as `tornado.options.options`) and Gate One imports application modules before it evaluates command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="n">ws</span> <span class="c"># WebSocket instance</span>
        <span class="c"># Setup some shortcuts to make things more natural and convenient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">write_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">get_current_user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">current_user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">security</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">trigger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">off</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;GOApplication: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span>

<div class="viewcode-block" id="GOApplication.initialize"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :meth:`ApplicationWebSocket.open` after __init__().</span>
<span class="sd">        GOApplications can override this function to perform their own actions</span>
<span class="sd">        when the WebSocket is initialized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="GOApplication.open"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :meth:`ApplicationWebSocket.open` after the WebSocket is</span>
<span class="sd">        opened.  GOApplications can override this function to perform their own</span>
<span class="sd">        actions when the WebSocket is opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="GOApplication.on_close"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication.on_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called by :meth:`ApplicationWebSocket.on_close` after the WebSocket is</span>
<span class="sd">        closed.  GOApplications can override this function to perform their own</span>
<span class="sd">        actions when the WebSocket is closed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="GOApplication.add_handler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.GOApplication.add_handler">[docs]</a>    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds the given *handler* (`tornado.web.RequestHandler`) to the Tornado</span>
<span class="sd">        Application (`self.ws.application`) to handle URLs matching *pattern*.</span>
<span class="sd">        If given, *kwargs* will be added to the `tornado.web.URLSpec` when the</span>
<span class="sd">        complete handler is assembled.</span>

<span class="sd">        .. note:: If the *pattern* does not start with the configured `url_prefix` it will be automatically prepended.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Adding handler: (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">))</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
                <span class="c"># Get rid of the / (it will be in the url_prefix)</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">URLSpec</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="c"># Why the Tornado devs didn&#39;t give us a simple way to do this is beyond</span>
        <span class="c"># me.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="ApplicationWebSocket"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket">[docs]</a><span class="k">class</span> <span class="nc">ApplicationWebSocket</span><span class="p">(</span><span class="n">WebSocketHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main WebSocket interface for Gate One, this class is setup to call</span>
<span class="sd">    &#39;commands&#39; which are methods registered in self.commands.  Methods that are</span>
<span class="sd">    registered this way will be exposed and directly callable over the</span>
<span class="sd">    WebSocket.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instances</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">WebSocketHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s">&#39;ping&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pong</span><span class="p">,</span>
            <span class="s">&#39;authenticate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">,</span>
            <span class="s">&#39;get_style&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_style</span><span class="p">,</span>
            <span class="s">&#39;get_js&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_js</span><span class="p">,</span>
            <span class="s">&#39;enumerate_themes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_themes</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># This is used to keep track of used API authentication signatures so</span>
        <span class="c"># we can prevent replay attacks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_signatures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># Only allow valid origins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_cache</span> <span class="o">=</span> <span class="n">FILE_CACHE</span> <span class="c"># So applications and plugins can reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">persist</span> <span class="o">=</span> <span class="n">PERSIST</span> <span class="c"># So applications and plugins can reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apps</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Gets filled up by self.initialize()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Stores applications&#39; various policy functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ApplicationWebSocket.initialize"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This gets called by the Tornado framework when ApplicationWebSocket is</span>
<span class="sd">        instantiated.  It will be passed the list of *apps* (Gate One</span>
<span class="sd">        applications) that are assigned inside the :class:`Application` object.</span>
<span class="sd">        These *apps* will be mutated in-place so that `self` will refer to the</span>
<span class="sd">        current instance of :class:`ApplicationWebSocket`.  Kind of like a</span>
<span class="sd">        dynamic mixin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">apps</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Initializing </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">instance</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;initialize&#39;</span><span class="p">):</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.on"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.on">[docs]</a>    <span class="k">def</span> <span class="nf">on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers the given *callback* with the given *events* (string or list</span>
<span class="sd">        of strings) that will get called whenever the given *event* is triggered</span>
<span class="sd">        (using :meth:`ApplicationWebSocket.trigger`).  It works similarly to</span>
<span class="sd">        :js:meth:`GateOne.Events.on` in gateone.js.</span>

<span class="sd">        If *times* is given the *callback* will only be fired that many times</span>
<span class="sd">        before it is automatically removed from</span>
<span class="sd">        :attr:`ApplicationWebSocket._events`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">events</span><span class="p">]</span>
        <span class="n">callback_obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;callback&#39;</span><span class="p">:</span> <span class="n">callback</span><span class="p">,</span>
            <span class="s">&#39;times&#39;</span><span class="p">:</span> <span class="n">times</span><span class="p">,</span>
            <span class="s">&#39;calls&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">event</span><span class="p">:</span> <span class="p">[</span><span class="n">callback_obj</span><span class="o">.</span><span class="n">copy</span><span class="p">()]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">[</span><span class="n">event</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback_obj</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.off"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.off">[docs]</a>    <span class="k">def</span> <span class="nf">off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the given *callback* from the given *events* (string or list of</span>
<span class="sd">        strings).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">events</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">[</span><span class="n">event</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">callback_obj</span><span class="p">[</span><span class="s">&#39;callback&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">callback</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">[</span><span class="n">event</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span> <span class="c"># Nothing to do</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.once"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.once">[docs]</a>    <span class="k">def</span> <span class="nf">once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut for :meth:`ApplicationWebSocket.on(events, callback, 1)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.trigger"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.trigger">[docs]</a>    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fires the given *events* (string or list of strings).  All callbacks</span>
<span class="sd">        associated with these *events* will be called and if their respective</span>
<span class="sd">        objects have a *times* value set it will be used to determine when to</span>
<span class="sd">        remove the associated callback from the event.</span>

<span class="sd">        If given, callbacks associated with the given *events* will be called</span>
<span class="sd">        with *args* and *kwargs*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">events</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">callback_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">[</span><span class="n">event</span><span class="p">]:</span>
                    <span class="n">callback_obj</span><span class="p">[</span><span class="s">&#39;callback&#39;</span><span class="p">](</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">callback_obj</span><span class="p">[</span><span class="s">&#39;calls&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">callback_obj</span><span class="p">[</span><span class="s">&#39;calls&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">callback_obj</span><span class="p">[</span><span class="s">&#39;times&#39;</span><span class="p">]:</span>
                        <span class="n">off</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">callback_obj</span><span class="p">[</span><span class="s">&#39;callback&#39;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.allow_draft76"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.allow_draft76">[docs]</a>    <span class="k">def</span> <span class="nf">allow_draft76</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        By overriding this function we&#39;re allowing the older version of the</span>
<span class="sd">        WebSockets protocol.  As long as communications happens over SSL there</span>
<span class="sd">        shouldn&#39;t be any security concerns with this.  This is mostly to support</span>
<span class="sd">        iOS Safari.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.get_current_user"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.get_current_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mostly identical to the function of the same name in MainHandler.  The</span>
<span class="sd">        difference being that when API authentication is enabled the WebSocket</span>
<span class="sd">        will expect and perform its own auth of the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
        <span class="n">user_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="s">&quot;gateone_user&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_json</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="c"># This can happen if the user&#39;s browser isn&#39;t allowing</span>
                <span class="c"># persistent cookies (e.g. incognito mode)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s">&#39;upn&#39;</span><span class="p">:</span> <span class="s">&#39;ANONYMOUS&#39;</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">generate_session_id</span><span class="p">()}</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">user_json</span><span class="p">)</span>
        <span class="n">user</span><span class="p">[</span><span class="s">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
        <span class="k">return</span> <span class="n">user</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.open"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when a new WebSocket is opened.  Will deny access to any</span>
<span class="sd">        origin that is not defined in self.settings[&#39;origin&#39;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">valid_origins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;origins&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;Origin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">origin_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Origin&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s">&#39;Sec-Websocket-Origin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="c"># Old version</span>
            <span class="n">origin_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Sec-Websocket-Origin&#39;</span><span class="p">]</span>
        <span class="n">origin_header</span> <span class="o">=</span> <span class="n">origin_header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c"># hostnames are case-insensitive</span>
        <span class="n">origin_header</span> <span class="o">=</span> <span class="n">origin_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;://&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_origins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">origin_header</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_origins</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">origin_header</span>
                <span class="n">short_origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">denied_msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Access denied for origin: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">origin</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">denied_msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">denied_msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;If you feel this is incorrect you just have to add &#39;</span><span class="si">%s</span><span class="s">&#39; to&quot;</span>
                    <span class="s">&quot; the &#39;origin&#39; option in your server.conf.  See the docs &quot;</span>
                    <span class="s">&quot;for details.&quot;</span> <span class="o">%</span> <span class="n">short_origin</span>
                <span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># client_id is unique to the browser/client whereas session_id is unique</span>
        <span class="c"># to the user.  It isn&#39;t used much right now but it will be useful in</span>
        <span class="c"># the future once more stuff is running over WebSockets.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="c"># NOTE: self.current_user will call self.get_current_user() the first</span>
        <span class="c"># time it is used.</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket opened (</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">).&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">],</span> <span class="n">client_address</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket opened (unknown user).&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span> <span class="c"># Invalid user info</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
            <span class="c"># In case this is a legitimate client that simply had its auth info</span>
            <span class="c"># expire/go bad, tell it to re-auth by calling the appropriate</span>
            <span class="c"># action on the other side.</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="c"># Make sure we have all policies ready for checking</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">))</span>
        <span class="c"># NOTE: The above will eventually be rolled into self.settings once the</span>
        <span class="c">#       conversion of all settings to the new JSON format is completed.</span>
        <span class="c"># NOTE: By getting the policies with each call to open() we&#39;re enabling</span>
        <span class="c">#       the ability to make changes inside the settings dir without</span>
        <span class="c">#       having to restart Gate One (just need to wait for users to</span>
        <span class="c">#       eventually re-connect).</span>
        <span class="c"># Call applications&#39; open() functions (if any)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s">&#39;open&#39;</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.on_message"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.on_message">[docs]</a>    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when we receive a message from the client.&quot;&quot;&quot;</span>
        <span class="c"># This is super useful when debugging:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;message: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_denied</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Message rejected due to invalid origin.&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="n">message_obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message_obj</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="c"># JSON FTW!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;&#39;Error: Message bust be a JSON dict.&#39;&quot;</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># We didn&#39;t get JSON</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;&#39;Error: We only accept JSON here.&#39;&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">message_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">message_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">PLUGIN_WS_CMDS</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span> <span class="c"># Plugins first so they can override behavior if they wish</span>
                        <span class="n">PLUGIN_WS_CMDS</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
                        <span class="c"># tws==ApplicationWebSocket</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;Error running plugin WebSocket action: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># Try, try again</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="n">key</span><span class="p">]()</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;Error with WebSocket action, </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">e</span><span class="p">)))</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Printing traceback...&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;logging&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;debug&quot;</span><span class="p">:</span>
                            <span class="kn">import</span> <span class="nn">traceback</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Unknown WebSocket action: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.on_close"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.on_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the client terminates the connection.</span>

<span class="sd">        .. note:: Normally self.refresh_screen() catches the disconnect first and this method won&#39;t end up being called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;on_close()&quot;</span><span class="p">)</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">ApplicationWebSocket</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
        <span class="n">client_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="c"># Update &#39;last_seen&#39; with a datetime object for accuracy</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]][</span><span class="s">&#39;last_seen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket closed (</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">).&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">],</span> <span class="n">client_address</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket closed (unknown user).&quot;</span><span class="p">))</span>
        <span class="c"># Call applications&#39; on_close() functions (if any)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s">&#39;on_close&#39;</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">on_close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.pong"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.pong">[docs]</a>    <span class="k">def</span> <span class="nf">pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Responds to a client &#39;ping&#39; request...  Just returns the given</span>
<span class="sd">        timestamp back to the client so it can measure round-trip time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;pong&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.authenticate"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticates the client by first trying to use the &#39;gateone_user&#39;</span>
<span class="sd">        cookie or if Gate One is configured to use API authentication it will</span>
<span class="sd">        use *settings[&#39;auth&#39;]*.  Additionally, it will accept</span>
<span class="sd">        *settings[&#39;container&#39;]* and *settings[&#39;prefix&#39;]* to apply those to the</span>
<span class="sd">        equivalent properties (self.container and self.prefix).</span>

<span class="sd">        If *settings[&#39;location&#39;]* is something other than &#39;default&#39; all new</span>
<span class="sd">        terminals will be associated with the given (string) value.  These</span>
<span class="sd">        terminals will be treated separately from the usual terminals so they</span>
<span class="sd">        can exist in a different browser tab/window.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;authenticate(): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;Origin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">origin_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Origin&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s">&#39;Sec-Websocket-Origin&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="c"># Old version</span>
            <span class="n">origin_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Sec-Websocket-Origin&#39;</span><span class="p">]</span>
        <span class="c"># Make sure the client is authenticated if authentication is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;api&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
                    <span class="c"># This usually happens when the cookie_secret gets changed</span>
                    <span class="c"># resulting in &quot;Invalid cookie...&quot; errors.  If we tell the</span>
                    <span class="c"># client to re-auth the problem should correct itself.</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">elif</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;ANONYMOUS&#39;</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
                    <span class="c"># This can happen when a client logs in with no auth type</span>
                    <span class="c"># configured and then later the server is configured to use</span>
                    <span class="c"># authentication.  The client must be told to re-auth:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># &#39;upn&#39; wasn&#39;t in user</span>
                <span class="c"># Force them to authenticate</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;api&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c"># &#39;auth&#39; message should look like this:</span>
                <span class="c"># {</span>
                <span class="c">#    &#39;api_key&#39;: &#39;MjkwYzc3MDI2MjhhNGZkNDg1MjJkODgyYjBmN2MyMTM4M&#39;,</span>
                <span class="c">#    &#39;upn&#39;: &#39;joe@company.com&#39;,</span>
                <span class="c">#    &#39;timestamp&#39;: &#39;1323391717238&#39;,</span>
                <span class="c">#    &#39;signature&#39;: &lt;gibberish&gt;,</span>
                <span class="c">#    &#39;signature_method&#39;: &#39;HMAC-SHA1&#39;,</span>
                <span class="c">#    &#39;api_version&#39;: &#39;1.0&#39;</span>
                <span class="c"># }</span>
                <span class="c">#</span>
                <span class="c"># *api_key* is the first half of what gets generated when you</span>
                <span class="c">#   run ./gateone --new_api_key.</span>
                <span class="c"># *upn* is the User Principal Name of the user.  This is</span>
                <span class="c">#   typically something like &quot;joe@company.com&quot;.</span>
                <span class="c"># *timestamp* is a JavaScript Date() object converted into an</span>
                <span class="c">#   &quot;time since the epoch&quot; (int or string is OK):</span>
                <span class="c">#       var timestamp = new Date().getTime()</span>
                <span class="c"># *signature* is an HMAC signature of the previous three</span>
                <span class="c">#   variables that was created using the given API key&#39;s secret.</span>
                <span class="c"># *signature_method* is the HMAC hashing algorithm to use for</span>
                <span class="c">#   the signature.  Only HMAC-SHA1 is supported for now.</span>
                <span class="c"># *api_version* is the auth API version.  Always &quot;1.0&quot; for now.</span>
                <span class="c">#</span>
                <span class="c"># For reference, here&#39;s how to make a signature using PHP:</span>
                <span class="c"># $authobj = array(&#39;api_key&#39; =&gt; &#39;M2I1MzJmZjk4MTEwNDk2Zjk4MjMwNmMwMTVkODQzMTEyO&#39;, &#39;upn&#39; =&gt; $_SERVER[&#39;REMOTE_USER&#39;], &#39;timestamp&#39; =&gt; time() . &#39;0000&#39;, &#39;signature_method&#39; =&gt; &#39;HMAC-SHA1&#39;, &#39;api_version&#39; =&gt; &#39;1.0&#39;);</span>
                <span class="c"># $authobj[&#39;signature&#39;] = hash_hmac(&#39;sha1&#39;, $authobj[&#39;api_key&#39;] . $authobj[&#39;upn&#39;] . $authobj[&#39;timestamp&#39;], &#39;&lt;secret&gt;&#39;);</span>
                <span class="c"># Note that the order matters:  api_key -&gt; upn -&gt; timestamp</span>
                <span class="n">auth_obj</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;api_key&#39;</span> <span class="ow">in</span> <span class="n">auth_obj</span><span class="p">:</span>
                    <span class="c"># Assume everything else is present if the api_key is there</span>
                    <span class="n">api_key</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;api_key&#39;</span><span class="p">]</span>
                    <span class="n">upn</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;timestamp&#39;</span><span class="p">])</span>
                    <span class="n">signature</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;signature&#39;</span><span class="p">]</span>
                    <span class="n">signature_method</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;signature_method&#39;</span><span class="p">]</span>
                    <span class="n">api_version</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;api_version&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">signature_method</span> <span class="o">!=</span> <span class="s">&#39;HMAC-SHA1&#39;</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTHENTICATION ERROR: Unsupported API auth &#39;</span>
                                <span class="s">&#39;signature method: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">signature_method</span><span class="p">))</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="n">api_version</span> <span class="o">!=</span> <span class="s">&quot;1.0&quot;</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTHENTICATION ERROR: Unsupported API version:&#39;</span>
                                <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">api_version</span><span class="p">))</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                        <span class="k">return</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;api_keys&#39;</span><span class="p">][</span><span class="n">api_key</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&#39;AUTHENTICATION ERROR: API Key not found.&#39;</span><span class="p">))</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                        <span class="k">return</span>
                    <span class="c"># Check the signature against existing API keys</span>
                    <span class="n">sig_check</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">_create_signature</span><span class="p">(</span>
                        <span class="n">secret</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">upn</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sig_check</span> <span class="o">==</span> <span class="n">signature</span><span class="p">:</span>
                        <span class="c"># Everything matches (great!) so now we do due diligence</span>
                        <span class="c"># by checking the timestamp against the</span>
                        <span class="c"># api_timestamp_window setting and whether or not we&#39;ve</span>
                        <span class="c"># already used it (to prevent replay attacks).</span>
                        <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_signatures</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;API authentication replay attack detected!  User: &quot;</span>
                            <span class="s">&quot;</span><span class="si">%s</span><span class="s">, Remote IP: </span><span class="si">%s</span><span class="s">, Origin: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">upn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span> <span class="n">origin_header</span><span class="p">)))</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTH FAILED: Replay attack detected!  This &#39;</span>
                                <span class="s">&#39;event has been logged.&#39;</span><span class="p">)}</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">return</span>
                        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;api_timestamp_window&#39;</span><span class="p">]</span>
                        <span class="n">then</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
                        <span class="n">time_diff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">then</span>
                        <span class="k">if</span> <span class="n">time_diff</span> <span class="o">&gt;</span> <span class="n">window</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;API authentication failed due to an expired auth &quot;</span>
                            <span class="s">&quot;object.  If you just restarted the server this is &quot;</span>
                            <span class="s">&quot;normal (users just need to reload the page).  If &quot;</span>
                            <span class="s">&quot; this problem persists it could be a problem with &quot;</span>
                            <span class="s">&quot;the server&#39;s clock (either this server or the &quot;</span>
                            <span class="s">&quot;server(s) embedding Gate One).&quot;</span>
                            <span class="p">))</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTH FAILED: Authentication object timed out. &#39;</span>
                                <span class="s">&#39;Try reloading this page (F5).&#39;</span><span class="p">)}</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTH FAILED: If the problem persists after &#39;</span>
                                <span class="s">&#39;reloading this page please contact your server&#39;</span>
                                <span class="s">&#39; administrator to notify them of the issue.&#39;</span><span class="p">)}</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">return</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;API Authentication Successful&quot;</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prev_signatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span> <span class="c"># Prevent replays</span>
                <span class="c"># Make a directory to store this user&#39;s settings/files/logs/etc</span>
                        <span class="n">user_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">upn</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">user_dir</span><span class="p">):</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s">&quot;Creating user directory: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">user_dir</span><span class="p">))</span>
                            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">user_dir</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
                        <span class="n">session_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
                            <span class="n">session_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">session_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">session_data</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">session_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c"># Save it so we can keep track across multiple clients</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s">&#39;upn&#39;</span><span class="p">:</span> <span class="n">upn</span><span class="p">,</span> <span class="c"># FYI: UPN == userPrincipalName</span>
                                    <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">generate_session_id</span><span class="p">()</span>
                                <span class="p">}</span>
                                <span class="n">session_info_json</span> <span class="o">=</span> <span class="n">json_encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">session_info_json</span><span class="p">)</span>
                        <span class="c"># Attach any additional provided keys/values to the user</span>
                        <span class="c"># object so applications embedding Gate One can use</span>
                        <span class="c"># them in their own plugins and whatnot.</span>
                        <span class="n">known_params</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s">&#39;api_key&#39;</span><span class="p">,</span>
                            <span class="s">&#39;api_version&#39;</span><span class="p">,</span>
                            <span class="s">&#39;timestamp&#39;</span><span class="p">,</span>
                            <span class="s">&#39;upn&#39;</span><span class="p">,</span>
                            <span class="s">&#39;signature&#39;</span><span class="p">,</span>
                            <span class="s">&#39;signature_method&#39;</span>
                        <span class="p">]</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">auth_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_params</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="c"># user dicts need a little extra attention for IPs...</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;ip_address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
                        <span class="c"># Force-set the current user:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_current_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;WebSocket auth failed signature check.&quot;</span><span class="p">))</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                        <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Missing API Key in authentication object&quot;</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Anonymous auth</span>
            <span class="c"># Double-check there isn&#39;t a user set in the cookie (i.e. we have</span>
            <span class="c"># recently changed Gate One&#39;s settings).  If there is, force it</span>
            <span class="c"># back to ANONYMOUS.</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]:</span>
                <span class="n">cookie_data</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="c"># The client is trying to authenticate using the</span>
                    <span class="c"># &#39;gateone_user&#39; parameter in localStorage.</span>
                    <span class="c"># Authenticate/decode the encoded auth info</span>
                    <span class="n">cookie_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span>
                        <span class="s">&#39;gateone_user&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">])</span>
                    <span class="c"># NOTE: The above doesn&#39;t actually touch any cookies</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Someone is attempting to perform API-based authentication</span>
                    <span class="c"># but this server isn&#39;t configured with &#39;auth = &quot;api&quot;&#39;.</span>
                    <span class="c"># Let&#39;s be real user-friendly and point out this mistake</span>
                    <span class="c"># with a helpful error message...</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;Client tried to use API-based authentication but this &quot;</span>
                        <span class="s">&quot;server is configured with &#39;auth = </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s">.  Did you &quot;</span>
                        <span class="s">&quot;forget to set &#39;auth = </span><span class="se">\&quot;</span><span class="s">api</span><span class="se">\&quot;</span><span class="s"> in your server.conf?&quot;</span> <span class="o">%</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]))</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;AUTHENTICATION ERROR: Server is not configured to &quot;</span>
                        <span class="s">&quot;perform API-based authentication.  Did someone forget &quot;</span>
                        <span class="s">&quot;to set &#39;auth = </span><span class="se">\&quot;</span><span class="s">api</span><span class="se">\&quot;</span><span class="s"> in the server.conf?&quot;</span><span class="p">)}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">cookie_data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">cookie_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                <span class="c"># Generate a new session/anon user</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
                <span class="c"># Also store/update their session info in localStorage</span>
                <span class="n">encoded_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_signed_value</span><span class="p">(</span>
                    <span class="s">&#39;gateone_user&#39;</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">escape</span><span class="o">.</span><span class="n">json_encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
                <span class="n">session_message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;gateone_user&#39;</span><span class="p">:</span> <span class="n">encoded_user</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">session_message</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;ANONYMOUS&#39;</span><span class="p">:</span>
                <span class="c"># Gate One server&#39;s auth config probably changed</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="c">#self.close() # Close the WebSocket</span>
                <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;session&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Authentication failed for unknown user&quot;</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;AUTHENTICATION ERROR: User unknown&#39;</span><span class="p">)}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Exception encountered trying to authenticate: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Execute any post-authentication hooks that plugins have registered</span>
            <span class="k">if</span> <span class="n">PLUGIN_AUTH_HOOKS</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">auth_hook</span> <span class="ow">in</span> <span class="n">PLUGIN_AUTH_HOOKS</span><span class="p">:</span>
                    <span class="n">auth_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Exception in registered Auth hook: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
        <span class="c"># Apply the container/prefix settings (if present)</span>
        <span class="k">if</span> <span class="s">&#39;container&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;container&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
        <span class="k">if</span> <span class="s">&#39;location&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;location&#39;</span><span class="p">]</span>
        <span class="c"># This check is to make sure there&#39;s no existing session so we don&#39;t</span>
        <span class="c"># accidentally clobber it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="c"># Old session is no good, start a new one:</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;last_seen&#39;</span><span class="p">:</span> <span class="s">&#39;connected&#39;</span><span class="p">,</span>
                <span class="s">&#39;timeout_callbacks&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="c"># Locations are virtual containers that indirectly correlate</span>
                <span class="c"># with browser windows/tabs.  The point is to allow things like</span>
                <span class="c"># opening/moving applications/terminals in/to new windows/tabs.</span>
                <span class="s">&#39;locations&#39;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;last_seen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;connected&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;locations&#39;</span><span class="p">]:</span>
                <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;locations&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Send our plugin .js and .css files to the client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_static_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">))</span>
        <span class="c"># Call applications&#39; authenticate() functions (if any)</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="s">&#39;authenticate&#39;</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">authenticate</span><span class="p">()</span>
        <span class="c"># This is just so the client has a human-readable point of reference:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;set_username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="c"># Startup the watcher if it isn&#39;t already running</span>
        <span class="k">global</span> <span class="n">WATCHER</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">WATCHER</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="mi">1000</span> <span class="c"># Check every 30 seconds</span>
            <span class="n">WATCHER</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">PeriodicCallback</span><span class="p">(</span><span class="n">timeout_sessions</span><span class="p">,</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">WATCHER</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.get_style"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.get_style">[docs]</a>    <span class="k">def</span> <span class="nf">get_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the CSS stylesheets matching the properties specified in</span>
<span class="sd">        *settings* to the client.  *settings* must contain the following:</span>

<span class="sd">            * **container** - The element Gate One resides in (e.g. &#39;gateone&#39;)</span>
<span class="sd">            * **prefix** - The string being used to prefix all elements (e.g. &#39;go\_&#39;)</span>

<span class="sd">        *settings* may also contain any combination of the following:</span>

<span class="sd">            * **theme** - The name of the CSS theme to be retrieved.</span>
<span class="sd">            * **colors** - The name of the text color CSS scheme to be retrieved.</span>
<span class="sd">            * **plugins** - If true, will send all plugin .css files to the client.</span>
<span class="sd">            * **print** - If true, will send the print stylesheet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;get_style(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">}</span>
        <span class="n">templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">themes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="s">&#39;themes&#39;</span><span class="p">)</span>
        <span class="n">colors_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="s">&#39;term_colors&#39;</span><span class="p">)</span>
        <span class="n">printing_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="s">&#39;printing&#39;</span><span class="p">)</span>
        <span class="n">go_url</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;go_url&#39;</span><span class="p">]</span> <span class="c"># Used to prefix the url_prefix</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">go_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
            <span class="n">go_url</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
        <span class="n">container</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;container&quot;</span><span class="p">]</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;prefix&quot;</span><span class="p">]</span>
        <span class="n">theme</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;theme&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">theme</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;theme&quot;</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;colors&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;colors&quot;</span><span class="p">]</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;plugins&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">plugins</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;plugins&quot;</span><span class="p">]</span>
        <span class="n">_print</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;print&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="n">_print</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;print&quot;</span><span class="p">]</span>
        <span class="c"># Setup our 256-color support CSS:</span>
        <span class="n">colors_256</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
            <span class="n">fg</span> <span class="o">=</span> <span class="s">&quot;#</span><span class="si">%s</span><span class="s"> span.fx</span><span class="si">%s</span><span class="s"> {color: #</span><span class="si">%s</span><span class="s">;}&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">COLORS_256</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="s">&quot;#</span><span class="si">%s</span><span class="s"> span.bx</span><span class="si">%s</span><span class="s"> {background-color: #</span><span class="si">%s</span><span class="s">;} &quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">COLORS_256</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">fg_rev</span> <span class="o">=</span> <span class="s">&quot;#</span><span class="si">%s</span><span class="s"> span.reverse.fx</span><span class="si">%s</span><span class="s"> {background-color: #</span><span class="si">%s</span><span class="s">; color: inherit;}&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">COLORS_256</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">bg_rev</span> <span class="o">=</span> <span class="s">&quot;#</span><span class="si">%s</span><span class="s"> span.reverse.bx</span><span class="si">%s</span><span class="s"> {color: #</span><span class="si">%s</span><span class="s">; background-color: inherit;} &quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">COLORS_256</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">colors_256</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">fg_rev</span><span class="p">,</span> <span class="n">bg_rev</span><span class="p">)</span>
        <span class="n">colors_256</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">if</span> <span class="n">theme</span><span class="p">:</span>
            <span class="n">theme_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">themes_path</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.css&quot;</span> <span class="o">%</span> <span class="n">theme</span><span class="p">)</span>
            <span class="n">theme_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
                <span class="n">theme_path</span><span class="p">,</span>
                <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                <span class="n">colors_256</span><span class="o">=</span><span class="n">colors_256</span><span class="p">,</span>
                <span class="n">url_prefix</span><span class="o">=</span><span class="n">go_url</span>
            <span class="p">)</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;theme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">theme_css</span>
        <span class="k">if</span> <span class="n">colors</span><span class="p">:</span>
            <span class="n">color_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colors_path</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.css&quot;</span> <span class="o">%</span> <span class="n">colors</span><span class="p">)</span>
            <span class="n">colors_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
                <span class="n">color_path</span><span class="p">,</span>
                <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                <span class="n">url_prefix</span><span class="o">=</span><span class="n">go_url</span>
            <span class="p">)</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;colors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors_css</span>
        <span class="k">if</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="c"># Build a dict of plugins</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;plugins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">plugins_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)):</span>
                    <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;plugins&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="c"># Add each plugin&#39;s CSS template(s) to its respective dict</span>
            <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;plugins&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">plugin_templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">plugins_dir</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugin_templates_path</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugin_templates_path</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.css&#39;</span><span class="p">):</span>
                            <span class="n">plugin_css_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">plugin_templates_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                            <span class="n">plugin_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
                                <span class="n">plugin_css_path</span><span class="p">,</span>
                                <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
                                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                                <span class="n">url_prefix</span><span class="o">=</span><span class="n">go_url</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="nb">bytes</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span> <span class="c"># Python 3</span>
                                <span class="n">plugin_css</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">plugin_css</span><span class="p">,</span> <span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
                            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;plugins&#39;</span><span class="p">][</span><span class="n">plugin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">plugin_css</span>
        <span class="k">if</span> <span class="n">_print</span><span class="p">:</span>
            <span class="n">print_css_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">printing_path</span><span class="p">,</span> <span class="s">&quot;default.css&quot;</span><span class="p">)</span>
            <span class="n">print_css</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_string</span><span class="p">(</span>
                <span class="n">print_css_path</span><span class="p">,</span>
                <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                <span class="n">colors_256</span><span class="o">=</span><span class="n">colors_256</span><span class="p">,</span>
                <span class="n">url_prefix</span><span class="o">=</span><span class="n">go_url</span>
            <span class="p">)</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;print&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">print_css</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">({</span><span class="s">&#39;load_style&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}))</span>
</div>
    <span class="nd">@require</span><span class="p">(</span><span class="n">authenticated</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">get_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to find the specified *filename* file in Gate One&#39;s static</span>
<span class="sd">        directories (GATEONE_DIR/static/ and each plugin&#39;s respective &#39;static&#39;</span>
<span class="sd">        dir).</span>

<span class="sd">        In the event that a plugin&#39;s JavaScript file has the same name as a file</span>
<span class="sd">        in GATEONE_DIR/static/ the plugin&#39;s copy of the file will take</span>
<span class="sd">        precedence.  This is to allow plugins to override defaults.</span>

<span class="sd">        .. note:: This will alow authenticated clients to download whatever file they want that ends in .js inside of /static/ directories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;get_js(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="n">js_files</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Key:value == &#39;somefile.js&#39;: &#39;/full/path/to/somefile.js&#39;</span>
        <span class="n">static_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">static_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
                <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">static_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">js_files</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">f</span><span class="p">:</span> <span class="n">js_file_path</span><span class="p">})</span>
        <span class="c"># Build a list of plugins</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plugins_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)):</span>
                <span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c"># Add each found JS file to the respective dict</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="n">plugin_static_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
                        <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                        <span class="n">js_files</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">f</span><span class="p">:</span> <span class="n">js_file_path</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">js_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">js_files</span><span class="p">[</span><span class="n">filename</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;load_js&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="c"># TODO: Persistent minified file cache between restarts of gateone.py</span>
<div class="viewcode-block" id="ApplicationWebSocket.send_js_or_css"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_js_or_css">[docs]</a>    <span class="k">def</span> <span class="nf">send_js_or_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_or_fileobj</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If *kind* is &#39;js&#39;, reads the given JavaScript file at *path_or_fileobj*</span>
<span class="sd">        and sends it to the client using the &#39;load_js&#39; WebSocket action.</span>
<span class="sd">        If *kind* is &#39;css&#39;, reads the given CSS file at *path_or_fileobj*</span>
<span class="sd">        and sends it to the client using the &#39;load_style&#39; WebSocket action.</span>

<span class="sd">        .. note:: Files will be cached after being minified until a file is modified or Gate One is restarted.</span>

<span class="sd">        If the `slimit` module is installed JavaScript files will be minified</span>
<span class="sd">        before being sent to the client.</span>
<span class="sd">        If the `cssmin` module is installed CSS files will be minified before</span>
<span class="sd">        being sent to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path_or_fileobj</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_or_fileobj</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c"># Just in case</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path_or_fileobj</span><span class="o">.</span><span class="n">name</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;send_js_or_css(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;send_js_or_css(): File not found: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="s">&#39;Success&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="c"># Check if the file has changed since last time and use the cached</span>
        <span class="c"># version if it makes sense to do so</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">FILE_CACHE</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mtime</span> <span class="o">==</span> <span class="n">FILE_CACHE</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="s">&#39;mtime&#39;</span><span class="p">]:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">FILE_CACHE</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="s">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_or_fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minify</span><span class="p">(</span><span class="n">path_or_fileobj</span><span class="p">,</span> <span class="n">kind</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">tempfile</span>
            <span class="c"># Keep track of our files so we don&#39;t have to re-minify them</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;go_minified&#39;</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">])</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">FILE_CACHE</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;file&#39;</span><span class="p">:</span> <span class="n">temp</span><span class="p">,</span>
                <span class="s">&#39;mtime&#39;</span><span class="p">:</span> <span class="n">mtime</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;js&#39;</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;load_js&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;css&#39;</span><span class="p">:</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s">&#39;css&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># So loadStyleAction() knows what to do</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;load_style&#39;</span><span class="p">:</span> <span class="n">out_dict</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.send_js"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_js">[docs]</a>    <span class="k">def</span> <span class="nf">send_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut for `self.send_js_or_css(path, &#39;js&#39;)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_or_css</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;js&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.send_css"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_css">[docs]</a>    <span class="k">def</span> <span class="nf">send_css</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut for `self.send_js_or_css(path, &#39;css&#39;)`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_js_or_css</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;css&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.send_static_files"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_static_files">[docs]</a>    <span class="k">def</span> <span class="nf">send_static_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugins_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends all plugin .js and .css files to the client that exist inside</span>
<span class="sd">        *plugins_dir*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;send_static_files(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">plugins_dir</span><span class="p">)</span>
        <span class="c"># Build a list of plugins</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)):</span>
                <span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="c"># Add each found JS file to the respective dict</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="n">plugin_static_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugins_dir</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">):</span>
                <span class="n">static_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">)</span>
                <span class="n">static_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">static_files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.js&#39;</span><span class="p">):</span>
                        <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">send_js</span><span class="p">(</span><span class="n">js_file_path</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.css&#39;</span><span class="p">):</span>
                        <span class="n">css_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">send_css</span><span class="p">(</span><span class="n">css_file_path</span><span class="p">)</span>

<span class="c"># TODO:  Separate generic Gate One css from the terminal-specific stuff.</span></div>
<div class="viewcode-block" id="ApplicationWebSocket.enumerate_themes"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.enumerate_themes">[docs]</a>    <span class="k">def</span> <span class="nf">enumerate_themes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a JSON-encoded object containing the installed themes and text</span>
<span class="sd">        color schemes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">themes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="s">&#39;themes&#39;</span><span class="p">)</span>
        <span class="n">colors_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="s">&#39;term_colors&#39;</span><span class="p">)</span>
        <span class="n">themes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">themes_path</span><span class="p">)</span>
        <span class="n">themes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.css&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">themes</span><span class="p">]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">colors_path</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.css&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;themes_list&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;themes&#39;</span><span class="p">:</span> <span class="n">themes</span><span class="p">,</span> <span class="s">&#39;colors&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ApplicationWebSocket.send_message"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ApplicationWebSocket.send_message">[docs]</a>    <span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the given *message* to the client using the &#39;notice&#39; WebSocket</span>
<span class="sd">        action at the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message_dict</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="ErrorHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.ErrorHandler">[docs]</a><span class="k">class</span> <span class="nc">ErrorHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates an error response with status_code for all requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_error_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_setting</span><span class="p">(</span><span class="s">&quot;static_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">404</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">403</span><span class="p">]:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;static_url&#39;</span><span class="p">],</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">.html&#39;</span> <span class="o">%</span> <span class="n">status_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="kn">import</span> <span class="nn">httplib</span>
        <span class="k">return</span> <span class="s">&quot;&lt;html&gt;&lt;title&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/title&gt;&quot;</span> \
           <span class="s">&quot;&lt;body class=&#39;bodyErrorPage&#39;&gt;</span><span class="si">%(code)d</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&lt;/body&gt;&lt;/html&gt;&quot;</span> <span class="o">%</span> <span class="p">{</span>
               <span class="s">&quot;code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
               <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="n">httplib</span><span class="o">.</span><span class="n">responses</span><span class="p">[</span><span class="n">status_code</span><span class="p">],</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_code</span><span class="p">)</span>
</div>
<span class="k">class</span> <span class="nc">Application</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup our Tornado application...  Everything in *settings* will wind up</span>
<span class="sd">        in the Tornado settings dict so as to be accessible under self.settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">PLUGIN_WS_CMDS</span>
        <span class="k">global</span> <span class="n">PLUGIN_COMMAND_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_ESC_HANDLERS</span>
        <span class="k">global</span> <span class="n">PLUGIN_AUTH_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_TERM_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_NEW_TERM_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_NEW_MULTIPLEX_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_ENV_HOOKS</span>
        <span class="c"># Base settings for our Tornado app</span>
        <span class="n">static_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;static&quot;</span><span class="p">)</span>
        <span class="n">tornado_settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">cookie_secret</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">],</span>
            <span class="n">static_url</span><span class="o">=</span><span class="n">static_url</span><span class="p">,</span>
            <span class="n">static_url_prefix</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">static/&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">],</span>
            <span class="n">gzip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">login_url</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">auth&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c"># Make sure all the provided settings wind up in self.settings</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tornado_settings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c"># Setup the configured authentication type</span>
        <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">NullAuthHandler</span> <span class="c"># Default</span>
        <span class="k">if</span> <span class="s">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;kerberos&#39;</span> <span class="ow">and</span> <span class="n">KerberosAuthHandler</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">KerberosAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;pam&#39;</span> <span class="ow">and</span> <span class="n">PAMAuthHandler</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">PAMAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;google&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">GoogleAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;ssl&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">SSLAuthHandler</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;api&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">APIAuthHandler</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Using </span><span class="si">%s</span><span class="s"> authentication&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;No authentication method configured. All users will be &quot;</span>
                <span class="s">&quot;ANONYMOUS&quot;</span><span class="p">))</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;docs&#39;</span><span class="p">)</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docs_path</span><span class="p">,</span> <span class="s">&#39;build&#39;</span><span class="p">)</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docs_path</span><span class="p">,</span> <span class="s">&#39;html&#39;</span><span class="p">)</span>
        <span class="n">url_prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url_prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
            <span class="c"># Make sure there&#39;s a trailing slash</span>
            <span class="n">url_prefix</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span>
        <span class="c"># Make the / optional in the regex so it works with the @addslash</span>
        <span class="c"># decorator.  e.g. &quot;/whatever/&quot; would become &quot;/whatever/?&quot;</span>
        <span class="n">index_regex</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">?&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span>
        <span class="c"># Setup our URL handlers</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">index_regex</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">ws&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">ApplicationWebSocket</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;apps&#39;</span><span class="p">:</span><span class="n">APPLICATIONS</span><span class="p">}),</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">auth&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">AuthHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">downloads/(.*)&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">DownloadHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">cssrender&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">PluginCSSTemplateHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">docs/(.*)&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">docs_path</span><span class="p">,</span>
                <span class="s">&quot;default_filename&quot;</span><span class="p">:</span> <span class="s">&quot;index.html&quot;</span>
            <span class="p">})</span>
        <span class="p">]</span>
        <span class="c"># Add plugin /static/ routes</span>
        <span class="k">for</span> <span class="n">plugin_name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">)):</span>
            <span class="n">plugin_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">,</span> <span class="n">plugin_name</span><span class="p">)</span>
            <span class="n">plugin_static_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_path</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plugin_static_path</span><span class="p">):</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="s">r&quot;</span><span class="si">%s</span><span class="s">static/</span><span class="si">%s</span><span class="s">/(.*)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_prefix</span><span class="p">,</span> <span class="n">plugin_name</span><span class="p">),</span>
                    <span class="n">StaticHandler</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">plugin_static_path</span><span class="p">}</span>
                <span class="p">))</span>
        <span class="c"># Override the default static handler to ensure the headers are set</span>
        <span class="c"># to allow cross-origin requests.</span>
        <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="c"># NOTE: This has to come after the plugin stuff above</span>
            <span class="p">(</span><span class="s">r&quot;</span><span class="si">%s</span><span class="s">static/(.*)&quot;</span> <span class="o">%</span> <span class="n">url_prefix</span><span class="p">,</span> <span class="n">StaticHandler</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">static_url</span><span class="p">}</span>
        <span class="p">))</span>
        <span class="c"># Hook up the hooks</span>
        <span class="k">for</span> <span class="n">plugin_name</span><span class="p">,</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;Web&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Web handlers</span>
                <span class="n">fixed_hooks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">]:</span>
                        <span class="c"># h == (regex, Handler)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span> <span class="c"># Fix it</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">url_prefix</span> <span class="o">+</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">),</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">url_prefix</span><span class="p">):</span> <span class="c"># Fix it</span>
                        <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">url_prefix</span> <span class="o">+</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">),</span>
                            <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fixed_hooks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">])</span>
                <span class="n">handlers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fixed_hooks</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;WebSocket&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s WebSocket commands</span>
                <span class="n">PLUGIN_WS_CMDS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;WebSocket&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Escape&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Escape handler</span>
                <span class="n">PLUGIN_ESC_HANDLERS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plugin_name</span><span class="p">:</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Escape&#39;</span><span class="p">]})</span>
            <span class="k">if</span> <span class="s">&#39;Auth&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s post-authentication functions</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">PLUGIN_AUTH_HOOKS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PLUGIN_AUTH_HOOKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Command&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s &#39;Command&#39; hooks (called by new_multiplex)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Command&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">PLUGIN_COMMAND_HOOKS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Command&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PLUGIN_COMMAND_HOOKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Command&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Multiplex&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Multiplex hooks (called by new_multiplex)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Multiplex&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">PLUGIN_NEW_MULTIPLEX_HOOKS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Multiplex&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PLUGIN_NEW_MULTIPLEX_HOOKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Multiplex&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Terminal&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Terminal hooks (called by new_terminal)</span>
                <span class="n">PLUGIN_TERM_HOOKS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Terminal&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;TermInstance&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s TermInstance hooks (called by new_terminal)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;TermInstance&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">PLUGIN_NEW_TERM_HOOKS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;TermInstance&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PLUGIN_NEW_TERM_HOOKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;TermInstance&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Environment&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="n">PLUGIN_ENV_HOOKS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Environment&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Init&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Call the plugin&#39;s initialization functions</span>
                <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Init&#39;</span><span class="p">](</span><span class="n">tornado_settings</span><span class="p">)</span>
        <span class="c"># This removes duplicate handlers for the same regex, allowing plugins</span>
        <span class="c"># to override defaults:</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="n">merge_handlers</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>
        <span class="c"># Include JS-only and CSS-only plugins (for logging purposes)</span>
        <span class="n">js_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;js&#39;</span><span class="p">]]</span>
        <span class="n">css_plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">css_plugins</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span> <span class="c"># CSS Template</span>
                <span class="n">css_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;plugin=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Static CSS file</span>
                <span class="n">css_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;py&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">js_plugins</span> <span class="o">+</span> <span class="n">css_plugins</span><span class="p">))</span>
        <span class="n">plugin_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c"># So there&#39;s consistent ordering</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Loaded plugins: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)))</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="p">,</span> <span class="o">**</span><span class="n">tornado_settings</span><span class="p">)</span>

<div class="viewcode-block" id="define_options"><a class="viewcode-back" href="../Developer/gateone.html#gateone.define_options">[docs]</a><span class="k">def</span> <span class="nf">define_options</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls `tornado.options.define` for all of Gate One&#39;s command-line options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># NOTE: To test this function interactively you must import tornado.options</span>
    <span class="c"># and call tornado.options.parse_config_file(*some_config_path*).  After you</span>
    <span class="c"># do that the options will wind up in tornado.options.options</span>
    <span class="k">global</span> <span class="n">user_locale</span>
    <span class="c"># Default to using the shell&#39;s LANG variable as the locale</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">default_locale</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LANG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># $LANG isn&#39;t set</span>
        <span class="n">default_locale</span> <span class="o">=</span> <span class="s">&quot;en_US&quot;</span>
    <span class="n">user_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">default_locale</span><span class="p">)</span>
    <span class="c"># NOTE: The locale setting above is only for the --help messages.</span>
    <span class="c"># Simplify the auth option help message</span>
    <span class="n">auths</span> <span class="o">=</span> <span class="s">&quot;none, api, google, ssl&quot;</span>
    <span class="k">if</span> <span class="n">KerberosAuthHandler</span><span class="p">:</span>
        <span class="n">auths</span> <span class="o">+=</span> <span class="s">&quot;, kerberos&quot;</span>
    <span class="k">if</span> <span class="n">PAMAuthHandler</span><span class="p">:</span>
        <span class="n">auths</span> <span class="o">+=</span> <span class="s">&quot;, pam&quot;</span>
    <span class="c"># Simplify the syslog_facility option help message</span>
    <span class="n">facilities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FACILITIES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">facilities</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="c"># Figure out the default origins</span>
    <span class="n">default_origins</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="c"># Used both http and https above to demonstrate that both are acceptable</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">additional_origins</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname_ex</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">:</span>
        <span class="c"># Couldn&#39;t get any IPs from the hostname</span>
        <span class="n">additional_origins</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">additional_origins</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">default_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">host</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># It&#39;s a list</span>
            <span class="k">for</span> <span class="n">_host</span> <span class="ow">in</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">default_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">_host</span><span class="p">)</span>
    <span class="n">default_origins</span> <span class="o">=</span> <span class="s">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">default_origins</span><span class="p">)</span>
    <span class="n">config_default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;server.conf&quot;</span><span class="p">)</span>
    <span class="c"># NOTE: --settings_dir deprecates --config</span>
    <span class="n">settings_default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;settings&quot;</span><span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">config_default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;DEPRECATED.  Use --settings_dir.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;settings_dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">settings_default</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Path to the settings directory.  Default: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">settings_default</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;debug&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Enable debugging features such as auto-restarting when files &quot;</span>
               <span class="s">&quot;are modified.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;cookie_secret&quot;</span><span class="p">,</span> <span class="c"># 45 chars is, &quot;Good enough for me&quot; (cookie joke =)</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Use the given 45-character string for cookie encryption.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;command&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;DEPRECATED: Use the &#39;commands&#39; option in the terminal settings.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;address&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Run on the given address.  Default is all addresses (IPv6 &quot;</span>
               <span class="s">&quot;included).  Multiple address can be specified using a semicolon&quot;</span>
               <span class="s">&quot; as a separator (e.g. &#39;127.0.0.1;::1;10.1.1.100&#39;).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span><span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">443</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Run on the given port.&quot;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;enable_unix_socket&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Enable Unix socket support.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;unix_socket_path&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;/tmp/gateone.sock&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the Unix socket (if --enable_unix_socket=True).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span><span class="p">)</span>
    <span class="c"># Please only use this if Gate One is running behind something with SSL:</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;disable_ssl&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;If enabled, Gate One will run without SSL (generally not a &quot;</span>
               <span class="s">&quot;good idea).&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;certificate&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;certificate.pem&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the SSL certificate.  Will be auto-generated if none is&quot;</span>
               <span class="s">&quot; provided.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;keyfile&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;keyfile.pem&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the SSL keyfile.  Will be auto-generated if none is&quot;</span>
               <span class="s">&quot; provided.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;ca_certs&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to a file containing any number of concatenated CA &quot;</span>
               <span class="s">&quot;certificates in PEM format.  They will be used to authenticate &quot;</span>
               <span class="s">&quot;clients if the &#39;ssl_auth&#39; option is set to &#39;optional&#39; or &quot;</span>
               <span class="s">&quot;&#39;required&#39;.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;ssl_auth&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Enable the use of client SSL (X.509) certificates as a &quot;</span>
               <span class="s">&quot;secondary authentication factor (the configured &#39;auth&#39; type &quot;</span>
               <span class="s">&quot;will come after SSL auth).  May be one of &#39;none&#39;, &#39;optional&#39;, &quot;</span>
               <span class="s">&quot;or &#39;required&#39;.  NOTE: Only works if the &#39;ca_certs&#39; option is &quot;</span>
               <span class="s">&quot;configured.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;user_dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;users&quot;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the location where user files will be stored.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;session_dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;/tmp/gateone&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Path to the location where session information will be stored.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;syslog_facility&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;daemon&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Syslog facility to use when logging to syslog (if &quot;</span>
               <span class="s">&quot;syslog_session_logging is enabled).  Must be one of: </span><span class="si">%s</span><span class="s">.&quot;</span>
               <span class="s">&quot;  Default: daemon&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">facilities</span><span class="p">)),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;syslog_host&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Remote host to send syslog messages to if syslog_logging is &quot;</span>
               <span class="s">&quot;enabled.  Default: None (log to the local syslog daemon &quot;</span>
               <span class="s">&quot;directly).  NOTE:  This setting is required on platforms that &quot;</span>
               <span class="s">&quot;don&#39;t include Python&#39;s syslog module.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;session_timeout&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;5d&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Amount of time that a session is allowed to idle before it is &quot;</span>
        <span class="s">&quot;killed.  Accepts &lt;num&gt;X where X could be one of s, m, h, or d for &quot;</span>
        <span class="s">&quot;seconds, minutes, hours, and days.  Default is &#39;5d&#39; (5 days).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;new_api_key&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Generate a new API key that an external application can use to &quot;</span>
               <span class="s">&quot;embed Gate One.&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;auth&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Authentication method to use.  Valid options are: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">auths</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="c"># This is to prevent replay attacks.  Gate One only keeps a &quot;working memory&quot;</span>
    <span class="c"># of API auth objects for this amount of time.  So if the Gate One server is</span>
    <span class="c"># restarted we don&#39;t have to write them to disk as anything older than this</span>
    <span class="c"># setting will be invalid (no need to check if it has already been used).</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;api_timestamp_window&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;30s&quot;</span><span class="p">,</span> <span class="c"># 30 seconds</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;How long before an API authentication object becomes invalid.  &quot;</span>
            <span class="s">&quot;Default is &#39;30s&#39; (30 seconds).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;sso_realm&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Kerberos REALM (aka DOMAIN) to use when authenticating clients.&quot;</span>
               <span class="s">&quot; Only relevant if Kerberos authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;sso_service&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&#39;HTTP&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Kerberos service (aka application) to use. Defaults to HTTP. &quot;</span>
               <span class="s">&quot;Only relevant if Kerberos authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;pam_realm&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Basic auth REALM to display when authenticating clients.  &quot;</span>
        <span class="s">&quot;Default: hostname.  &quot;</span>
        <span class="s">&quot;Only relevant if PAM authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="c"># NOTE: This is only used to show the user a REALM at the basic auth</span>
        <span class="c">#       prompt and as the name in the GATEONE_DIR+&#39;/users&#39; directory</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;pam_service&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&#39;login&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;PAM service to use.  Defaults to &#39;login&#39;. &quot;</span>
               <span class="s">&quot;Only relevant if PAM authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;embedded&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Doesn&#39;t do anything (yet).&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;locale&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default_locale</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;The locale (e.g. pt_PT) Gate One should use for translations.&quot;</span>
             <span class="s">&quot;  If not provided, will default to $LANG (which is &#39;</span><span class="si">%s</span><span class="s">&#39; in your &quot;</span>
             <span class="s">&quot;current shell), or en_US if not set.&quot;</span>
             <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LANG&#39;</span><span class="p">,</span> <span class="s">&#39;not set&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;js_init&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A JavaScript object (string) that will be used when running &quot;</span>
               <span class="s">&quot;GateOne.init() inside index.html.  &quot;</span>
               <span class="s">&quot;Example: --js_init=</span><span class="se">\&quot;</span><span class="s">{scheme: &#39;white&#39;}</span><span class="se">\&quot;</span><span class="s"> would result in &quot;</span>
               <span class="s">&quot;GateOne.init({scheme: &#39;white&#39;})&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;https_redirect&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;If enabled, a separate listener will be started on port 80 that&quot;</span>
               <span class="s">&quot; redirects users to the configured port using HTTPS.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;url_prefix&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;An optional prefix to place before all Gate One URLs. e.g. &quot;</span>
               <span class="s">&quot;&#39;/gateone/&#39;.  Use this if Gate One will be running behind a &quot;</span>
               <span class="s">&quot;reverse proxy where you want it to be located at some sub-&quot;</span>
               <span class="s">&quot;URL path.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;origins&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default_origins</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A semicolon-separated list of origins you wish to allow access &quot;</span>
               <span class="s">&quot;to your Gate One server over the WebSocket.  This value must &quot;</span>
               <span class="s">&quot;contain the hostnames and FQDNs (e.g. foo;foo.bar;) users will&quot;</span>
               <span class="s">&quot; use to connect to your Gate One server as well as the &quot;</span>
               <span class="s">&quot;hostnames/FQDNs of any sites that will be embedding Gate One. &quot;</span>
               <span class="s">&quot;Here&#39;s the default on your system: &#39;</span><span class="si">%s</span><span class="s">&#39;. &quot;</span>
               <span class="s">&quot;Alternatively, &#39;*&#39; may be  specified to allow access from &quot;</span>
               <span class="s">&quot;anywhere.&quot;</span> <span class="o">%</span> <span class="n">default_origins</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;pid_file&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;/tmp/gateone.pid&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Define the path to the pid file.  Default: /tmp/gateone.pid&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;uid&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()),</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Drop privileges and run Gate One as this user/uid.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;gid&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">()),</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Drop privileges and run Gate One as this group/gid.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;api_keys&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;The &#39;key:secret,...&#39; API key pairs you wish to use (only &quot;</span>
               <span class="s">&quot;applies if using API authentication)&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">basestring</span>
    <span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_</span>
    <span class="k">global</span> <span class="n">APPLICATIONS</span>
    <span class="n">define_options</span><span class="p">()</span>
    <span class="c"># Before we do anythong else, load plugins and assign their hooks.  This</span>
    <span class="c"># allows plugins to add their own define() statements/options.</span>
    <span class="n">imported</span> <span class="o">=</span> <span class="n">load_modules</span><span class="p">(</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;py&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">imported</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plugin</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span> <span class="n">plugin</span><span class="o">.</span><span class="n">hooks</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># No hooks--probably just a supporting .py file.</span>
    <span class="c"># Before we do anything else we need the get the settings_dir argument (if</span>
    <span class="c"># given) so we can make sure we&#39;re handling things accordingly.</span>
    <span class="n">settings_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;--settings_dir&#39;</span><span class="p">):</span>
            <span class="n">settings_dir</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">):</span>
        <span class="c"># Try to create it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
               <span class="s">&quot;Could not find/create settings directory at </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">settings_dir</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">all_settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">)</span>
    <span class="n">APPLICATIONS</span> <span class="o">=</span> <span class="n">get_applications</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;applications&#39;</span><span class="p">),</span> <span class="n">settings_dir</span><span class="p">)</span>
    <span class="n">app_modules</span> <span class="o">=</span> <span class="n">load_modules</span><span class="p">(</span><span class="n">APPLICATIONS</span><span class="p">)</span>
    <span class="c"># Having parse_command_line() after loading applications in case an</span>
    <span class="c"># application has additional calls to define().</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">()</span>
    <span class="n">APPLICATIONS</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Replace it with a list of actual class instances</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">app_modules</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">SESSIONS</span> <span class="o">=</span> <span class="n">SESSIONS</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">APPLICATIONS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">apps</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;init&#39;</span><span class="p">):</span>
                <span class="n">module</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">all_settings</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># No apps--probably just a supporting .py file.</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Imported applications: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">APPLICATIONS</span><span class="p">))</span>
    <span class="c"># Figure out which options are being overridden on the command line</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">authentication_options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c"># These are here only for logical separation in the .conf files</span>
        <span class="s">&#39;api_timestamp_window&#39;</span><span class="p">,</span> <span class="s">&#39;auth&#39;</span><span class="p">,</span> <span class="s">&#39;pam_realm&#39;</span><span class="p">,</span> <span class="s">&#39;pam_service&#39;</span><span class="p">,</span>
        <span class="s">&#39;sso_realm&#39;</span><span class="p">,</span> <span class="s">&#39;sso_service&#39;</span>
    <span class="p">]</span>
    <span class="n">terminal_options</span> <span class="o">=</span> <span class="p">[</span> <span class="c"># These are now terminal-app-specific setttings</span>
        <span class="s">&#39;command&#39;</span><span class="p">,</span> <span class="s">&#39;dtach&#39;</span><span class="p">,</span> <span class="s">&#39;session_logging&#39;</span><span class="p">,</span> <span class="s">&#39;session_logs_max_age&#39;</span><span class="p">,</span>
        <span class="s">&#39;syslog_session_logging&#39;</span>
    <span class="p">]</span>
    <span class="n">non_options</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c"># These are things that don&#39;t really belong in settings</span>
        <span class="s">&#39;new_api_key&#39;</span><span class="p">,</span> <span class="s">&#39;help&#39;</span><span class="p">,</span> <span class="s">&#39;kill&#39;</span><span class="p">,</span> <span class="s">&#39;config&#39;</span>
    <span class="p">]</span>
    <span class="c"># Convert the old server.conf to the new settings file format and save it</span>
    <span class="c"># as a number of distinct .conf files to keep things better organized.</span>
    <span class="c"># NOTE: This logic will go away some day as it only applies when moving from</span>
    <span class="c">#       Gate One 1.1 (or older) to newer versions.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">settings_template</span><span class="p">,</span> <span class="n">RUDict</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">()</span>
        <span class="n">auth_settings</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">()</span>
        <span class="n">terminal_settings</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">()</span>
        <span class="n">api_keys</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">({</span><span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gateone&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;api_keys&quot;</span><span class="p">:</span> <span class="p">{}}}})</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c"># Regular server-wide settings will go in 10server.conf by default.</span>
            <span class="c"># These settings can actually be spread out into any number of .conf</span>
            <span class="c"># files in the settings directory using whatever naming convention</span>
            <span class="c"># you want.</span>
            <span class="n">settings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">)</span>
            <span class="n">server_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
            <span class="n">auth_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;20authentication.conf&#39;</span><span class="p">)</span>
            <span class="n">terminal_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;50terminal.conf&#39;</span><span class="p">)</span>
            <span class="n">api_keys_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;20api_keys.conf&#39;</span><span class="p">)</span>
            <span class="c"># Using 20authentication.conf for authentication settings</span>
            <span class="c"># NOTE: Using a separate file for authentication stuff for no other</span>
            <span class="c">#       reason than it seems like a good idea.  Don&#39;t want one</span>
            <span class="c">#       gigantic config file for everything (by default, anyway).</span>
            <span class="n">authentication_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;20authentication.conf&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Old server.conf file found.  Converting to the new format as &quot;</span>
                <span class="s">&quot;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, and </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">server_conf_path</span><span class="p">,</span> <span class="n">auth_conf_path</span><span class="p">,</span> <span class="n">terminal_conf_path</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">terminal_options</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;command&#39;</span><span class="p">:</span>
                        <span class="c"># Fix the path to ssh_connect.py if present</span>
                        <span class="k">if</span> <span class="s">&#39;ssh_connect.py&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                <span class="s">&#39;/plugins/&#39;</span><span class="p">,</span> <span class="s">&#39;/applications/terminal/plugins/&#39;</span><span class="p">)</span>
                    <span class="n">terminal_settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">authentication_options</span><span class="p">:</span>
                    <span class="n">auth_settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;origins&#39;</span><span class="p">:</span>
                    <span class="c"># Convert to the new format (a list with no http://)</span>
                    <span class="n">origins</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
                    <span class="n">converted_origins</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">origins</span><span class="p">:</span>
                        <span class="c"># The new format doesn&#39;t bother with http:// or https://</span>
                        <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;://&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">origin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">converted_origins</span><span class="p">:</span>
                            <span class="n">converted_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">converted_origins</span><span class="p">})</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;api_keys&#39;</span><span class="p">:</span>
                    <span class="c"># Move these to the new location/format (20api_keys.conf)</span>
                    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                        <span class="n">api_key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">bytes</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                            <span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
                            <span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
                        <span class="n">api_keys</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">][</span><span class="s">&#39;api_keys&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span><span class="n">api_key</span><span class="p">:</span> <span class="n">secret</span><span class="p">})</span>
                    <span class="c"># API keys can be written right away</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conf</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;// This file contains the key and secret pairs &quot;</span>
                            <span class="s">&quot;used by Gate One&#39;s API authentication method.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">api_keys</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
            <span class="n">new_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">server_conf_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">server_conf_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;// This is Gate One&#39;s main settings file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_settings</span><span class="p">)</span>
            <span class="n">new_auth_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span>
                <span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">auth_settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">auth_conf_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">auth_conf_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                       <span class="s">&quot;// This is Gate One&#39;s authentication settings file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_auth_settings</span><span class="p">)</span>
            <span class="c"># Terminal uses a slightly different template; it converts &#39;command&#39;</span>
            <span class="c"># to the new &#39;commands&#39; format.</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;50terminal.conf&#39;</span><span class="p">)</span>
            <span class="n">new_term_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span>
                <span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">terminal_settings</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">terminal_conf_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">terminal_conf_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;// This is Gate One&#39;s Terminal application settings &quot;</span>
                        <span class="s">&quot;file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_term_settings</span><span class="p">)</span>
    <span class="n">all_settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">settings_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;gateone&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">]:</span>
        <span class="c"># User has yet to create a 10server.conf (or equivalent)</span>
        <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Will be filled out below</span>
    <span class="c"># Double check that we have all the necessary settings</span>
    <span class="n">go_settings</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span>
    <span class="c"># If you want any missing config file entries re-generated just delete the</span>
    <span class="c"># cookie_secret line...</span>
    <span class="k">if</span> <span class="s">&#39;cookie_secret&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">go_settings</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">]:</span>
        <span class="c"># Generate a default 10server.conf with a random cookie secret</span>
        <span class="c"># NOTE: This will also generate a new 10server.conf if it is missing.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Gate One settings are incomplete.  A new settings/10server.conf&quot;</span>
            <span class="s">&quot; will be generated.&quot;</span><span class="p">))</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">options_to_settings</span>
        <span class="n">auth_settings</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Auth stuff goes in 20authentication.conf</span>
        <span class="n">all_setttings</span> <span class="o">=</span> <span class="n">options_to_settings</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">config_defaults</span> <span class="o">=</span> <span class="n">all_setttings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span>
        <span class="c"># Don&#39;t need this in the actual settings file:</span>
        <span class="k">del</span> <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;settings_dir&#39;</span><span class="p">]</span>
        <span class="c"># Generate a new cookie_secret</span>
        <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="c"># Separate out the authentication settings</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">authentication_options</span><span class="p">:</span>
                <span class="n">auth_settings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
                <span class="k">del</span> <span class="n">config_defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="c"># Make sure we have a valid log_file_prefix</span>
        <span class="k">if</span> <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">web_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;logs&#39;</span><span class="p">)</span>
            <span class="n">web_log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">web_log_dir</span><span class="p">,</span> <span class="s">&#39;webserver.log&#39;</span><span class="p">)</span>
            <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">web_log_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">web_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">web_log_dir</span><span class="p">):</span>
            <span class="c"># Make sure the directory exists</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">web_log_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]):</span>
            <span class="c"># Make sure the file is present</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">],</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">settings_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">)</span>
        <span class="n">server_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
        <span class="n">auth_conf_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings_path</span><span class="p">,</span> <span class="s">&#39;20authentication.conf&#39;</span><span class="p">)</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">settings_template</span>
        <span class="n">new_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span>
            <span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">config_defaults</span><span class="p">)</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;10server.conf&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">server_conf_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;// This is Gate One&#39;s main settings file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_settings</span><span class="p">)</span>
        <span class="n">new_auth_settings</span> <span class="o">=</span> <span class="n">settings_template</span><span class="p">(</span>
            <span class="n">template_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">auth_settings</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">auth_conf_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;// This is Gate One&#39;s authentication settings file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_auth_settings</span><span class="p">)</span>
        <span class="c"># Make sure these values get updated</span>
        <span class="n">all_settings</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">settings_dir</span><span class="p">)</span>
        <span class="n">go_settings</span> <span class="o">=</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;gateone&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">non_options</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">go_settings</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span>
    <span class="c"># Update Tornado&#39;s options from our settings</span>
    <span class="n">options</span><span class="p">[</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">])</span>
    <span class="n">options</span><span class="p">[</span><span class="s">&#39;logging&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;logging&#39;</span><span class="p">]))</span>
    <span class="n">options</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]))</span>
    <span class="c"># Change the uid/gid strings into integers</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;uid&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pwd</span>
        <span class="c"># Assume it&#39;s a username and grab its uid</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;uid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">pw_uid</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;gid&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">grp</span>
        <span class="c"># Assume it&#39;s a group name and grab its gid</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;gid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">gr_gid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">]):</span> <span class="c"># Make our user_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pwd</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Error: Gate One could not create </span><span class="si">%s</span><span class="s">.  Please ensure that user,&quot;</span>
                <span class="s">&quot; </span><span class="si">%s</span><span class="s"> has permission to create this directory or create it &quot;</span>
                <span class="s">&quot;yourself and make user, </span><span class="si">%s</span><span class="s"> its owner.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]))))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># If we could create it we should be able to adjust its permissions:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_write_permissions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">]):</span>
        <span class="c"># Try correcting this first</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recursive_chown</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;user_dir: </span><span class="si">%s</span><span class="s">, uid: </span><span class="si">%s</span><span class="s">, gid: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]):</span> <span class="c"># Make our session_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Error: Gate One could not create </span><span class="si">%s</span><span class="s">.  Please ensure that user,&quot;</span>
                <span class="s">&quot; </span><span class="si">%s</span><span class="s"> has permission to create this directory or create it &quot;</span>
                <span class="s">&quot;yourself and make user, </span><span class="si">%s</span><span class="s"> its owner.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]))))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="n">o770</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_write_permissions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]):</span>
        <span class="c"># Try correcting it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recursive_chown</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;session_dir: </span><span class="si">%s</span><span class="s">, uid: </span><span class="si">%s</span><span class="s">, gid: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># Re-do the locale in case the user supplied something as --locale</span>
    <span class="n">user_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;locale&#39;</span><span class="p">])</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">user_locale</span><span class="o">.</span><span class="n">translate</span> <span class="c"># Also replaces our wrapper so no more .encode()</span>
    <span class="c"># Create the log dir if not already present (NOTE: Assumes we&#39;re root)</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[1;31mERROR:</span><span class="se">\x1b</span><span class="s">[0m Could not create </span><span class="si">%s</span><span class="s"> for &quot;</span>
                <span class="s">&quot;log_file_prefix: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">]</span>
            <span class="p">)))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;You probably want to change this option, run Gate &quot;</span>
                  <span class="s">&quot;One as root, or create that directory and give the proper &quot;</span>
                  <span class="s">&quot;user ownership of it.&quot;</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_write_permissions</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">):</span>
        <span class="c"># Try to correct it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">recursive_chown</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">ChownError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;log_dir: </span><span class="si">%s</span><span class="s">, uid: </span><span class="si">%s</span><span class="s">, gid: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">new_api_key</span><span class="p">:</span>
        <span class="c"># Generate a new API key for an application to use and save it to</span>
        <span class="c"># settings/20api_keys.conf.</span>
        <span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">RUDict</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="c"># Generate a new secret</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="n">api_keys_conf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;settings&#39;</span><span class="p">,</span> <span class="s">&#39;20api_keys.conf&#39;</span><span class="p">)</span>
        <span class="n">new_keys</span> <span class="o">=</span> <span class="p">{</span><span class="n">api_key</span><span class="p">:</span> <span class="n">secret</span><span class="p">}</span>
        <span class="n">api_keys</span> <span class="o">=</span> <span class="n">RUDict</span><span class="p">({</span><span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gateone&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;api_keys&quot;</span><span class="p">:</span> <span class="p">{}}}})</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">):</span>
            <span class="n">api_keys</span> <span class="o">=</span> <span class="n">get_settings</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">)</span>
        <span class="n">api_keys</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&quot;*&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;gateone&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;api_keys&quot;</span><span class="p">:</span> <span class="n">new_keys</span><span class="p">}}})</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">api_keys_conf</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conf</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;// This file contains the key and secret pairs used by Gate &quot;</span>
                <span class="s">&quot;One&#39;s API authentication method.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">api_keys</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A new API key has been generated: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">api_key</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;This key can now be used to embed Gate One into other &quot;</span>
                <span class="s">&quot;applications.&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c"># Display the version in case someone sends in a log for for support</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Gate One </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">__version__</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Tornado version </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tornado_version</span><span class="p">))</span>
    <span class="c"># Set our global session timeout</span>
    <span class="k">global</span> <span class="n">TIMEOUT</span>
    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_timeout&#39;</span><span class="p">])</span>
    <span class="c"># Turn any API keys provided on the command line into a dict</span>
    <span class="n">api_keys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s">&#39;api_keys&#39;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">api_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">api_keys</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">api_key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">bytes</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
                    <span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
                <span class="n">api_keys</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">api_key</span><span class="p">:</span> <span class="n">secret</span><span class="p">})</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;api_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_keys</span>
    <span class="c"># Fix the url_prefix if the user forgot the trailing slash</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span>
    <span class="c"># Convert the origins into a list if overridden via the command line</span>
    <span class="k">if</span> <span class="s">&#39;origins&#39;</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">origins</span><span class="p">:</span>
            <span class="n">origins</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">origins</span><span class="o">.</span><span class="n">value</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
            <span class="n">real_origins</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">origins</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;://&#39;</span> <span class="ow">in</span> <span class="n">origin</span><span class="p">:</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;://&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">origin</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">real_origins</span><span class="p">:</span>
                    <span class="n">real_origins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
            <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;origins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_origins</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Connections to this server will be allowed from the following&quot;</span>
                 <span class="s">&quot; origins: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;origins&#39;</span><span class="p">]))</span>
    <span class="c"># Normalize settings</span>
    <span class="n">api_timestamp_window</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;api_timestamp_window&#39;</span><span class="p">])</span>
    <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">none_fix</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">])</span>
    <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;settings_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_dir</span>
    <span class="c"># Check to make sure we have a certificate and keyfile and generate fresh</span>
    <span class="c"># ones if not.</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;keyfile&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;keyfile.pem&quot;</span><span class="p">:</span>
        <span class="c"># If set to the default we&#39;ll assume they want to use the one in the</span>
        <span class="c"># gateone_dir</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;keyfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/keyfile.pem&quot;</span> <span class="o">%</span> <span class="n">GATEONE_DIR</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;certificate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;certificate.pem&quot;</span><span class="p">:</span>
        <span class="c"># Just like the keyfile, assume they want to use the one in the</span>
        <span class="c"># gateone_dir</span>
        <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;certificate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/certificate.pem&quot;</span> <span class="o">%</span> <span class="n">GATEONE_DIR</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;keyfile&#39;</span><span class="p">]):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No SSL private key found.  One will be generated.&quot;</span><span class="p">))</span>
        <span class="n">gen_self_signed_ssl</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">GATEONE_DIR</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;certificate&#39;</span><span class="p">]):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No SSL certificate found.  One will be generated.&quot;</span><span class="p">))</span>
        <span class="n">gen_self_signed_ssl</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">GATEONE_DIR</span><span class="p">)</span>
    <span class="c"># When logging==&quot;debug&quot; it will display all user&#39;s keystrokes so make sure</span>
    <span class="c"># we warn about this.</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;logging&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;debug&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Logging is set to DEBUG.  Be aware that this will record the &quot;</span>
            <span class="s">&quot;keystrokes of all users.  Don&#39;t be evil!&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;ssl_auth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;required&#39;</span><span class="p">:</span>
        <span class="c"># Convert to an integer using the ssl module</span>
        <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
    <span class="k">elif</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;ssl_auth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;optional&#39;</span><span class="p">:</span>
        <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_OPTIONAL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
    <span class="c"># Instantiate our Tornado web server</span>
    <span class="n">ssl_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;certfile&quot;</span><span class="p">:</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;certificate&#39;</span><span class="p">],</span>
        <span class="s">&quot;keyfile&quot;</span><span class="p">:</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;keyfile&#39;</span><span class="p">],</span>
        <span class="s">&quot;ca_certs&quot;</span><span class="p">:</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;ca_certs&#39;</span><span class="p">],</span>
        <span class="s">&quot;cert_reqs&quot;</span><span class="p">:</span> <span class="n">cert_reqs</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;disable_ssl&#39;</span><span class="p">]:</span>
        <span class="n">proto</span> <span class="o">=</span> <span class="s">&quot;http://&quot;</span>
        <span class="n">ssl_options</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proto</span> <span class="o">=</span> <span class="s">&quot;https://&quot;</span>
    <span class="n">https_server</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span>
        <span class="n">Application</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">go_settings</span><span class="p">),</span> <span class="n">ssl_options</span><span class="o">=</span><span class="n">ssl_options</span><span class="p">)</span>
    <span class="n">https_redirect</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span>
        <span class="p">[(</span><span class="s">r&quot;.*&quot;</span><span class="p">,</span> <span class="n">HTTPSRedirectHandler</span><span class="p">),],</span>
        <span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span>
        <span class="n">url_prefix</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;url_prefix&#39;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">ErrorHandler</span> <span class="o">=</span> <span class="n">ErrorHandler</span>
    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;pam&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;PAM authentication is configured but you are not running Gate&quot;</span>
                <span class="s">&quot; One as root.  If the pam_service you&#39;ve selected (</span><span class="si">%s</span><span class="s">) is &quot;</span>
                <span class="s">&quot;configured to use pam_unix.so for &#39;auth&#39; (i.e. authenticating &quot;</span>
                <span class="s">&quot;against /etc/passwd and /etc/shadow) Gate One will not be able&quot;</span>
                <span class="s">&quot; to authenticate all users.  It will only be able to &quot;</span>
                <span class="s">&quot;authenticate the user that owns the gateone.py process.&quot;</span> <span class="o">%</span>
                <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pam_service&#39;</span><span class="p">]))</span>
    <span class="k">try</span><span class="p">:</span> <span class="c"># Start your engines!</span>
        <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;enable_unix_socket&#39;</span><span class="p">]:</span>
            <span class="n">https_server</span><span class="o">.</span><span class="n">add_socket</span><span class="p">(</span>
                <span class="n">tornado</span><span class="o">.</span><span class="n">netutil</span><span class="o">.</span><span class="n">bind_unix_socket</span><span class="p">(</span>
                    <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;unix_socket_path&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Listening on Unix socket &#39;{socketpath}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">socketpath</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;unix_socket_path&#39;</span><span class="p">])))</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">none_fix</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">address</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">addr</span><span class="p">:</span> <span class="c"># Listen on all given addresses</span>
                    <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;https_redirect&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;disable_ssl&#39;</span><span class="p">]:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;You have https_redirect *and* disable_ssl enabled.&quot;</span>
                            <span class="s">&quot;  Please pick one or the other.&quot;</span><span class="p">))</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;http://{addr}:80/ will be redirected to...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">addr</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
                        <span class="p">))</span>
                        <span class="n">https_redirect</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;Listening on {proto}{address}:{port}/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">proto</span><span class="o">=</span><span class="n">proto</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">])</span>
                    <span class="p">))</span>
                    <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">address</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="c"># Listen on all addresses (including IPv6)</span>
            <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;https_redirect&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;disable_ssl&#39;</span><span class="p">]:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;You have https_redirect *and* disable_ssl enabled.&quot;</span>
                        <span class="s">&quot;  Please pick one or the other.&quot;</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;http://*:80/ will be redirected to...&quot;</span><span class="p">))</span>
                <span class="n">https_redirect</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Listening on {proto}*:{port}/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">proto</span><span class="o">=</span><span class="n">proto</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">])))</span>
            <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="c"># NOTE:  To have Gate One *not* listen on a TCP/IP address you may set</span>
        <span class="c">#        address=None</span>
        <span class="n">write_pid</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">read_pid</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Process running with pid &quot;</span> <span class="o">+</span> <span class="n">pid</span><span class="p">))</span>
        <span class="c"># Check to see what group owns /dev/pts and use that for supl_groups</span>
        <span class="c"># First we have to make sure there&#39;s at least one pty present</span>
        <span class="n">tempfd1</span><span class="p">,</span> <span class="n">tempfd2</span> <span class="o">=</span> <span class="n">pty</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>
        <span class="c"># Now check the owning group (doesn&#39;t matter which one so we use 0)</span>
        <span class="n">tty_gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="s">&#39;/dev/ptmx&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">st_gid</span>
        <span class="c"># Close our temmporary pty/fds so we&#39;re not wasting them</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">tempfd1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">tempfd2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">():</span>
            <span class="n">drop_privileges</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="p">[</span><span class="n">tty_gid</span><span class="p">])</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span> <span class="c"># ctrl-c</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Caught KeyboardInterrupt.  Killing sessions...&quot;</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">remove_pid</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;pid file removed.&quot;</span><span class="p">))</span>
        <span class="c"># TODO: Move this dtach stuff to app_terminal.py</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_settings</span><span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">][</span><span class="s">&#39;terminal&#39;</span><span class="p">][</span><span class="s">&#39;dtach&#39;</span><span class="p">]:</span>
            <span class="c"># If we&#39;re not using dtach play it safe by cleaning up any leftover</span>
            <span class="c"># processes.  When passwords are used with the ssh_conenct.py script</span>
            <span class="c"># it runs os.setsid() on the child process which means it won&#39;t die</span>
            <span class="c"># when Gate One is closed.  This is primarily to handle that</span>
            <span class="c"># specific situation.</span>
            <span class="n">killall</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;pid_file&#39;</span><span class="p">])</span>
            <span class="c"># Cleanup the session_dir (it&#39;s supposed to only contain temp stuff)</span>
            <span class="kn">import</span> <span class="nn">shutil</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">go_settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">],</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/ls_logo_1inch_300dpi.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Liftoff Software Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
<script type="text/javascript">
window.onload = function(e) {
    // Make our collapseindex elements actually collapsible
    $('<span class="collapsindextitle">Index</span> <a class="showhide">[show]</a>').insertBefore('.collapseindex');
    $('.showhide').each(function(index, value){
        var showHide = $(this);
        showHide.click(function() {
            if (this.innerHTML == "[hide]") {
                this.innerHTML = "[show]";
            } else {
                this.innerHTML = "[hide]";
            }
            $(this).next('.collapseindex').toggle(1); // This should always be the next .collapseindex element
        });
    });
    $('.collapseindex').each(function(index, value){
        // Start them out hidden
        $(this).hide();
    });
}
</script>

  </body>
</html>